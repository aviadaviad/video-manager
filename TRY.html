<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מנהל סרטונים - עדכונים אוטומטיים</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            padding: 15px 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 12px;
            opacity: 0.9;
            margin: 2px 0;
        }
        
        .controls {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .search-box, .category-filter {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .search-box:focus, .category-filter:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .search-box {
            flex: 1;
            min-width: 250px;
        }
        
        .category-filter {
            min-width: 150px;
        }
        
        /* סטיילים מיוחדים למולטי-סלקט של תוכניות */
        .program-filter-container {
            position: relative;
            min-width: 150px;
        }
        
        .program-filter-display {
            min-width: 150px;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 20px;
            font-size: 13px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        
        .program-filter-display:hover {
            border-color: #999;
        }
        
        .program-filter-display.active {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .program-filter-arrow {
            transition: transform 0.3s ease;
            font-size: 10px;
            color: #666;
        }
        
        .program-filter-arrow.rotated {
            transform: rotate(180deg);
        }
        
        .program-filter-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            margin-top: 5px;
        }
        
        .program-filter-dropdown.show {
            display: block;
        }
        
        .program-option {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .program-option:last-child {
            border-bottom: none;
        }
        
        .program-option:hover {
            background: #f8f9ff;
        }
        
        .program-option.selected {
            background: linear-gradient(135deg, #e8f3ff, #f0f8ff);
            color: #2c5aa0;
            font-weight: bold;
        }
        
        .program-option input[type="checkbox"] {
            margin-left: 8px;
            cursor: pointer;
        }
        
        /* סטיילים מיוחדים למולטי-סלקט של סטטוס אישור */
        .approval-filter-container {
            position: relative;
            min-width: 150px;
        }
        
        .approval-filter-display {
            min-width: 150px;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 20px;
            font-size: 13px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        
        .approval-filter-display:hover {
            border-color: #999;
        }
        
        .approval-filter-display.active {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .approval-filter-arrow {
            transition: transform 0.3s ease;
            font-size: 10px;
            color: #666;
        }
        
        .approval-filter-arrow.rotated {
            transform: rotate(180deg);
        }
        
        .approval-filter-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            margin-top: 5px;
        }
        
        .approval-filter-dropdown.show {
            display: block;
        }
        
        .approval-option {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .approval-option:last-child {
            border-bottom: none;
        }
        
        .approval-option:hover {
            background: #f8f9ff;
        }
        
        .approval-option.selected {
            background: linear-gradient(135deg, #e8f3ff, #f0f8ff);
            color: #2c5aa0;
            font-weight: bold;
        }
        
        .approval-option input[type="checkbox"] {
            margin-left: 8px;
            cursor: pointer;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: white;
        }
        
        .btn-add {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .btn-add:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(40, 167, 69, 0.4);
        }
        
        .btn-export {
            background: linear-gradient(135deg, #17a2b8, #138496);
        }
        
        .btn-export:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(23, 162, 184, 0.4);
        }
        
        .btn-delete {
            background: linear-gradient(135deg, #dc3545, #c82333);
            padding: 4px 8px;
            font-size: 11px;
        }
        
        .btn-delete:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
        }
        
        .btn-recycle {
            background: linear-gradient(135deg, #fd7e14, #e55d00);
        }
        
        .btn-recycle:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(253, 126, 20, 0.4);
        }
        
        .btn-reset {
            background: linear-gradient(135deg, #6c757d, #545b62);
        }
        
        .btn-reset:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(108, 117, 125, 0.4);
        }
        
        .stats {
            background: #e3f2fd;
            padding: 10px 15px;
            font-weight: bold;
            font-size: 13px;
            color: #1565c0;
            border-bottom: 1px solid #bbdefb;
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 75vh;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            border: 2px solid #667eea;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 6px;
            text-align: right;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        th:last-child {
            border-right: none;
        }
        
        .sortable-header {
            cursor: pointer;
            user-select: none;
        }
        
        .sort-indicator {
            margin-left: 5px;
            font-size: 10px;
            opacity: 0.7;
        }
        
        .sort-indicator.active {
            opacity: 1;
            font-weight: bold;
        }
        
        td {
            padding: 6px;
            border-bottom: 1px solid #e9ecef;
            border-right: 1px solid #e9ecef;
            text-align: right;
            position: relative;
            background: white;
        }
        
        td:last-child {
            border-right: none;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        .editable {
            min-height: 18px;
            padding: 3px;
            border-radius: 3px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        
        .editable:hover {
            background: #f8f9fa;
            border-color: #dee2e6;
        }
        
        .editable:focus {
            outline: 2px solid #667eea;
            background: white;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        tr:hover {
            background: linear-gradient(135deg, #f8f9ff, #fff5f8);
        }
        
        tr:hover td {
            border-color: #d1d9ff;
        }
        
        /* תצוגת קטגוריה משופרת */
        .category-cell {
            position: relative;
        }
        
        .category-display {
            background: linear-gradient(135deg, #e8f5e8, #f0f8ff);
            font-weight: bold;
            color: #2e7d32;
            border-radius: 6px;
            margin: 1px 0;
            padding: 4px 8px;
            display: block;
            min-width: 100px;
            text-align: center;
            font-size: 11px;
            border: 1px solid #c8e6c9;
            box-shadow: 0 1px 3px rgba(46, 125, 50, 0.2);
            cursor: pointer;
            transition: all 0.2s ease;
            overflow: visible;
            white-space: nowrap;
            min-height: 20px;
            line-height: 1.2;
        }
        
        .category-display:hover {
            background: linear-gradient(135deg, #c8e6c9, #e3f2fd);
            box-shadow: 0 2px 6px rgba(46, 125, 50, 0.3);
        }
        
        .category-display.empty {
            background: linear-gradient(135deg, #fff3e0, #ffeaa7);
            color: #bf360c;
            border-color: #ff9800;
        }
        
        .category-select {
            width: 100%;
            padding: 4px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 11px;
            background: white;
            transition: all 0.2s ease;
            font-weight: bold;
            display: none;
        }
        
        .category-cell.editing .category-display {
            display: none;
        }
        
        .category-cell.editing .category-select {
            display: block;
        }
        
        /* תצוגת סטטוס אישור - סטיילים משופרים לצבעי רקע */
        .approval-cell {
            padding: 0 !important;
        }
        
        .approval-cell.approved {
            background-color: rgba(40, 167, 69, 0.15) !important;
        }
        
        .approval-cell.not-approved {
            background-color: rgba(220, 53, 69, 0.15) !important;
        }
        
        .approval-cell.pending {
            background-color: rgba(255, 193, 7, 0.15) !important;
        }
        
        .approval-select {
            width: 100%;
            padding: 4px;
            border: 1px solid transparent;
            border-radius: 6px;
            font-size: 11px;
            background: transparent;
            transition: all 0.2s ease;
            font-weight: bold;
        }
        
        .approval-cell.approved .approval-select {
            color: #155724;
        }
        
        .approval-cell.not-approved .approval-select {
            color: #721c24;
        }
        
        .approval-cell.pending .approval-select {
            color: #856404;
        }
        
        .approval-select:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
            background: white;
        }
        
        /* סטיילים לתצוגת סטטוס אישור במובייל */
        .mobile-approval-field {
            padding: 6px !important;
            border-radius: 6px;
            margin: 4px 0;
        }
        
        .mobile-approval-field.approved {
            background-color: rgba(40, 167, 69, 0.15) !important;
        }
        
        .mobile-approval-field.not-approved {
            background-color: rgba(220, 53, 69, 0.15) !important;
        }
        
        .mobile-approval-field.pending {
            background-color: rgba(255, 193, 7, 0.15) !important;
        }
        
        .mobile-approval-field .mobile-select {
            background: transparent;
            border: 1px solid transparent;
        }
        
        .mobile-approval-field.approved .mobile-select {
            color: #155724;
        }
        
        .mobile-approval-field.not-approved .mobile-select {
            color: #721c24;
        }
        
        .mobile-approval-field.pending .mobile-select {
            color: #856404;
        }
        
        .approval-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            display: inline-block;
            min-width: 70px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid;
        }
        
        .approval-badge.approved {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-color: #1e7e34;
        }
        
        .approval-badge.not-approved {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border-color: #bd2130;
        }
        
        .approval-badge.pending {
            background: linear-gradient(135deg, #ffc107, #ff9800);
            color: #212529;
            border-color: #e0a800;
        }
        
        .approval-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        .video-number {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 3px 6px;
            border-radius: 12px;
            font-weight: bold;
            display: inline-block;
            min-width: 30px;
            text-align: center;
            font-size: 11px;
            border: 1px solid rgba(238, 90, 36, 0.3);
            box-shadow: 0 1px 3px rgba(255, 107, 107, 0.3);
        }
        
        .marked-item {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7) !important;
            border-right: 4px solid #f39c12;
            box-shadow: 0 2px 8px rgba(243, 156, 18, 0.2);
        }
        
        .marked-item td {
            border-color: #f8d7da;
        }
        
        .no-results {
            text-align: center;
            padding: 30px;
            color: #666;
            font-size: 16px;
        }
        
        .link-container {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        
        .link-input {
            flex: 1;
            padding: 2px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 11px;
            transition: border-color 0.2s ease;
        }
        
        .link-input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        
        .btn-open-link {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 3px;
            padding: 3px 6px;
            font-size: 9px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-open-link:hover {
            background: linear-gradient(135deg, #218838, #1e7e34);
            transform: translateY(-1px);
        }
        
        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-size: 13px;
        }
        
        .save-indicator.show {
            opacity: 1;
        }
        
        .file-input {
            display: none;
        }
        
        .btn-import {
            background: linear-gradient(135deg, #6f42c1, #563d7c);
        }
        
        .btn-import:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(111, 66, 193, 0.4);
        }
        
        /* תכונות בחירה מרובה */
        .bulk-actions {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 15px;
            display: none;
        }
        
        .bulk-actions.show {
            display: block;
        }
        
        .bulk-actions-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .btn-bulk {
            padding: 6px 12px;
            border: none;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-bulk-archive {
            background: linear-gradient(135deg, #ff9500, #ff6b00);
            color: white;
        }
        
        .btn-bulk-delete {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }
        
        .btn-bulk-restore {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .row-checkbox {
            width: 14px;
            height: 14px;
            margin: 1px;
            cursor: pointer;
        }
        
        .select-all-checkbox {
            width: 16px;
            height: 16px;
            margin: 1px;
            cursor: pointer;
        }
        
        /* תכונות תאריכים והיסטוריה */
        .edit-history {
            background: #f0f8ff;
            border: 1px solid #b0d4f1;
            border-radius: 6px;
            padding: 8px;
            margin: 8px 0;
            font-size: 10px;
            color: #2c5282;
        }
        
        .history-toggle {
            cursor: pointer;
            color: #667eea;
            text-decoration: underline;
            font-size: 9px;
        }
        
        .timestamp {
            font-size: 9px;
            color: #999;
            font-style: italic;
        }
        
        /* עמודת תאריך יצירה */
        .creation-date-cell {
            font-size: 10px;
            color: #666;
            text-align: center;
            white-space: nowrap;
        }
        
        .creation-date {
            display: block;
            font-size: 10px;
            line-height: 1.2;
        }
        
        .creation-time {
            display: block;
            font-size: 9px;
            color: #999;
        }
        
        /* כפתור ייצוא מתקדם */
        .btn-excel {
            background: linear-gradient(135deg, #207245, #0f5132);
        }
        
        .btn-excel:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(32, 114, 69, 0.4);
        }
        
        /* כפתור ייצוא וורד חדש */
        .btn-word {
            background: linear-gradient(135deg, #2b579a, #1d4084);
        }
        
        .btn-word:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(43, 87, 154, 0.4);
        }
        
        .number-edit {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            border: 2px dashed #ff9800;
            text-align: center;
            font-weight: bold;
            color: #e65100;
            min-height: 22px;
            border-radius: 4px;
            padding: 3px;
            box-shadow: 0 1px 3px rgba(255, 152, 0, 0.2);
        }
        
        .number-edit:hover {
            background: linear-gradient(135deg, #fff8e1, #ffecb3);
            border-color: #f57c00;
            box-shadow: 0 2px 6px rgba(255, 152, 0, 0.3);
        }
        
        .number-edit:focus {
            outline: 2px solid #ff9800;
            background: white;
            border-style: solid;
            box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.2);
        }
        
        .number-edit:empty:before {
            content: "הכנס מספר";
            color: #bbb;
            font-style: italic;
            font-weight: normal;
        }
        
        .actions-cell {
            text-align: center;
            width: 80px;
            border-left: 2px solid #f1f3f4;
            background: rgba(248, 249, 250, 0.5);
        }
        
        .program-select {
            width: 100%;
            padding: 3px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 11px;
            background: white;
            transition: all 0.2s ease;
        }
        
        .program-select:focus {
            outline: 2px solid #667eea;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        .program-select:hover {
            border-color: #999;
        }
        
        .date-input {
            transition: all 0.2s ease;
        }
        
        .date-input:focus {
            border-color: #667eea !important;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2) !important;
            outline: none !important;
        }
        
        .date-input:hover {
            border-color: #999 !important;
        }
        
        /* סטיילים למודאלים */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
        }
        
        /* מודאל גדול יותר לייצוא וורד */
        .modal-content.large {
            max-width: 600px;
            max-height: 90vh;
        }
        
        .modal-body.large {
            padding: 25px;
            max-height: 75vh;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.2em;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.2s ease;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .add-item-section {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .add-item-section input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .add-item-section input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .items-list h4 {
            margin-bottom: 12px;
            color: #2c3e50;
            font-size: 1em;
        }
        
        .items-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .items-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            margin-bottom: 6px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            transition: all 0.2s ease;
        }
        
        .items-list li:hover {
            background: #e3f2fd;
            border-color: #bbdefb;
        }
        
        .item-text {
            flex: 1;
            font-weight: 500;
            padding: 3px 6px;
            border-radius: 3px;
            transition: all 0.2s ease;
            cursor: text;
            border: 1px solid transparent;
        }
        
        .item-text:hover {
            background: #fff;
            border-color: #dee2e6;
        }
        
        .item-text:focus {
            outline: 2px solid #667eea;
            background: white;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .item-delete {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s ease;
        }
        
        .item-delete:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
        }
        
        /* סטיילים למודאל ייצוא וורד משופר */
        .word-export-options {
            margin-bottom: 15px;
        }
        
        .word-export-options label {
            display: block;
            margin-bottom: 12px;
            font-weight: bold;
            color: #495057;
            font-size: 14px;
        }
        
        /* סטיילים לאופציית יצוא "רק מה שסומן" */
        .export-selected-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #1565c0;
            display: none;
        }
        
        .export-selected-info.show {
            display: block;
        }
        
        /* סטיילים ל-checkboxes רגילים במקום dropdown */
        .programs-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            max-height: 250px;
            overflow-y: auto;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .program-checkbox-item {
            display: flex;
            align-items: center;
            padding: 6px 10px;
            background: white;
            border-radius: 6px;
            border: 2px solid #dee2e6;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .program-checkbox-item:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.2);
        }
        
        .program-checkbox-item.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
            font-weight: bold;
        }
        
        .program-checkbox-item input[type="checkbox"] {
            margin-left: 6px;
            cursor: pointer;
            transform: scale(1.1);
        }
        
        .program-checkbox-item label {
            cursor: pointer;
            flex: 1;
            margin: 0;
            font-size: 12px;
            font-weight: 500;
        }
        
        .program-checkbox-item.selected label {
            color: white;
            font-weight: bold;
        }
        
        .word-export-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 15px;
            padding-top: 12px;
            border-top: 2px solid #e9ecef;
        }
        
        .btn-word-export {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-word-export.primary {
            background: linear-gradient(135deg, #2b579a, #1d4084);
            color: white;
        }
        
        .btn-word-export.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(43, 87, 154, 0.4);
        }
        
        .btn-word-export.secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-word-export.secondary:hover {
            background: #545b62;
        }
        
        /* תצוגת קרטיסים לנייד */
        .mobile-cards {
            display: none;
            padding: 8px;
        }
        
        .mobile-card {
            background: white;
            border-radius: 10px;
            margin-bottom: 12px;
            padding: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
            position: relative;
        }
        
        .mobile-card.marked {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border-color: #f39c12;
            box-shadow: 0 2px 6px rgba(243, 156, 18, 0.2);
        }
        
        .mobile-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .mobile-card-number {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 5px 10px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 12px;
            min-width: 40px;
            text-align: center;
        }
        
        .mobile-card-actions {
            display: flex;
            gap: 4px;
        }
        
        .mobile-card-content {
            margin-bottom: 10px;
        }
        
        .mobile-field {
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .mobile-field:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .mobile-field-label {
            font-weight: bold;
            color: #495057;
            font-size: 11px;
            margin-bottom: 3px;
            display: block;
        }
        
        .mobile-field-value {
            font-size: 12px;
            min-height: 16px;
        }
        
        .mobile-editable {
            padding: 6px;
            border: 1px solid transparent;
            border-radius: 4px;
            transition: all 0.2s ease;
            min-height: 16px;
        }
        
        .mobile-editable:hover {
            background: #f8f9fa;
            border-color: #dee2e6;
        }
        
        .mobile-editable:focus {
            outline: 2px solid #667eea;
            background: white;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .mobile-category-display {
            background: linear-gradient(135deg, #e8f5e8, #f0f8ff);
            color: #2e7d32;
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 11px;
            display: inline-block;
            min-width: 80px;
            text-align: center;
            border: 1px solid #c8e6c9;
            cursor: pointer;
        }
        
        .mobile-category-display.empty {
            background: linear-gradient(135deg, #fff3e0, #ffeaa7);
            color: #bf360c;
            border-color: #ff9800;
        }
        
        .mobile-select {
            width: 100%;
            padding: 6px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            background: white;
        }
        
        .mobile-select:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .mobile-input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .mobile-input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        
        .mobile-link-container {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        .mobile-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
        }
        
        .mobile-btn-small {
            padding: 4px 8px;
            font-size: 9px;
        }
        
        .mobile-checkbox {
            width: 16px;
            height: 16px;
            margin: 4px;
            cursor: pointer;
        }
        
        /* סל מחזור סטיילים */
        .recycle-count {
            background: #fd7e14;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 10px;
            margin-right: 5px;
            min-width: 18px;
            text-align: center;
        }
        
        .deleted-item {
            background: #f8d7da !important;
            border: 1px solid #f5c6cb !important;
            opacity: 0.7;
        }
        
        @media (max-width: 1200px) {
            .controls {
                flex-direction: column;
            }
            
            .search-box, .category-filter, .program-filter-container, .approval-filter-container {
                width: 100%;
                min-width: auto;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .container {
                margin: 8px;
                max-width: calc(100vw - 16px);
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 4px;
            }
            
            .container {
                margin: 4px;
                max-width: calc(100vw - 8px);
            }
            
            .header {
                padding: 12px 10px;
            }
            
            .header h1 {
                font-size: 1.3em;
            }
            
            .controls {
                padding: 10px;
            }
            
            .action-buttons {
                flex-direction: column;
                width: 100%;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 6px;
                padding: 10px;
                font-size: 14px;
            }
            
            .search-box, .category-filter, .program-filter-container, .approval-filter-container {
                font-size: 14px;
                margin-bottom: 8px;
            }
            
            .search-box, .category-filter {
                padding: 10px 15px;
            }
            
            .program-filter-display, .approval-filter-display {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .bulk-actions {
                margin: 8px 10px;
                padding: 8px;
            }
            
            .bulk-actions-buttons {
                flex-direction: column;
                gap: 6px;
            }
            
            .btn-bulk {
                width: 100%;
                padding: 8px;
                font-size: 12px;
            }
            
            .table-container {
                display: none;
            }
            
            .mobile-cards {
                display: block;
            }
            
            .stats {
                font-size: 11px;
                padding: 8px 10px;
                line-height: 1.4;
            }
            
            .modal-content {
                width: 95%;
                max-width: none;
                margin: 8px;
            }
            
            .modal-content.large {
                width: 98%;
                max-width: none;
                margin: 4px;
                max-height: 95vh;
            }
            
            .modal-body {
                padding: 12px;
            }
            
            .modal-body.large {
                padding: 15px;
                max-height: 85vh;
            }
            
            .add-item-section {
                flex-direction: column;
                gap: 8px;
            }
            
            .add-item-section input {
                padding: 12px;
                font-size: 14px;
            }
            
            .save-indicator {
                top: 8px;
                right: 8px;
                left: 8px;
                text-align: center;
                font-size: 12px;
            }
            
            /* התאמות מיוחדות לדרופדאונים בנייד */
            .program-filter-dropdown, .approval-filter-dropdown {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90vw;
                max-width: 350px;
                max-height: 60vh;
                z-index: 2000;
                box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            }
            
            .program-option, .approval-option {
                padding: 12px;
                font-size: 14px;
            }
            
            /* התאמות למודאל ייצוא וורד בנייד */
            .programs-checkboxes {
                grid-template-columns: 1fr;
                max-height: 200px;
                gap: 6px;
            }
            
            .program-checkbox-item {
                padding: 8px 12px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="save-indicator" id="saveIndicator">✅ נשמר!</div>
        
<div class="header">
    <h1>🎬 מנהל סרטונים</h1>
    <p>ארגון וניהול סרטונים לתסריט - Firebase בזמן אמת</p>
    <div style="margin-top: 10px;">
        <a href="script-builder.html" target="_blank" class="btn" style="background: linear-gradient(135deg, #fff, #f0f0f0); color: #2b579a; font-weight: bold; text-decoration: none; display: inline-block; padding: 10px 20px;">
            🎬 לבונה התסריטים
        </a>
    </div>
</div>
        
        <div class="controls">
            <input type="text" class="search-box" placeholder="🔍 חפש סרטון או תוכן..." id="searchInput">
            <select class="category-filter" id="categoryFilter">
                <option value="">כל הקטגוריות</option>
            </select>
            <div class="program-filter-container">
                <div class="program-filter-display" onclick="toggleProgramFilter()" id="programFilterDisplay">
                    <span id="programFilterText">כל התוכניות</span>
                    <span class="program-filter-arrow" id="programFilterArrow">▼</span>
                </div>
                <div class="program-filter-dropdown" id="programFilterDropdown">
                    <div class="program-option" data-value="">
                        <input type="checkbox" id="program-all" onchange="toggleProgramOption('', this)">
                        <label for="program-all">כל התוכניות</label>
                    </div>
                    <div class="program-option" data-value="unassigned">
                        <input type="checkbox" id="program-unassigned" onchange="toggleProgramOption('unassigned', this)">
                        <label for="program-unassigned">לא שובץ</label>
                    </div>
                    <div class="program-option" data-value="1">
                        <input type="checkbox" id="program-1" onchange="toggleProgramOption('1', this)">
                        <label for="program-1">פרק 1</label>
                    </div>
                    <div class="program-option" data-value="2">
                        <input type="checkbox" id="program-2" onchange="toggleProgramOption('2', this)">
                        <label for="program-2">פרק 2</label>
                    </div>
                    <div class="program-option" data-value="3">
                        <input type="checkbox" id="program-3" onchange="toggleProgramOption('3', this)">
                        <label for="program-3">פרק 3</label>
                    </div>
                    <div class="program-option" data-value="4">
                        <input type="checkbox" id="program-4" onchange="toggleProgramOption('4', this)">
                        <label for="program-4">פרק 4</label>
                    </div>
                    <div class="program-option" data-value="5">
                        <input type="checkbox" id="program-5" onchange="toggleProgramOption('5', this)">
                        <label for="program-5">פרק 5</label>
                    </div>
                    <div class="program-option" data-value="6">
                        <input type="checkbox" id="program-6" onchange="toggleProgramOption('6', this)">
                        <label for="program-6">פרק 6</label>
                    </div>
                    <div class="program-option" data-value="7">
                        <input type="checkbox" id="program-7" onchange="toggleProgramOption('7', this)">
                        <label for="program-7">פרק 7</label>
                    </div>
                    <div class="program-option" data-value="8">
                        <input type="checkbox" id="program-8" onchange="toggleProgramOption('8', this)">
                        <label for="program-8">פרק 8</label>
                    </div>
                    <div class="program-option" data-value="9">
                        <input type="checkbox" id="program-9" onchange="toggleProgramOption('9', this)">
                        <label for="program-9">פרק 9</label>
                    </div>
                    <div class="program-option" data-value="10">
                        <input type="checkbox" id="program-10" onchange="toggleProgramOption('10', this)">
                        <label for="program-10">פרק 10</label>
                    </div>
                    <div class="program-option" data-value="11">
                        <input type="checkbox" id="program-11" onchange="toggleProgramOption('11', this)">
                        <label for="program-11">פרק 11</label>
                    </div>
                    <div class="program-option" data-value="12">
                        <input type="checkbox" id="program-12" onchange="toggleProgramOption('12', this)">
                        <label for="program-12">פרק 12</label>
                    </div>
                    <div class="program-option" data-value="13">
                        <input type="checkbox" id="program-13" onchange="toggleProgramOption('13', this)">
                        <label for="program-13">פרק 13</label>
                    </div>
                    <div class="program-option" data-value="14">
                        <input type="checkbox" id="program-14" onchange="toggleProgramOption('14', this)">
                        <label for="program-14">פרק 14</label>
                    </div>
                    <div class="program-option" data-value="15">
                        <input type="checkbox" id="program-15" onchange="toggleProgramOption('15', this)">
                        <label for="program-15">פרק 15</label>
                    </div>
                    <div class="program-option" data-value="16">
                        <input type="checkbox" id="program-16" onchange="toggleProgramOption('16', this)">
                        <label for="program-16">פרק 16</label>
                    </div>
                    <div class="program-option" data-value="17">
                        <input type="checkbox" id="program-17" onchange="toggleProgramOption('17', this)">
                        <label for="program-17">פרק 17</label>
                    </div>
                    <div class="program-option" data-value="18">
                        <input type="checkbox" id="program-18" onchange="toggleProgramOption('18', this)">
                        <label for="program-18">פרק 18</label>
                    </div>
                    <div class="program-option" data-value="19">
                        <input type="checkbox" id="program-19" onchange="toggleProgramOption('19', this)">
                        <label for="program-19">פרק 19</label>
                    </div>
                    <div class="program-option" data-value="20">
                        <input type="checkbox" id="program-20" onchange="toggleProgramOption('20', this)">
                        <label for="program-20">פרק 20</label>
                    </div>
                    <div class="program-option" data-value="21">
                        <input type="checkbox" id="program-21" onchange="toggleProgramOption('21', this)">
                        <label for="program-21">פרק 21</label>
                    </div>
                    <div class="program-option" data-value="22">
                        <input type="checkbox" id="program-22" onchange="toggleProgramOption('22', this)">
                        <label for="program-22">פרק 22</label>
                    </div>
                    <div class="program-option" data-value="23">
                        <input type="checkbox" id="program-23" onchange="toggleProgramOption('23', this)">
                        <label for="program-23">פרק 23</label>
                    </div>
                    <div class="program-option" data-value="24">
                        <input type="checkbox" id="program-24" onchange="toggleProgramOption('24', this)">
                        <label for="program-24">פרק 24</label>
                    </div>
                    <div class="program-option" data-value="25">
                        <input type="checkbox" id="program-25" onchange="toggleProgramOption('25', this)">
                        <label for="program-25">פרק 25</label>
                    </div>
                </div>
            </div>
            <div class="approval-filter-container">
                <div class="approval-filter-display" onclick="toggleApprovalFilter()" id="approvalFilterDisplay">
                    <span id="approvalFilterText">כל הסטטוסים</span>
                    <span class="approval-filter-arrow" id="approvalFilterArrow">▼</span>
                </div>
                <div class="approval-filter-dropdown" id="approvalFilterDropdown">
                    <div class="approval-option" data-value="">
                        <input type="checkbox" id="approval-all" onchange="toggleApprovalOption('', this)">
                        <label for="approval-all">כל הסטטוסים</label>
                    </div>
                    <div class="approval-option" data-value="approved">
                        <input type="checkbox" id="approval-approved" onchange="toggleApprovalOption('approved', this)">
                        <label for="approval-approved">מאושר</label>
                    </div>
                    <div class="approval-option" data-value="not-approved">
                        <input type="checkbox" id="approval-not-approved" onchange="toggleApprovalOption('not-approved', this)">
                        <label for="approval-not-approved">לא מאושר</label>
                    </div>
                    <div class="approval-option" data-value="pending">
                        <input type="checkbox" id="approval-pending" onchange="toggleApprovalOption('pending', this)">
                        <label for="approval-pending">בטיפול</label>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-add" onclick="addNewRow()">➕ הוסף</button>
                <button class="btn btn-add" onclick="showCategoryManager()" style="background: linear-gradient(135deg, #6f42c1, #563d7c);">🏷️ קטגוריות</button>
                <button class="btn btn-import" onclick="document.getElementById('fileInput').click()">📂 טען</button>
                <button class="btn btn-export" onclick="exportData()">📁 JSON</button>
                <button class="btn btn-excel" onclick="exportToExcel()">📊 CSV</button>
                <button class="btn btn-word" onclick="showWordExportDialog()">📝 Word</button>
                <button class="btn btn-recycle" onclick="showRecycleBin()" id="recycleBinBtn">
                    🗑️ סל מחזור <span class="recycle-count" id="recycleCount" style="display: none;">0</span>
                </button>
                <button class="btn btn-export" onclick="toggleArchive()" id="archiveToggle">📦 ארכיון</button>
                <button class="btn btn-reset" onclick="resetFilters()">🔄 אפס סינונים</button>
                <button class="btn btn-export" onclick="refreshData()">🔄 רענן</button>
                <button class="btn btn-export" onclick="clearData()">🗑️ נקה</button>
            </div>
            
            <input type="file" id="fileInput" class="file-input" accept=".json" onchange="importData(event)">
        </div>
        
        <!-- פאנל בחירה מרובה -->
        <div class="bulk-actions" id="bulkActions">
            <div style="margin-bottom: 8px;">
                <strong>🔢 נבחרו <span id="selectedCount">0</span> סרטונים</strong>
            </div>
            <div class="bulk-actions-buttons">
                <button class="btn-bulk btn-bulk-archive" id="bulkArchiveBtn" onclick="bulkArchive()">📦 העבר לארכיון</button>
                <button class="btn-bulk btn-bulk-restore" id="bulkRestoreBtn" onclick="bulkRestore()" style="display: none;">↩️ החזר מארכיון</button>
                <button class="btn-bulk btn-bulk-delete" onclick="bulkDelete()">🗑️ סל מחזור</button>
                <button class="btn-bulk" onclick="clearSelection()" style="background: #6c757d; color: white;">❌ בטל</button>
            </div>
        </div>
        
        <!-- מודאל ניהול קטגוריות -->
        <div class="modal" id="categoryModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>🏷️ ניהול קטגוריות</h3>
                    <button class="modal-close" onclick="closeCategoryManager()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="add-item-section">
                        <input type="text" id="newCategoryInput" placeholder="הכנס קטגוריה חדשה...">
                        <button class="btn btn-add" onclick="addNewCategory()">➕ הוסף</button>
                    </div>
                    <div class="items-list">
                        <h4>קטגוריות קיימות: <span style="font-size: 11px; font-weight: normal; color: #666;">(לחץ על השם לעריכה)</span></h4>
                        <ul id="categoriesList"></ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- מודאל סל מחזור -->
        <div class="modal" id="recycleBinModal" style="display: none;">
            <div class="modal-content large">
                <div class="modal-header">
                    <h3>🗑️ סל מחזור</h3>
                    <button class="modal-close" onclick="closeRecycleBin()">&times;</button>
                </div>
                <div class="modal-body large">
                    <div style="margin-bottom: 15px; display: flex; gap: 8px; align-items: center;">
                        <button class="btn btn-add" onclick="emptyRecycleBin()" style="background: linear-gradient(135deg, #dc3545, #c82333);">🗑️ רוקן סל</button>
                        <span style="color: #666; font-size: 12px;">הסרטונים במחזור יימחקו לצמיתות בעוד 30 יום</span>
                    </div>
                    <div id="recycleBinList">
                        <!-- רשימת הסרטונים במחזור תמולא כאן -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- מודאל ייצוא וורד משופר עם Checkboxes רגילים -->
        <div class="modal" id="wordExportModal" style="display: none;">
            <div class="modal-content large">
                <div class="modal-header">
                    <h3>📝 ייצוא לוורד</h3>
                    <button class="modal-close" onclick="closeWordExportDialog()">&times;</button>
                </div>
                <div class="modal-body large">
                    <div class="export-selected-info" id="exportSelectedInfo">
                        📌 יש לך <span id="selectedExportCount">0</span> סרטונים מסומנים
                    </div>
                    <div class="word-export-options">
                        <label>בחר אופציית ייצוא:</label>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: normal;">
                                <input type="radio" name="exportType" value="programs" checked onchange="toggleExportType()">
                                לפי תוכניות
                            </label>
                            <label style="display: block; font-weight: normal;">
                                <input type="radio" name="exportType" value="selected" onchange="toggleExportType()">
                                רק מה שסומן
                            </label>
                        </div>
                        <div id="programSelectionDiv">
                            <label>בחר תוכניות לייצוא:</label>
                            <div class="programs-checkboxes">
                                <div class="program-checkbox-item" onclick="toggleWordExportProgram('', this)">
                                    <input type="checkbox" id="word-export-all" onchange="handleWordExportProgramChange('', this)">
                                    <label for="word-export-all">כל התוכניות</label>
                                </div>
                                <div class="program-checkbox-item" onclick="toggleWordExportProgram('unassigned', this)">
                                    <input type="checkbox" id="word-export-unassigned" onchange="handleWordExportProgramChange('unassigned', this)">
                                    <label for="word-export-unassigned">לא שובץ</label>
                                </div>
                                <div class="program-checkbox-item" onclick="toggleWordExportProgram('1', this)">
                                    <input type="checkbox" id="word-export-1" onchange="handleWordExportProgramChange('1', this)">
                                    <label for="word-export-1">פרק 1</label>
                                </div>
                                <div class="program-checkbox-item" onclick="toggleWordExportProgram('2', this)">
                                    <input type="checkbox" id="word-export-2" onchange="handleWordExportProgramChange('2', this)">
                                    <label for="word-export-2">פרק 2</label>
                                </div>
                                <div class="program-checkbox-item" onclick="toggleWordExportProgram('3', this)">
                                    <input type="checkbox" id="word-export-3" onchange="handleWordExportProgramChange('3', this)">
                                    <label for="word-export-3">פרק 3</label>
                                </div>
                                <div class="program-checkbox-item" onclick="toggleWordExportProgram('4', this)">
                                    <input type="checkbox" id="word-export-4" onchange="handleWordExportProgramChange('4', this)">
                                    <label for="word-export-4">פרק 4</label>
                                </div>
                                <div class="program-checkbox-item" onclick="toggleWordExportProgram('5', this)">
                                    <input type="checkbox" id="word-export-5" onchange="handleWordExportProgramChange('5', this)">
                                    <label for="word-export-5">פרק 5</label>
                                </div>
                                <div class="program-checkbox-item" onclick="toggleWordExportProgram('6', this)">
                                    <input type="checkbox" id="word-export-6" onchange="handleWordExportProgramChange('6', this)">
                                    <label for="word-export-6">פרק 6</label>
                                </div>
                                <div class="program-checkbox-item" onclick="toggleWordExportProgram('7', this)">
                                    <input type="checkbox" id="word-export-7" onchange="handleWordExportProgramChange('7', this)">
                                    <label for="word-export-7">פרק 7</label>
                                </div>
                                <div class="program-checkbox-item" onclick="toggleWordExportProgram('8', this)">
                                    <input type="checkbox" id="word-export-8" onchange="handleWordExportProgramChange('8', this)">
                                    <label for="word-export-8">פרק 8</label>
                                </div>
                                <div class="program-checkbox-item" onclick="toggleWordExportProgram('9', this)">
                                    <input type="checkbox" id="word-export-9" onchange="handleWordExportProgramChange('9', this)">
                                    <label for="word-export-9">פרק 9</label>
                                </div>
                                <div class="program-checkbox-item" onclick="toggleWordExportProgram('10', this)">
                                    <input type="checkbox" id="word-export-10" onchange="handleWordExportProgramChange('10', this)">
                                    <label for="word-export-10">פרק 10</label>
                                </div>
                                <div class="program-checkbox-item" onclick="toggleWordExportProgram('11', this)">
                                    <input type="checkbox" id="word-export-11" onchange="handleWordExportProgramChange('11', this)">
                                    <label for="word-export-11">פרק 11</label>
                                </div>
                                <div class="program-checkbox-item" onclick="toggleWordExportProgram('12', this)">
                                    <input type="checkbox" id="word-export-12" onchange="handleWordExportProgramChange('12', this)">
                                    <label for="word-export-12">פרק 12</label>
                                </div>
                                <div class="program-checkbox-item" onclick="toggleWordExportProgram('13', this)">
                                    <input type="checkbox" id="word-export-13" onchange="handleWordExportProgramChange('13', this)">
                                    <label for="word-export-13">פרק 13</label>
                                </div>
                                <div class="program-checkbox-item" onclick="toggleWordExportProgram('14', this)">
                                    <input type="checkbox" id="word-export-14" onchange="handleWordExportProgramChange('14', this)">
                                    <label for="word-export-14">פרק 14</label>
                                </div>
                                <div class="program-checkbox-item" onclick="toggleWordExportProgram('15', this)">
                                    <input type="checkbox" id="word-export-15" onchange="handleWordExportProgramChange('15', this)">
                                    <label for="word-export-15">פרק 15</label>
                                </div>
                                <div class="program-checkbox-item" onclick="toggleWordExportProgram('16', this)">
                                    <input type="checkbox" id="word-export-16" onchange="handleWordExportProgramChange('16', this)">
                                    <label for="word-export-16">פרק 16</label>
                                </div>
                                <div class="program-checkbox-item" onclick="toggleWordExportProgram('17', this)">
                                    <input type="checkbox" id="word-export-17" onchange="handleWordExportProgramChange('17', this)">
                                    <label for="word-export-17">פרק 17</label>
                                </div>
                                <div class="program-checkbox-item" onclick="toggleWordExportProgram('18', this)">
                                    <input type="checkbox" id="word-export-18" onchange="handleWordExportProgramChange('18', this)">
                                    <label for="word-export-18">פרק 18</label>
                                </div>
                                <div class="program-checkbox-item" onclick="toggleWordExportProgram('19', this)">
                                    <input type="checkbox" id="word-export-19" onchange="handleWordExportProgramChange('19', this)">
                                    <label for="word-export-19">פרק 19</label>
                                </div>
                                <div class="program-checkbox-item" onclick="toggleWordExportProgram('20', this)">
                                    <input type="checkbox" id="word-export-20" onchange="handleWordExportProgramChange('20', this)">
                                    <label for="word-export-20">פרק 20</label>
                                </div>
                                <div class="program-checkbox-item" onclick="toggleWordExportProgram('21', this)">
                                    <input type="checkbox" id="word-export-21" onchange="handleWordExportProgramChange('21', this)">
                                    <label for="word-export-21">פרק 21</label>
                                </div>
                                <div class="program-checkbox-item" onclick="toggleWordExportProgram('22', this)">
                                    <input type="checkbox" id="word-export-22" onchange="handleWordExportProgramChange('22', this)">
                                    <label for="word-export-22">פרק 22</label>
                                </div>
                                <div class="program-checkbox-item" onclick="toggleWordExportProgram('23', this)">
                                    <input type="checkbox" id="word-export-23" onchange="handleWordExportProgramChange('23', this)">
                                    <label for="word-export-23">פרק 23</label>
                                </div>
                                <div class="program-checkbox-item" onclick="toggleWordExportProgram('24', this)">
                                    <input type="checkbox" id="word-export-24" onchange="handleWordExportProgramChange('24', this)">
                                    <label for="word-export-24">פרק 24</label>
                                </div>
                                <div class="program-checkbox-item" onclick="toggleWordExportProgram('25', this)">
                                    <input type="checkbox" id="word-export-25" onchange="handleWordExportProgramChange('25', this)">
                                    <label for="word-export-25">פרק 25</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="word-export-buttons">
                        <button class="btn-word-export secondary" onclick="closeWordExportDialog()">ביטול</button>
                        <button class="btn-word-export primary" onclick="exportToWord()">📝 יצא לוורד</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="stats" id="stats">
            טוען נתונים...
        </div>
        
        <div class="table-container">
            <table id="videosTable">
                <thead>
                    <tr>
                        <th style="width: 30px;">
                            <input type="checkbox" class="select-all-checkbox" id="selectAll" onchange="toggleSelectAll()">
                        </th>
                        <th style="width: 85px;" class="sortable-header" onclick="sortData('createdAt')">
                            תאריך הוספה <span class="sort-indicator" id="sort-createdAt"></span>
                        </th>
                        <th style="width: 80px;" class="sortable-header" onclick="sortData('number')">
                            מספר בטבלה <span class="sort-indicator" id="sort-number"></span>
                        </th>
                        <th style="width: 120px;" class="sortable-header" onclick="sortData('category')">
                            קטגוריה <span class="sort-indicator" id="sort-category"></span>
                        </th>
                        <th style="width: 180px;">הסרטון</th>
                        <th style="width: 200px;">תיאור הסרטון</th>
                        <th style="width: 100px;">קישור לדרייב</th>
                        <th style="width: 100px;">קישור מקור</th>
                        <th style="width: 80px;">תאריך</th>
                        <th style="width: 160px;">שאלה</th>
                        <th style="width: 100px;" class="sortable-header" onclick="sortData('approvalStatus')">
                            האם אושר? <span class="sort-indicator" id="sort-approvalStatus"></span>
                        </th>
                        <th style="width: 70px;" class="sortable-header" onclick="sortData('program')">
                            תוכנית <span class="sort-indicator" id="sort-program"></span>
                        </th>
                        <th style="width: 80px;">פעולות</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
        
        <!-- תצוגת קרטיסים לנייד -->
        <div class="mobile-cards" id="mobileCards">
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://unpkg.com/html-docx-js/dist/html-docx.min.js"></script>

    <script>
        // הגדרות Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA_xIrjXqNBHtvCdruFeinIN4G134GqPiI",
            authDomain: "makorepo-81e68.firebaseapp.com",
            databaseURL: "https://makorepo-81e68-default-rtdb.firebaseio.com",
            projectId: "makorepo-81e68",
            storageBucket: "makorepo-81e68.firebasestorage.app",
            messagingSenderId: "25343223097",
            appId: "1:25343223097:web:3f4c38f1802ad0a9a5b4e8",
            measurementId: "G-EWC51ELEXS"
        };

        // אתחול Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const videosRef = database.ref('videos');
        const deletedRef = database.ref('deleted');

        // נתונים בסיסיים - דוגמה קטנה (במקום 175 הסרטונים)
        let videoData = [
            {
                "number": "1",
                "category": "שונות",
                "title": "דוגמה ראשונה",
                "description": "תיאור לדוגמה",
                "marked": false,
                "link": "",
                "source": "",
                "date": "",
                "question": "",
                "program": "",
                "approvalStatus": "pending",
                "archived": false,
                "createdAt": new Date().toISOString(),
                "lastModified": new Date().toISOString(),
                "modifiedBy": "מערכת"
            },
            {
                "number": "2",
                "category": "אוכל",
                "title": "דוגמה שנייה",
                "description": "",
                "marked": false,
                "link": "",
                "source": "דוגמה מקור",
                "date": "2024-01-15",
                "question": "",
                "program": "1",
                "approvalStatus": "approved",
                "archived": false,
                "createdAt": new Date().toISOString(),
                "lastModified": new Date().toISOString(),
                "modifiedBy": "מערכת"
            }
        ];

        // רשימות קטגוריות מוגדרות מראש
        let predefinedCategories = [
            "שונות", "אוכל", "טיסות", "זוגיות", "מקצועות", "אמהות וסבתות", 
            "דת ורוחניות", "השפה העברית", "חיות", "בריאות", "אקטואליה מאולפני הטלוויזיה",
            "פוליטיקה", "ידועניי ארצנו", "ספורט", "פרסומות", "טיפים", "ידיעות מהעולם",
            "ישראלים בעולם", "מה אני שומע?", "מקומי", "יהודים בעולם", "גויים",
            "היסטוריה ועובדות היסטוריות", "בכבישים", "האח הגדול", "מה הם עושים?", "שליחויות", "סיבוב מהיר"
        ];

        let filteredData = [...videoData];
        let deletedItems = []; // סל מחזור חדש
        let showArchived = false;
        
        // מערך לעקוב אחר הפריטים הנבחרים לבחירה מרובה
        let selectedItems = new Set();
        
        // מערך לשמירת היסטוריית שינויים
        let editHistory = [];
        
        // משתנים לסידור הטבלה
        let currentSortField = '';
        let currentSortDirection = 'none'; // 'none', 'asc', 'desc'
        
        // משתנים לפילטר תוכניות וסטטוס אישור
        let selectedPrograms = [];
        let selectedApprovals = [];
        let selectedWordExportPrograms = [];
        
        // פונקציה להגבלת קלט - רק עברית, אנגלית ומספרים
        function sanitizeInput(text) {
            // הביטוי הרגולרי מאפשר: עברית (א-ת), אנגלית (a-z, A-Z), מספרים (0-9), רווחים, סימני פיסוק בסיסיים
            return text.replace(/[^\u0590-\u05FFa-zA-Z0-9\s.,!?():;״"'\-]/g, '');
        }
        
        // פונקציה לאיפוס כל הסינונים
        function resetFilters() {
            // איפוס שדה החיפוש
            document.getElementById('searchInput').value = '';
            
            // איפוס קטגוריות
            document.getElementById('categoryFilter').value = '';
            
            // איפוס תוכניות
            selectedPrograms = [''];
            resetProgramFilter();
            
            // איפוס סטטוס אישור
            selectedApprovals = [''];
            resetApprovalFilter();
            
            // הפעלת הסינון מחדש
            filterData();
            
            showSaveIndicator('✅ הסינונים אופסו!');
        }
        
        // איפוס פילטר תוכניות לברירת מחדל
        function resetProgramFilter() {
            selectedPrograms = [''];
            
            // איפוס כל הcheckboxes
            document.querySelectorAll('#programFilterDropdown input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
                cb.parentElement.classList.remove('selected');
            });
            
            // סימון "כל התוכניות"
            const allCheckbox = document.getElementById('program-all');
            allCheckbox.checked = true;
            allCheckbox.parentElement.classList.add('selected');
            
            // עדכון התצוגה
            updateProgramFilterDisplay();
        }
        
        // איפוס פילטר סטטוס אישור לברירת מחדל
        function resetApprovalFilter() {
            selectedApprovals = [''];
            
            // איפוס כל הcheckboxes
            document.querySelectorAll('#approvalFilterDropdown input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
                cb.parentElement.classList.remove('selected');
            });
            
            // סימון "כל הסטטוסים"
            const allCheckbox = document.getElementById('approval-all');
            allCheckbox.checked = true;
            allCheckbox.parentElement.classList.add('selected');
            
            // עדכון התצוגה
            updateApprovalFilterDisplay();
        }
        
        // הוספת אירועי הגבלת קלט
        function addInputValidation() {
            // קבלת כל התאים הניתנים לעריכה
            document.querySelectorAll('.editable, .mobile-editable').forEach(element => {
                // הגבלה בזמן הקלדה
                element.addEventListener('input', function(e) {
                    const cursorPosition = window.getSelection().getRangeAt(0).startOffset;
                    const originalText = this.textContent;
                    const cleanText = sanitizeInput(originalText);
                    
                    if (cleanText !== originalText) {
                        this.textContent = cleanText;
                        // החזרת מיקום הסמן
                        if (this.firstChild) {
                            const range = document.createRange();
                            const selection = window.getSelection();
                            range.setStart(this.firstChild, Math.min(cursorPosition, cleanText.length));
                            range.collapse(true);
                            selection.removeAllRanges();
                            selection.addRange(range);
                        }
                    }
                });
                
                // הגבלה בעת הדבקה
                element.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                    const cleanText = sanitizeInput(pastedText);
                    document.execCommand('insertText', false, cleanText);
                });
            });
            
            // הגבלה לשדות input רגילים
            document.querySelectorAll('.link-input, .mobile-input').forEach(element => {
                const isLinkField = element.classList.contains("link-input");

                element.addEventListener('input', function(e) {
                    if (!isLinkField) {
                        const cursorPosition = this.selectionStart;
                        const originalValue = this.value;
                        const cleanValue = sanitizeInput(originalValue);

                        if (cleanValue !== originalValue) {
                            this.value = cleanValue;
                            this.setSelectionRange(cursorPosition, cursorPosition);
                        }
                    }
                });

                element.addEventListener('paste', function(e) {
                    if (!isLinkField) {
                        e.preventDefault();
                        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                        const cleanText = sanitizeInput(pastedText);
                        const cursorPosition = this.selectionStart;
                        const beforeCursor = this.value.substring(0, cursorPosition);
                        const afterCursor = this.value.substring(this.selectionEnd);
                        this.value = beforeCursor + cleanText + afterCursor;
                        this.setSelectionRange(cursorPosition + cleanText.length, cursorPosition + cleanText.length);
                    }
                });
            });
        }

        // ===== פונקציות סל מחזור =====
        
        // פתיחת סל המחזור
        function showRecycleBin() {
            const modal = document.getElementById('recycleBinModal');
            populateRecycleBinList();
            modal.style.display = 'flex';
        }
        
        // סגירת סל המחזור
        function closeRecycleBin() {
            const modal = document.getElementById('recycleBinModal');
            modal.style.display = 'none';
        }
        
        // מילוי רשימת הסרטונים בסל המחזור
        function populateRecycleBinList() {
            const list = document.getElementById('recycleBinList');
            list.innerHTML = '';
            
            if (deletedItems.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 30px; color: #666;">🗑️ סל המחזור ריק</div>';
                return;
            }
            
            deletedItems.forEach((item, index) => {
                const deletionDate = new Date(item.deletedAt).toLocaleString('he-IL');
                const div = document.createElement('div');
                div.className = 'deleted-item';
                div.style.cssText = `
                    padding: 12px;
                    margin-bottom: 8px;
                    border-radius: 8px;
                    border: 1px solid #f5c6cb;
                    background: #f8d7da;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                `;
                
                div.innerHTML = `
                    <div>
                        <strong>${item.video.title || 'ללא כותרת'}</strong>
                        <br>
                        <small style="color: #666;">
                            קטגוריה: ${item.video.category || 'ללא קטגוריה'} | 
                            נמחק: ${deletionDate}
                        </small>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button onclick="restoreFromRecycleBin(${index})" 
                                style="padding: 5px 10px; border: none; border-radius: 4px; 
                                       background: linear-gradient(135deg, #28a745, #20c997); 
                                       color: white; cursor: pointer; font-size: 11px;">
                            ↩️ שחזר
                        </button>
                        <button onclick="deleteFromRecycleBinPermanently(${index})" 
                                style="padding: 5px 10px; border: none; border-radius: 4px; 
                                       background: linear-gradient(135deg, #dc3545, #c82333); 
                                       color: white; cursor: pointer; font-size: 11px;">
                            🗑️ מחק סופית
                        </button>
                    </div>
                `;
                
                list.appendChild(div);
            });
        }
        
        // שחזור סרטון מסל המחזור
        async function restoreFromRecycleBin(index) {
            if (confirm('האם אתה בטוח שברצונך לשחזר את הסרטון הזה?')) {
                const restoredItem = deletedItems.splice(index, 1)[0];
                restoredItem.video.lastModified = new Date().toISOString();
                restoredItem.video.modifiedBy = 'משתמש';
                
                videoData.push(restoredItem.video);
                addToHistory('restore_from_recycle', videoData.length - 1, 'video', 'במחזור', 'שוחזר');
                
                await saveData();
                await saveDeletedItems();
                populateRecycleBinList();
                updateRecycleBinCounter();
                filterData();
                showSaveIndicator('✅ הסרטון שוחזר מהמחזור!');
            }
        }
        
        // מחיקה סופית מסל המחזור
        async function deleteFromRecycleBinPermanently(index) {
            if (confirm('האם אתה בטוח שברצונך למחוק את הסרטון הזה לצמיתות? פעולה זו לא ניתנת לביטול!')) {
                const deletedItem = deletedItems.splice(index, 1)[0];
                addToHistory('permanent_delete', -1, 'video', deletedItem.video.title, 'נמחק לצמיתות');
                
                await saveDeletedItems();
                populateRecycleBinList();
                updateRecycleBinCounter();
                showSaveIndicator('✅ הסרטון נמחק לצמיתות!');
            }
        }
        
        // ריקון סל המחזור
        async function emptyRecycleBin() {
            if (deletedItems.length === 0) {
                alert('סל המחזור כבר ריק!');
                return;
            }
            
            if (confirm(`האם אתה בטוח שברצונך למחוק ${deletedItems.length} סרטונים לצמיתות? פעולה זו לא ניתנת לביטול!`)) {
                const count = deletedItems.length;
                deletedItems = [];
                
                await saveDeletedItems();
                populateRecycleBinList();
                updateRecycleBinCounter();
                closeRecycleBin();
                showSaveIndicator(`✅ ${count} סרטונים נמחקו לצמיתות!`);
            }
        }
        
        // עדכון מונה סל המחזור
        function updateRecycleBinCounter() {
            const counter = document.getElementById('recycleCount');
            const btn = document.getElementById('recycleBinBtn');
            
            if (deletedItems.length > 0) {
                counter.textContent = deletedItems.length;
                counter.style.display = 'inline-block';
                btn.style.background = 'linear-gradient(135deg, #fd7e14, #e55d00)';
            } else {
                counter.style.display = 'none';
                btn.style.background = 'linear-gradient(135deg, #6c757d, #545b62)';
            }
        }
        
        // שמירת פריטים שנמחקו ב-Firebase
        async function saveDeletedItems() {
            try {
                await deletedRef.set(deletedItems);
            } catch (e) {
                console.error('שגיאה בשמירת פריטים שנמחקו:', e);
                // גיבוי ל-localStorage
                localStorage.setItem('deletedVideoItems', JSON.stringify(deletedItems));
            }
        }
        
        // טעינת פריטים שנמחקו מ-Firebase
        async function loadDeletedItems() {
            try {
                const snapshot = await deletedRef.once('value');
                const data = snapshot.val();
                
                if (data && Array.isArray(data)) {
                    deletedItems = data;
                } else {
                    // גיבוי מ-localStorage
                    const saved = localStorage.getItem('deletedVideoItems');
                    if (saved) {
                        deletedItems = JSON.parse(saved);
                    }
                }
                
                updateRecycleBinCounter();
            } catch (e) {
                console.error('שגיאה בטעינת פריטים שנמחקו:', e);
                // טעינה מ-localStorage
                const saved = localStorage.getItem('deletedVideoItems');
                if (saved) {
                    deletedItems = JSON.parse(saved);
                    updateRecycleBinCounter();
                }
            }
        }

        // פונקציה להוספת רשומה להיסטוריה
        function addToHistory(action, videoIndex, field, oldValue, newValue) {
            const now = new Date();
            editHistory.push({
                timestamp: now.toISOString(),
                displayTime: now.toLocaleString('he-IL'),
                action,
                videoIndex,
                field,
                oldValue,
                newValue,
                videoTitle: videoData[videoIndex]?.title || 'לא ידוע'
            });
            
            // שמירת היסטוריה ב-localStorage (מקסימום 1000 רשומות)
            if (editHistory.length > 1000) {
                editHistory = editHistory.slice(-1000);
            }
        }
        
        // טעינת היסטוריה מ-localStorage
        function loadHistory() {
            try {
                const saved = localStorage.getItem('videoEditHistory');
                if (saved) {
                    editHistory = JSON.parse(saved);
                }
            } catch (e) {
                console.error('שגיאה בטעינת היסטוריה:', e);
            }
        }

        // ===== פונקציות ייצוא וורד משופרות עם Checkboxes רגילים =====
        
        // פתיחת דיאלוג ייצוא וורד
        function showWordExportDialog() {
            const modal = document.getElementById('wordExportModal');
            
            // עדכון מספר הסרטונים המסומנים
            updateSelectedExportCount();
            
            // איפוס בחירה לכל התוכניות
            resetWordExportSelection();
            
            // איפוס סוג הייצוא
            document.querySelector('input[name="exportType"][value="programs"]').checked = true;
            toggleExportType();
            
            modal.style.display = 'flex';
        }
        
        // עדכון מספר הסרטונים המסומנים
        function updateSelectedExportCount() {
            const count = selectedItems.size;
            document.getElementById('selectedExportCount').textContent = count;
            
            const infoDiv = document.getElementById('exportSelectedInfo');
            if (count > 0) {
                infoDiv.classList.add('show');
            } else {
                infoDiv.classList.remove('show');
            }
        }
        
        // החלפת סוג הייצוא
        function toggleExportType() {
            const exportType = document.querySelector('input[name="exportType"]:checked').value;
            const programDiv = document.getElementById('programSelectionDiv');
            
            if (exportType === 'programs') {
                programDiv.style.display = 'block';
            } else {
                programDiv.style.display = 'none';
            }
        }
        
        // סגירת דיאלוג ייצוא וורד
        function closeWordExportDialog() {
            const modal = document.getElementById('wordExportModal');
            modal.style.display = 'none';
        }
        
        // איפוס בחירה לכל התוכניות
        function resetWordExportSelection() {
            selectedWordExportPrograms = [''];
            
            // איפוס כל הcheckboxes
            document.querySelectorAll('.program-checkbox-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                checkbox.checked = false;
                item.classList.remove('selected');
            });
            
            // סימון "כל התוכניות"
            const allCheckbox = document.getElementById('word-export-all');
            allCheckbox.checked = true;
            allCheckbox.closest('.program-checkbox-item').classList.add('selected');
        }
        
        // טיפול בלחיצה על פריט תוכנית (עבור הקליק על הדיב)
        function toggleWordExportProgram(value, element) {
            // אם הלחיצה הייתה על הcheckbox עצמו, לא נעשה כלום (הhandler של הcheckbox יטפל)
            if (event.target.type === 'checkbox') {
                return;
            }
            
            // אחרת, נלחץ על הcheckbox
            const checkbox = element.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            handleWordExportProgramChange(value, checkbox);
        }
        
        // טיפול בשינוי checkbox של תוכנית
        function handleWordExportProgramChange(value, checkbox) {
            if (value === '') {
                // אם נבחר "כל התוכניות"
                if (checkbox.checked) {
                    selectedWordExportPrograms = [''];
                    // ביטול כל השאר
                    document.querySelectorAll('.program-checkbox-item').forEach(item => {
                        const cb = item.querySelector('input[type="checkbox"]');
                        const itemValue = cb.id.replace('word-export-', '');
                        if (itemValue !== '') {
                            cb.checked = false;
                            item.classList.remove('selected');
                        } else {
                            item.classList.add('selected');
                        }
                    });
                } else {
                    selectedWordExportPrograms = [];
                    checkbox.parentElement.classList.remove('selected');
                }
            } else {
                // בחירת תוכנית ספציפית
                if (checkbox.checked) {
                    // הסרת "כל התוכניות" מהבחירה
                    selectedWordExportPrograms = selectedWordExportPrograms.filter(p => p !== '');
                    const allCheckbox = document.getElementById('word-export-all');
                    allCheckbox.checked = false;
                    allCheckbox.parentElement.classList.remove('selected');
                    
                    // הוספת הבחירה החדשה
                    if (!selectedWordExportPrograms.includes(value)) {
                        selectedWordExportPrograms.push(value);
                    }
                    checkbox.parentElement.classList.add('selected');
                } else {
                    // הסרת הבחירה
                    selectedWordExportPrograms = selectedWordExportPrograms.filter(p => p !== value);
                    checkbox.parentElement.classList.remove('selected');
                    
                    // אם לא נשאר כלום נבחר, חזרה ל"כל התוכניות"
                    if (selectedWordExportPrograms.length === 0) {
                        selectedWordExportPrograms = [''];
                        const allCheckbox = document.getElementById('word-export-all');
                        allCheckbox.checked = true;
                        allCheckbox.parentElement.classList.add('selected');
                    }
                }
            }
        }
        
        // פונקציה להמרת סטטוס אישור לטקסט
        function getApprovalText(status) {
            switch(status) {
                case 'approved':
                    return 'מאושר';
                case 'not-approved':
                    return 'לא מאושר';
                case 'pending':
                    return 'בטיפול';
                default:
                    return 'בטיפול';
            }
        }
        
        // פונקציית ייצוא לוורד משופרת
        function exportToWord() {
            try {
                showSaveIndicator('📝 יוצר מסמך וורד...');
                
                const exportType = document.querySelector('input[name="exportType"]:checked').value;
                let dataToExport = [];
                let fileName = 'סרטונים';
                
                if (exportType === 'selected') {
                    // ייצוא רק מה שסומן
                    if (selectedItems.size === 0) {
                        alert('לא נבחרו סרטונים לייצוא');
                        return;
                    }
                    
                    // איסוף הסרטונים המסומנים
                    dataToExport = Array.from(selectedItems).map(index => filteredData[index]).filter(video => video);
                    fileName += '_מסומנים';
                } else {
                    // ייצוא לפי תוכניות
                    dataToExport = videoData.filter(video => !video.archived); // רק סרטונים פעילים
                    
                    if (selectedWordExportPrograms.length > 0 && !selectedWordExportPrograms.includes('')) {
                        dataToExport = dataToExport.filter(video => {
                            // בדיקה אם הסרטון שייך לאחת מהתוכניות הנבחרות
                            if (selectedWordExportPrograms.includes('unassigned')) {
                                // אם נבחר "לא שובץ" - כלול גם סרטונים ללא תוכנית
                                if (video.program === 'unassigned' || !video.program || video.program.trim() === '') {
                                    return true;
                                }
                            }
                            
                            // בדיקה אם התוכנית של הסרטון נמצאת ברשימה הנבחרת
                            return selectedWordExportPrograms.includes(video.program);
                        });
                    }
                    
                    if (selectedWordExportPrograms.length > 0 && !selectedWordExportPrograms.includes('')) {
                        if (selectedWordExportPrograms.length === 1) {
                            if (selectedWordExportPrograms[0] === 'unassigned') {
                                fileName += '_לא_שובץ';
                            } else {
                                fileName += `_פרק_${selectedWordExportPrograms[0]}`;
                            }
                        } else {
                            fileName += '_תוכניות_נבחרות';
                        }
                    }
                }
                
                if (dataToExport.length === 0) {
                    alert('לא נמצאו סרטונים לייצוא');
                    return;
                }
                
                // מיון לפי קטגוריות
                dataToExport.sort((a, b) => {
                    // קודם מיון לפי קטגוריה
                    const catCompare = (a.category || '').localeCompare(b.category || '', 'he');
                    if (catCompare !== 0) return catCompare;
                    // אחר כך לפי מספר
                    const numA = parseInt(a.number) || 0;
                    const numB = parseInt(b.number) || 0;
                    return numA - numB;
                });
                
                fileName += `_${new Date().toISOString().slice(0, 10)}.doc`;
                
                // יצירת תוכן HTML לוורד פשוט יותר שיעבוד בסמארטפונים
                let wordContent = `
                <html xmlns:o="urn:schemas-microsoft-com:office:office" 
                      xmlns:w="urn:schemas-microsoft-com:office:word">
                <head>
                    <meta charset="UTF-8">
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            font-size: 11pt; 
                            direction: rtl; 
                            text-align: right;
                        }
                        h1 { 
                            font-size: 16pt; 
                            text-align: center; 
                            color: #2c3e50;
                        }
                        h2 { 
                            font-size: 12pt; 
                            color: #34495e;
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin-bottom: 15pt;
                        }
                        th { 
                            background-color: #3498db; 
                            color: white; 
                            padding: 8pt; 
                            border: 1pt solid #2980b9; 
                            font-weight: bold;
                        }
                        td { 
                            padding: 6pt; 
                            border: 1pt solid #bdc3c7; 
                        }
                        .category-header {
                            background-color: #34495e;
                            color: white;
                            font-weight: bold;
                            padding: 8pt;
                            margin: 10pt 0;
                        }
                    </style>
                </head>
                <body>`;
                
                // כותרת המסמך
                wordContent += `<h1>🎬 רשימת סרטונים`;
                
                if (exportType === 'selected') {
                    wordContent += ' - רשימה מותאמת אישית';
                } else if (selectedWordExportPrograms.length > 0 && !selectedWordExportPrograms.includes('')) {
                    if (selectedWordExportPrograms.length === 1) {
                        if (selectedWordExportPrograms[0] === 'unassigned') {
                            wordContent += ' - לא שובצו לפרק';
                        } else {
                            wordContent += ` - פרק ${selectedWordExportPrograms[0]}`;
                        }
                    } else {
                        // תצוגה של כל התוכניות הנבחרות
                        const programNames = selectedWordExportPrograms.map(p => 
                            p === 'unassigned' ? 'לא שובץ' : `פרק ${p}`
                        ).join(', ');
                        wordContent += ` - ${programNames}`;
                    }
                }
                wordContent += `</h1>`;
                
                // תאריך ושעת יצירה
                const now = new Date();
                wordContent += `<h2>תאריך יצירה: ${now.toLocaleDateString('he-IL')} בשעה ${now.toLocaleTimeString('he-IL')}</h2>`;
                
                // הטבלה - עם חלוקה לפי קטגוריות
                let currentCategory = null;
                let tableOpen = false;
                
                dataToExport.forEach((video, index) => {
                    // בדיקה אם יש צורך להתחיל קטגוריה חדשה
                    if (video.category !== currentCategory) {
                        // סגירת טבלה קודמת אם קיימת
                        if (tableOpen) {
                            wordContent += `</tbody></table>`;
                        }
                        
                        currentCategory = video.category;
                        
                        // כותרת קטגוריה
                        wordContent += `<div class="category-header">קטגוריה: ${currentCategory || 'ללא קטגוריה'}</div>`;
                        
                        // התחלת טבלה חדשה
                        wordContent += `
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 10%">מס'</th>
                                    <th style="width: 35%">הסרטון</th>
                                    <th style="width: 40%">שאלה</th>
                                    <th style="width: 15%">סטטוס</th>
                                </tr>
                            </thead>
                            <tbody>`;
                        
                        tableOpen = true;
                    }
                    
                    // הוספת שורה
                    wordContent += `
                    <tr>
                        <td style="text-align: center">${video.number || (index + 1)}</td>
                        <td>${video.title || ''}</td>
                        <td>${video.question || ''}</td>
                        <td style="text-align: center">${getApprovalText(video.approvalStatus)}</td>
                    </tr>`;
                });
                
                // סגירת הטבלה האחרונה
                if (tableOpen) {
                    wordContent += `</tbody></table>`;
                }
                
                // סיכום
                const categoryCounts = {};
                dataToExport.forEach(video => {
                    const cat = video.category || 'ללא קטגוריה';
                    categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
                });
                
                wordContent += `
                <div style="margin-top: 20pt; padding: 10pt; background-color: #ecf0f1; border: 1pt solid #bdc3c7;">
                    <strong>סיכום:</strong><br>
                    סה"כ סרטונים: ${dataToExport.length}<br>
                    קטגוריות: ${Object.keys(categoryCounts).length}<br>`;
                
                // פירוט לפי קטגוריות
                Object.entries(categoryCounts).sort(([a], [b]) => a.localeCompare(b, 'he')).forEach(([cat, count]) => {
                    wordContent += `${cat}: ${count} סרטונים<br>`;
                });
                
                if (exportType === 'selected') {
                    wordContent += '<br>סוג ייצוא: רשימה מותאמת אישית<br>';
                } else {
                    wordContent += `<br>תוכניות שנכללו: ${selectedWordExportPrograms.length > 0 && !selectedWordExportPrograms.includes('') ? 
                        selectedWordExportPrograms.map(p => p === 'unassigned' ? 'לא שובץ' : `פרק ${p}`).join(', ') : 
                        'כל התוכניות'}<br>`;
                }
                
                wordContent += `תאריך ושעת ייצוא: ${new Date().toLocaleString('he-IL')}<br>
                    מערכת: מנהל סרטונים
                </div>`;
                
                wordContent += `
                </body>
                </html>`;
                
                // יצירת הקובץ והורדה

            const docxBlob = window.htmlDocx.asBlob(htmlContent);
saveAs(docxBlob, fileName.replace('.doc', '.docx'));
                // סגירת המודאל והודעת הצלחה
                closeWordExportDialog();
                showSaveIndicator(`✅ יוצא לוורד: ${dataToExport.length} סרטונים!`);
                
            } catch (error) {
                console.error('שגיאה בייצוא לוורד:', error);
                showSaveIndicator('❌ שגיאה בייצוא לוורד');
            }
        }

        // ===== פונקציות חדשות לטיפול בפילטר סטטוס אישור =====
        
        // פתיחה/סגירה של פילטר סטטוס אישור
        function toggleApprovalFilter() {
            const dropdown = document.getElementById('approvalFilterDropdown');
            const display = document.getElementById('approvalFilterDisplay');
            const arrow = document.getElementById('approvalFilterArrow');
            
            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
                display.classList.remove('active');
                arrow.classList.remove('rotated');
            } else {
                dropdown.classList.add('show');
                display.classList.add('active');
                arrow.classList.add('rotated');
            }
        }
        
        // טיפול בבחירת אפשרות בפילטר סטטוס אישור
        function toggleApprovalOption(value, checkbox) {
            if (value === '') {
                // אם נבחר "כל הסטטוסים" - נקה את כל הבחירות האחרות
                if (checkbox.checked) {
                    selectedApprovals = [''];
                    // נקה את כל השאר
                    document.querySelectorAll('#approvalFilterDropdown input[type="checkbox"]').forEach(cb => {
                        if (cb.id !== 'approval-all') {
                            cb.checked = false;
                            cb.parentElement.classList.remove('selected');
                        } else {
                            cb.parentElement.classList.add('selected');
                        }
                    });
                } else {
                    selectedApprovals = [];
                    checkbox.parentElement.classList.remove('selected');
                }
            } else {
                // בחירת סטטוס ספציפי
                if (checkbox.checked) {
                    // אם זה לא "כל הסטטוסים", הסר אותו מהבחירה
                    selectedApprovals = selectedApprovals.filter(p => p !== '');
                    // הסר את הסימון מ"כל הסטטוסים"
                    const allCheckbox = document.getElementById('approval-all');
                    allCheckbox.checked = false;
                    allCheckbox.parentElement.classList.remove('selected');
                    
                    // הוסף את הבחירה החדשה
                    if (!selectedApprovals.includes(value)) {
                        selectedApprovals.push(value);
                    }
                    checkbox.parentElement.classList.add('selected');
                } else {
                    // הסר את הבחירה
                    selectedApprovals = selectedApprovals.filter(p => p !== value);
                    checkbox.parentElement.classList.remove('selected');
                    
                    // אם לא נשאר כלום נבחר, סמן "כל הסטטוסים"
                    if (selectedApprovals.length === 0) {
                        selectedApprovals = [''];
                        const allCheckbox = document.getElementById('approval-all');
                        allCheckbox.checked = true;
                        allCheckbox.parentElement.classList.add('selected');
                    }
                }
            }
            
            // עדכון הטקסט המוצג
            updateApprovalFilterDisplay();
            
            // הפעלת הסינון
            filterData();
        }
        
        // עדכון הטקסט המוצג בפילטר סטטוס אישור
        function updateApprovalFilterDisplay() {
            const textElement = document.getElementById('approvalFilterText');
            
            if (selectedApprovals.length === 0 || selectedApprovals.includes('')) {
                textElement.textContent = 'כל הסטטוסים';
            } else if (selectedApprovals.length === 1) {
                switch(selectedApprovals[0]) {
                    case 'approved':
                        textElement.textContent = 'מאושר';
                        break;
                    case 'not-approved':
                        textElement.textContent = 'לא מאושר';
                        break;
                    case 'pending':
                        textElement.textContent = 'בטיפול';
                        break;
                }
            } else {
                textElement.textContent = `${selectedApprovals.length} סטטוסים נבחרו`;
            }
        }

        // פונקציות סידור הטבלה
        function sortData(field) {
            // עדכון כיוון הסידור
            if (currentSortField === field) {
                // אותו שדה - מעבר למצב הבא
                if (currentSortDirection === 'none') {
                    currentSortDirection = 'asc';
                } else if (currentSortDirection === 'asc') {
                    currentSortDirection = 'desc';
                } else {
                    currentSortDirection = 'none';
                }
            } else {
                // שדה חדש - התחלה עם סידור עולה
                currentSortField = field;
                currentSortDirection = 'asc';
            }
            
            // עדכון האינדיקטורים החזותיים
            updateSortIndicators();
            
            // ביצוע הסידור
            if (currentSortDirection === 'none') {
                // חזרה לסדר המקורי
                filterData();
            } else {
                // סידור הנתונים
                filteredData.sort((a, b) => {
                    let valueA, valueB;
                    
                    switch (field) {
                        case 'number':
                            // סידור מספרי מיוחד
                            valueA = parseInt(a.number) || 0;
                            valueB = parseInt(b.number) || 0;
                            break;
                        case 'category':
                            valueA = a.category.toLowerCase();
                            valueB = b.category.toLowerCase();
                            break;
                        case 'createdAt':
                            valueA = a.createdAt || '0000-00-00';
                            valueB = b.createdAt || '0000-00-00';
                            break;
                        case 'program':
                            // תמיכה ב"לא שובץ" וערכים מספריים
                            if (a.program === 'unassigned' || a.program === '') valueA = -1;
                            else valueA = parseInt(a.program) || 0;
                            
                            if (b.program === 'unassigned' || b.program === '') valueB = -1;
                            else valueB = parseInt(b.program) || 0;
                            break;
                        case 'approvalStatus':
                            // סידור לפי סטטוס אישור
                            const order = { 'approved': 1, 'pending': 2, 'not-approved': 3 };
                            valueA = order[a.approvalStatus] || 2;
                            valueB = order[b.approvalStatus] || 2;
                            break;
                        default:
                            return 0;
                    }
                    
                    let comparison = 0;
                    if (valueA < valueB) {
                        comparison = -1;
                    } else if (valueA > valueB) {
                        comparison = 1;
                    }
                    
                    return currentSortDirection === 'asc' ? comparison : -comparison;
                });
                
                // עדכון הטבלה
                populateTable(filteredData);
                updateStats();
            }
        }
        
        function updateSortIndicators() {
            // ניקוי כל האינדיקטורים
            document.querySelectorAll('.sort-indicator').forEach(indicator => {
                indicator.textContent = '';
                indicator.classList.remove('active');
            });
            
            // עדכון האינדיקטור של השדה הפעיל
            if (currentSortField && currentSortDirection !== 'none') {
                const indicator = document.getElementById(`sort-${currentSortField}`);
                if (indicator) {
                    indicator.classList.add('active');
                    indicator.textContent = currentSortDirection === 'asc' ? '▲' : '▼';
                }
            }
        }

        // פונקציות שמירה וטעינה עם Firebase Realtime Database - עם Transaction!
        async function saveData() {
            try {
                showSaveIndicator('💾 שומר לענן...');
                
                // שימוש ב-Transaction של Firebase
                const result = await videosRef.transaction(function(currentData) {
                    // אם אין נתונים בענן, צור חדשים
                    if (!currentData) {
                        return {
                            data: videoData,
                            lastUpdate: new Date().toISOString(),
                            version: "2.0"
                        };
                    }
                    
                    // אם יש נתונים, עדכן אותם
                    return {
                        data: videoData,
                        lastUpdate: new Date().toISOString(),
                        version: "2.0"
                    };
                });
                
                // בדיקה שהשמירה הצליחה
                if (result.committed) {
                    showSaveIndicator('✅ נשמר בענן!');
                    console.log('נתונים נשמרו ב-Firebase עם Transaction');
                } else {
                    showSaveIndicator('✅ נשמר בענן!');
                    console.log('Transaction לא שינה כלום - הנתונים זהים');
                }
                
            } catch (e) {
                console.error('שגיאה בשמירה ל-Firebase:', e);
                showSaveIndicator('💻 נשמר מקומי');
                // חזרה ל-localStorage כגיבוי - בדיוק כמו קודם
                localStorage.setItem('videoManagerData', JSON.stringify(videoData));
            }
        }

        async function loadData() {
            try {
                showSaveIndicator('📥 טוען מהענן...');
                
                const snapshot = await videosRef.once('value');
                const data = snapshot.val();
                
                if (data && data.data && Array.isArray(data.data)) {
                    videoData = data.data;
                    
                    // הוספת שדות חדשים לנתונים שנטענו (תאימות אחורה)
                    videoData.forEach(video => {
                        if (!video.hasOwnProperty('program')) video.program = "";
                        if (!video.hasOwnProperty('archived')) video.archived = false;
                        if (!video.hasOwnProperty('createdAt')) video.createdAt = new Date().toISOString();
                        if (!video.hasOwnProperty('lastModified')) video.lastModified = new Date().toISOString();
                        if (!video.hasOwnProperty('modifiedBy')) video.modifiedBy = 'מערכת';
                        if (!video.hasOwnProperty('source')) video.source = "";
                        if (!video.hasOwnProperty('date')) video.date = "";
                        if (!video.hasOwnProperty('approvalStatus')) video.approvalStatus = "pending";
                    });
                    
                    filteredData = [...videoData];
                    console.log(`נטענו ${videoData.length} סרטונים מ-Firebase`);
                    showSaveIndicator('✅ נטען מהענן!');
                    return true;
                } else {
                    // אם אין נתונים ב-Firebase, שמור את הנתונים הבסיסיים
                    console.log('אין נתונים ב-Firebase, שומר נתונים בסיסיים');
                    await saveData();
                    return false;
                }
            } catch (e) {
                console.error('שגיאה בטעינה מ-Firebase:', e);
                showSaveIndicator('⚠️ טוען מהמחשב...');
                // חזרה ל-localStorage כגיבוי
                return loadFromLocalStorage();
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('videoManagerData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    videoData = parsedData;
                    
                    // הוספת שדות חדשים לנתונים שנטענו (תאימות אחורה)
                    videoData.forEach(video => {
                        if (!video.hasOwnProperty('program')) video.program = "";
                        if (!video.hasOwnProperty('archived')) video.archived = false;
                        if (!video.hasOwnProperty('createdAt')) video.createdAt = new Date().toISOString();
                        if (!video.hasOwnProperty('lastModified')) video.lastModified = new Date().toISOString();
                        if (!video.hasOwnProperty('modifiedBy')) video.modifiedBy = 'מערכת';
                        if (!video.hasOwnProperty('source')) video.source = "";
                        if (!video.hasOwnProperty('date')) video.date = "";
                        if (!video.hasOwnProperty('approvalStatus')) video.approvalStatus = "pending";
                    });
                    
                    filteredData = [...videoData];
                    console.log(`נטענו ${videoData.length} סרטונים מהמחשב`);
                    return true;
                }
            } catch (e) {
                console.error('שגיאה בטעינה מהמחשב:', e);
            }
            return false;
        }

        // האזנה לשינויים בזמן אמת
        function setupRealtimeListener() {
            videosRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && data.data && Array.isArray(data.data)) {
                    const newVideoData = data.data;
                    
                    // בדיקה אם הנתונים השתנו
                    if (JSON.stringify(newVideoData) !== JSON.stringify(videoData)) {
                        console.log('זוהה עדכון מהענן!');
                        
                        videoData = newVideoData;
                        
                        // הוספת שדות חדשים (תאימות אחורה)
                        videoData.forEach(video => {
                            if (!video.hasOwnProperty('program')) video.program = "";
                            if (!video.hasOwnProperty('archived')) video.archived = false;
                            if (!video.hasOwnProperty('createdAt')) video.createdAt = new Date().toISOString();
                            if (!video.hasOwnProperty('lastModified')) video.lastModified = new Date().toISOString();
                            if (!video.hasOwnProperty('modifiedBy')) video.modifiedBy = 'מערכת';
                            if (!video.hasOwnProperty('source')) video.source = "";
                            if (!video.hasOwnProperty('date')) video.date = "";
                            if (!video.hasOwnProperty('approvalStatus')) video.approvalStatus = "pending";
                        });
                        
                        // עדכון הממשק
                        filterData();
                        populateCategoryFilter();
                        updateStats();
                        updateSortIndicators(); // עדכון אינדיקטורי הסידור
                        
                        showSaveIndicator('🔄 עודכן מהחבר!');
                    }
                }
            });
        }

        function showSaveIndicator(message = '✅ נשמר!') {
            const indicator = document.getElementById('saveIndicator');
            indicator.textContent = message;
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 3000);
        }

        function openLink(url) {
            if (url && url.trim()) {
                // וידוא שהקישור מתחיל ב-http או https
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }
                window.open(url, '_blank');
            }
        }

        // פונקציה לטיפול בקטגוריות עם תצוגה משופרת
        function toggleCategoryEdit(index) {
            const categoryCell = document.querySelector(`[data-index="${index}"][data-field="category"]`).closest('.category-cell');
            categoryCell.classList.toggle('editing');
        }

        function populateTable(data) {
            const tableBody = document.getElementById('tableBody');
            const mobileCards = document.getElementById('mobileCards');
            tableBody.innerHTML = '';
            mobileCards.innerHTML = '';

            if (data.length === 0) {
                const statusText = showArchived ? 'בארכיון' : 'מתאימות';
                tableBody.innerHTML = `<tr><td colspan="13" class="no-results">🔍 לא נמצאו תוצאות ${statusText}</td></tr>`;
                mobileCards.innerHTML = `<div style="text-align: center; padding: 50px; color: #666; font-size: 18px;">🔍 לא נמצאו תוצאות ${statusText}</div>`;
                return;
            }

            data.forEach((video, index) => {
                const isSelected = selectedItems.has(index);
                const lastModified = video.lastModified ? new Date(video.lastModified).toLocaleString('he-IL') : '';
                const createdDate = video.createdAt ? new Date(video.createdAt) : new Date();
                const createdDateStr = createdDate.toLocaleDateString('he-IL');
                const createdTimeStr = createdDate.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
                
                // הכנת תצוגת תוכנית עם "פרק" ו"לא שובץ"
                let programDisplayText = '';
                if (video.program === 'unassigned' || video.program === '') {
                    programDisplayText = 'לא שובץ';
                } else {
                    programDisplayText = `פרק ${video.program}`;
                }
                
                // הכנת תצוגת סטטוס אישור
                let approvalClass = '';
                let approvalText = '';
                switch(video.approvalStatus) {
                    case 'approved':
                        approvalClass = 'approved';
                        approvalText = 'מאושר';
                        break;
                    case 'not-approved':
                        approvalClass = 'not-approved';
                        approvalText = 'לא מאושר';
                        break;
                    case 'pending':
                    default:
                        approvalClass = 'pending';
                        approvalText = 'בטיפול';
                        break;
                }

                // יצירת שורת הטבלה (תצוגת מחשב)
                const row = document.createElement('tr');
                if (video.marked) {
                    row.classList.add('marked-item');
                }
                
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="row-checkbox" ${isSelected ? 'checked' : ''} onchange="toggleRowSelection(${index})">
                    </td>
                    <td class="creation-date-cell">
                        <span class="creation-date">${createdDateStr}</span>
                        <span class="creation-time">${createdTimeStr}</span>
                    </td>
                    <td>
                        <div class="editable number-edit" contenteditable="true" data-field="number" data-index="${index}" placeholder="הכנס מספר">${video.number || ''}</div>
                        ${lastModified ? `<div class="timestamp">עודכן: ${lastModified}</div>` : ''}
                    </td>
                    <td class="category-cell">
                        <div class="category-display ${!video.category ? 'empty' : ''}" onclick="toggleCategoryEdit(${index})">
                            ${video.category || 'בחר קטגוריה'}
                        </div>
                        <select class="category-select" data-field="category" data-index="${index}" onchange="updateCategoryFromSelect(${index})" onblur="toggleCategoryEdit(${index})">
                            <option value="">בחר קטגוריה</option>
                            ${predefinedCategories.map(cat => `<option value="${cat}" ${video.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <div class="editable" contenteditable="true" data-field="title" data-index="${index}" style="font-weight: bold;">${video.title}</div>
                    </td>
                    <td>
                        <div class="editable" contenteditable="true" data-field="description" data-index="${index}">${video.description || ''}</div>
                    </td>
                    <td>
                        <div class="link-container">
                            <input type="url" class="link-input" placeholder="הכנס קישור..." value="${video.link || ''}" data-field="link" data-index="${index}">
                            ${video.link && video.link.trim() ? `<button class="btn-open-link" onclick="openLink('${video.link}')">פתח</button>` : ''}
                        </div>
                    </td>
                    <td>
                        <div class="link-container">
                            <input type="url" class="link-input" placeholder="הכנס קישור מקור..." value="${video.source || ''}" data-field="source" data-index="${index}">
                            ${video.source && video.source.trim() ? `<button class="btn-open-link" onclick="openLink('${video.source}')">פתח</button>` : ''}
                        </div>
                    </td>
                    <td>
                        <div class="editable" contenteditable="true" data-field="date" data-index="${index}" placeholder="תאריך">${video.date || ''}</div>
                    </td>
                    <td>
                        <div class="editable" contenteditable="true" data-field="question" data-index="${index}" style="font-weight: bold;">${video.question || ''}</div>
                    </td>
                    <td class="approval-cell ${approvalClass}">
                        <select class="approval-select" data-field="approvalStatus" data-index="${index}">
                            <option value="pending" ${video.approvalStatus === 'pending' || !video.approvalStatus ? 'selected' : ''}>בטיפול</option>
                            <option value="approved" ${video.approvalStatus === 'approved' ? 'selected' : ''}>מאושר</option>
                            <option value="not-approved" ${video.approvalStatus === 'not-approved' ? 'selected' : ''}>לא מאושר</option>
                        </select>
                    </td>
                    <td>
                        <select class="program-select" data-field="program" data-index="${index}">
                            <option value="unassigned" ${(video.program === 'unassigned' || video.program === '') ? 'selected' : ''}>לא שובץ</option>
                            ${Array.from({length: 25}, (_, i) => `<option value="${i + 1}" ${video.program == (i + 1) ? 'selected' : ''}>פרק ${i + 1}</option>`).join('')}
                        </select>
                    </td>
                    <td class="actions-cell">
                        ${showArchived ? 
                            `<button class="btn btn-add" onclick="restoreFromArchive(${index})" style="padding: 4px 8px; font-size: 10px;">↩️</button>` :
                            `<button class="btn btn-delete" onclick="archiveRow(${index})" style="background: linear-gradient(135deg, #ff9500, #ff6b00);">📦</button>`
                        }
                        <button class="btn btn-delete" onclick="moveToRecycleBin(${index})">🗑️</button>
                    </td>
                `;

                tableBody.appendChild(row);

                // יצירת קרטיס לנייד
                const card = document.createElement('div');
                card.classList.add('mobile-card');
                if (video.marked) {
                    card.classList.add('marked');
                }
                
                card.innerHTML = `
                    <div class="mobile-card-header">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" class="mobile-checkbox" ${isSelected ? 'checked' : ''} onchange="toggleRowSelection(${index})">
                            <div class="mobile-card-number">${video.number || '#'}</div>
                        </div>
                        <div class="mobile-card-actions">
                            ${showArchived ? 
                                `<button class="mobile-btn mobile-btn-small" onclick="restoreFromArchive(${index})" style="background: linear-gradient(135deg, #28a745, #20c997);">↩️</button>` :
                                `<button class="mobile-btn mobile-btn-small" onclick="archiveRow(${index})" style="background: linear-gradient(135deg, #ff9500, #ff6b00);">📦</button>`
                            }
                            <button class="mobile-btn mobile-btn-small" onclick="moveToRecycleBin(${index})" style="background: linear-gradient(135deg, #dc3545, #c82333);">🗑️</button>
                        </div>
                    </div>
                    
                    <div class="mobile-card-content">
                        <div class="mobile-field">
                            <span class="mobile-field-label">🎬 שם הסרטון</span>
                            <div class="mobile-editable" contenteditable="true" data-field="title" data-index="${index}" style="font-weight: bold; font-size: 14px;">${video.title}</div>
                        </div>
                        
                        <div class="mobile-field">
                            <span class="mobile-field-label">🏷️ קטגוריה</span>
                            <div class="mobile-category-display ${!video.category ? 'empty' : ''}" onclick="toggleMobileCategoryEdit(${index}, this)">
                                ${video.category || 'בחר קטגוריה'}
                            </div>
                            <select class="mobile-select" data-field="category" data-index="${index}" onchange="updateMobileCategoryFromSelect(${index})" style="display: none; margin-top: 4px;">
                                <option value="">בחר קטגוריה</option>
                                ${predefinedCategories.map(cat => `<option value="${cat}" ${video.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                            </select>
                        </div>
                        
                        ${video.description ? `
                        <div class="mobile-field">
                            <span class="mobile-field-label">📝 תיאור</span>
                            <div class="mobile-editable" contenteditable="true" data-field="description" data-index="${index}">${video.description}</div>
                        </div>
                        ` : ''}
                        
                        ${video.link ? `
                        <div class="mobile-field">
                            <span class="mobile-field-label">🔗 קישור לדרייב</span>
                            <div class="mobile-link-container">
                                <input type="url" class="mobile-input" placeholder="הכנס קישור..." value="${video.link}" data-field="link" data-index="${index}">
                                <button class="mobile-btn" onclick="openLink('${video.link}')" style="background: linear-gradient(135deg, #28a745, #20c997);">פתח</button>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${video.source ? `
                        <div class="mobile-field">
                            <span class="mobile-field-label">📺 קישור מקור</span>
                            <div class="mobile-link-container">
                                <input type="url" class="mobile-input" placeholder="הכנס קישור מקור..." value="${video.source}" data-field="source" data-index="${index}">
                                <button class="mobile-btn" onclick="openLink('${video.source}')" style="background: linear-gradient(135deg, #ff9500, #ff6b00);">פתח</button>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${video.date ? `
                        <div class="mobile-field">
                            <span class="mobile-field-label">📅 תאריך</span>
                            <div class="mobile-editable" contenteditable="true" data-field="date" data-index="${index}">${video.date}</div>
                        </div>
                        ` : ''}
                        
                        ${video.question ? `
                        <div class="mobile-field">
                            <span class="mobile-field-label">❓ שאלה</span>
                            <div class="mobile-editable" contenteditable="true" data-field="question" data-index="${index}" style="font-weight: bold;">${video.question}</div>
                        </div>
                        ` : ''}
                        
                        <div class="mobile-field mobile-approval-field ${approvalClass}">
                            <span class="mobile-field-label">✅ האם אושר?</span>
                            <select class="mobile-select" data-field="approvalStatus" data-index="${index}">
                                <option value="pending" ${video.approvalStatus === 'pending' || !video.approvalStatus ? 'selected' : ''}>בטיפול</option>
                                <option value="approved" ${video.approvalStatus === 'approved' ? 'selected' : ''}>מאושר</option>
                                <option value="not-approved" ${video.approvalStatus === 'not-approved' ? 'selected' : ''}>לא מאושר</option>
                            </select>
                        </div>
                        
                        <div class="mobile-field">
                            <span class="mobile-field-label">📺 תוכנית</span>
                            <select class="mobile-select" data-field="program" data-index="${index}">
                                <option value="unassigned" ${(video.program === 'unassigned' || video.program === '') ? 'selected' : ''}>לא שובץ</option>
                                ${Array.from({length: 25}, (_, i) => `<option value="${i + 1}" ${video.program == (i + 1) ? 'selected' : ''}>פרק ${i + 1}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div class="mobile-field">
                            <span class="mobile-field-label">📅 נוסף בתאריך</span>
                            <div style="font-size: 10px; color: #999;">${createdDateStr} ${createdTimeStr}</div>
                        </div>
                        
                        ${lastModified ? `
                        <div class="mobile-field">
                            <span class="mobile-field-label">🕒 עדכון אחרון</span>
                            <div style="font-size: 10px; color: #999;">${lastModified}</div>
                        </div>
                        ` : ''}
                    </div>
                `;

                mobileCards.appendChild(card);
            });

            // הוספת אירועי עריכה לתצוגת שולחן העבודה
            addEditEventListeners();
            
            // הוספת אירועי עריכה לתצוגת נייד
            addMobileEditEventListeners();
            
            // הוספת הגבלות קלט
            addInputValidation();
        }

        // פונקציה לעדכון קטגוריה מה-select
        async function updateCategoryFromSelect(index) {
            const selectElement = document.querySelector(`[data-index="${index}"][data-field="category"]`);
            const value = selectElement.value;
            const oldValue = filteredData[index] ? filteredData[index].category : '';
            
            if (filteredData[index] && oldValue !== value) {
                filteredData[index].category = value;
                // עדכון המערך המקורי
                const originalIndex = videoData.findIndex(v => v === filteredData[index]);
                if (originalIndex !== -1) {
                    videoData[originalIndex].category = value;
                    videoData[originalIndex].lastModified = new Date().toISOString();
                    videoData[originalIndex].modifiedBy = 'משתמש';
                    
                    // הוספה להיסטוריה
                    addToHistory('edit', originalIndex, 'category', oldValue, value);
                }
                
                // עדכון התצוגה
                const displayElement = selectElement.parentElement.querySelector('.category-display');
                displayElement.textContent = value || 'בחר קטגוריה';
                displayElement.classList.toggle('empty', !value);
                
                updateStats();
                await saveData(); // שמירה אוטומטית
                populateCategoryFilter();
            }
        }

        // פונקציות לטיפול בקטגוריות במובייל
        function toggleMobileCategoryEdit(index, element) {
            const parent = element.parentElement;
            const selectElement = parent.querySelector('.mobile-select');
            
            element.style.display = 'none';
            selectElement.style.display = 'block';
            selectElement.focus();
        }

        async function updateMobileCategoryFromSelect(index) {
            const selectElement = document.querySelector(`#mobileCards [data-index="${index}"][data-field="category"]`);
            const displayElement = selectElement.parentElement.querySelector('.mobile-category-display');
            const value = selectElement.value;
            const oldValue = filteredData[index] ? filteredData[index].category : '';
            
            if (filteredData[index] && oldValue !== value) {
                filteredData[index].category = value;
                // עדכון המערך המקורי
                const originalIndex = videoData.findIndex(v => v === filteredData[index]);
                if (originalIndex !== -1) {
                    videoData[originalIndex].category = value;
                    videoData[originalIndex].lastModified = new Date().toISOString();
                    videoData[originalIndex].modifiedBy = 'משתמש';
                    
                    // הוספה להיסטוריה
                    addToHistory('edit', originalIndex, 'category', oldValue, value);
                }
                
                updateStats();
                await saveData(); // שמירה אוטומטית
                populateCategoryFilter();
            }
            
            // עדכון התצוגה
            displayElement.textContent = value || 'בחר קטגוריה';
            displayElement.classList.toggle('empty', !value);
            selectElement.style.display = 'none';
            displayElement.style.display = 'block';
        }

        // פונקציה להוספת אירועי עריכה לקרטיסים נידים
        function addMobileEditEventListeners() {
            // אירועים לתאים הניתנים לעריכה במובייל
            document.querySelectorAll('#mobileCards .mobile-editable').forEach(element => {
                element.addEventListener('blur', async function() {
                    const index = parseInt(this.dataset.index);
                    const field = this.dataset.field;
                    let value = this.textContent.trim();
                    
                    // שמירת הערך הישן להיסטוריה
                    const oldValue = filteredData[index] ? filteredData[index][field] : '';
                    
                    if (filteredData[index] && oldValue !== value) {
                        filteredData[index][field] = value;
                        // עדכון המערך המקורי
                        const originalIndex = videoData.findIndex(v => v === filteredData[index]);
                        if (originalIndex !== -1) {
                            videoData[originalIndex][field] = value;
                            videoData[originalIndex].lastModified = new Date().toISOString();
                            videoData[originalIndex].modifiedBy = 'משתמש';
                            
                            // הוספה להיסטוריה
                            addToHistory('edit', originalIndex, field, oldValue, value);
                        }
                        updateStats();
                        await saveData(); // שמירה אוטומטית
                    }
                });
            });

            // אירועים לקישורים במובייל (כולל מקור)
            document.querySelectorAll('#mobileCards .mobile-input[data-field="link"], #mobileCards .mobile-input[data-field="source"]').forEach(element => {
                element.addEventListener('change', async function() {
                    const index = parseInt(this.dataset.index);
                    const field = this.dataset.field;
                    const value = this.value.trim();
                    const oldValue = filteredData[index] ? filteredData[index][field] : '';
                    
                    if (filteredData[index] && oldValue !== value) {
                        filteredData[index][field] = value;
                        // עדכון המערך המקורי
                        const originalIndex = videoData.findIndex(v => v === filteredData[index]);
                        if (originalIndex !== -1) {
                            videoData[originalIndex][field] = value;
                            videoData[originalIndex].lastModified = new Date().toISOString();
                            videoData[originalIndex].modifiedBy = 'משתמש';
                            
                            // הוספה להיסטוריה
                            addToHistory('edit', originalIndex, field, oldValue, value);
                        }
                        await saveData(); // שמירה אוטומטית
                        
                        // עדכון הטבלה כדי להציג/להסתיר כפתור "פתח"
                        populateTable(filteredData);
                    }
                });
            });

            // אירועים לתפריטי תוכניות וסטטוס אישור במובייל (הקטגוריות מטופלות בנפרד)
            document.querySelectorAll('#mobileCards .mobile-select[data-field="program"], #mobileCards .mobile-select[data-field="approvalStatus"]').forEach(element => {
                element.addEventListener('change', async function() {
                    const index = parseInt(this.dataset.index);
                    const field = this.dataset.field;
                    const value = this.value;
                    const oldValue = filteredData[index] ? filteredData[index][field] : '';
                    
                    if (filteredData[index] && oldValue !== value) {
                        filteredData[index][field] = value;
                        // עדכון המערך המקורי
                        const originalIndex = videoData.findIndex(v => v === filteredData[index]);
                        if (originalIndex !== -1) {
                            videoData[originalIndex][field] = value;
                            videoData[originalIndex].lastModified = new Date().toISOString();
                            videoData[originalIndex].modifiedBy = 'משתמש';
                            
                            // הוספה להיסטוריה
                            addToHistory('edit', originalIndex, field, oldValue, value);
                        }
                        updateStats();
                        await saveData(); // שמירה אוטומטית
                        
                        // עדכון צבע הרקע אם זה שדה סטטוס אישור
                        if (field === 'approvalStatus') {
                            const mobileField = this.closest('.mobile-approval-field');
                            if (mobileField) {
                                mobileField.classList.remove('approved', 'not-approved', 'pending');
                                mobileField.classList.add(value);
                            }
                        }
                    }
                });
            });

            // טיפול בבחירה במובייל
            document.querySelectorAll('#mobileCards .mobile-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    // סנכרון עם הטבלה הרגילה
                    const desktopCheckbox = document.querySelectorAll('.row-checkbox')[Array.from(document.querySelectorAll('#mobileCards .mobile-checkbox')).indexOf(this)];
                    if (desktopCheckbox) {
                        desktopCheckbox.checked = this.checked;
                    }
                });
            });
        }

        async function refreshData() {
            try {
                showSaveIndicator('🔄 רוענן...');
                const success = await loadData();
                if (success) {
                    populateCategoryFilter();
                    filterData();
                    updateStats();
                    showSaveIndicator('✅ רועננו!');
                } else {
                    showSaveIndicator('⚠️ אין עדכונים');
                }
            } catch (e) {
                showSaveIndicator('❌ שגיאה ברענון');
            }
        }

        function addEditEventListeners() {
            // אירועים לתאים הניתנים לעריכה
            document.querySelectorAll('.editable').forEach(element => {
                element.addEventListener('blur', async function() {
                    const index = parseInt(this.dataset.index);
                    const field = this.dataset.field;
                    let value = this.textContent.trim();
                    
                    // שמירת הערך הישן להיסטוריה
                    const oldValue = filteredData[index] ? filteredData[index][field] : '';
                    
                    // ולידציה מיוחדת לשדה המספר
                    if (field === 'number') {
                        // הסרת תווים שאינם מספרים
                        value = value.replace(/[^\d]/g, '');
                        // עדכון התצוגה אם היה שינוי
                        if (value !== this.textContent.trim()) {
                            this.textContent = value;
                        }
                    }
                    
                    if (filteredData[index] && oldValue !== value) {
                        filteredData[index][field] = value;
                        // עדכון המערך המקורי
                        const originalIndex = videoData.findIndex(v => v === filteredData[index]);
                        if (originalIndex !== -1) {
                            videoData[originalIndex][field] = value;
                            videoData[originalIndex].lastModified = new Date().toISOString();
                            videoData[originalIndex].modifiedBy = 'משתמש';
                            
                            // הוספה להיסטוריה
                            addToHistory('edit', originalIndex, field, oldValue, value);
                        }
                        updateStats();
                        await saveData(); // שמירה אוטומטית
                    }
                });

                // ולידציה בזמן אמת למספרים
                if (element.classList.contains('number-edit')) {
                    element.addEventListener('input', function() {
                        // הסרת תווים שאינם מספרים בזמן הקלדה
                        const cursorPosition = window.getSelection().getRangeAt(0).startOffset;
                        const cleanValue = this.textContent.replace(/[^\d]/g, '');
                        if (cleanValue !== this.textContent) {
                            this.textContent = cleanValue;
                            // החזרת המקום של הסמן
                            const range = document.createRange();
                            const selection = window.getSelection();
                            if (this.firstChild) {
                                range.setStart(this.firstChild, Math.min(cursorPosition, cleanValue.length));
                                range.collapse(true);
                                selection.removeAllRanges();
                                selection.addRange(range);
                            }
                        }
                    });
                }
            });

            // אירועים לקישורים (כולל מקור)
            document.querySelectorAll('.link-input').forEach(element => {
                element.addEventListener('change', async function() {
                    const index = parseInt(this.dataset.index);
                    const field = this.dataset.field;
                    const value = this.value.trim();
                    const oldValue = filteredData[index] ? filteredData[index][field] : '';
                    
                    if (filteredData[index] && oldValue !== value) {
                        filteredData[index][field] = value;
                        // עדכון המערך המקורי
                        const originalIndex = videoData.findIndex(v => v === filteredData[index]);
                        if (originalIndex !== -1) {
                            videoData[originalIndex][field] = value;
                            videoData[originalIndex].lastModified = new Date().toISOString();
                            videoData[originalIndex].modifiedBy = 'משתמש';
                            
                            // הוספה להיסטוריה
                            addToHistory('edit', originalIndex, field, oldValue, value);
                        }
                        await saveData(); // שמירה אוטומטית
                        
                        // עדכון הטבלה כדי להציג/להסתיר כפתור "פתח"
                        populateTable(filteredData);
                    }
                });
            });

            // אירועים לתפריטי תוכנית וסטטוס אישור (הקטגוריות מטופלות בנפרד)
            document.querySelectorAll('.program-select, .approval-select').forEach(element => {
                element.addEventListener('change', async function() {
                    const index = parseInt(this.dataset.index);
                    const field = this.dataset.field;
                    const value = this.value;
                    const oldValue = filteredData[index] ? filteredData[index][field] : '';
                    
                    if (filteredData[index] && oldValue !== value) {
                        filteredData[index][field] = value;
                        // עדכון המערך המקורי
                        const originalIndex = videoData.findIndex(v => v === filteredData[index]);
                        if (originalIndex !== -1) {
                            videoData[originalIndex][field] = value;
                            videoData[originalIndex].lastModified = new Date().toISOString();
                            videoData[originalIndex].modifiedBy = 'משתמש';
                            
                            // הוספה להיסטוריה
                            addToHistory('edit', originalIndex, field, oldValue, value);
                        }
                        updateStats();
                        await saveData(); // שמירה אוטומטית
                        
                        // עדכון צבע הרקע אם זה שדה סטטוס אישור
                        if (field === 'approvalStatus') {
                            const td = this.closest('td');
                            if (td) {
                                td.classList.remove('approved', 'not-approved', 'pending');
                                td.classList.add(value);
                            }
                        }
                    }
                });
            });
        }

        function populateCategoryFilter() {
            const categoryFilter = document.getElementById('categoryFilter');
            // ניקוי האפשרויות הקיימות (מלבד "כל הקטגוריות")
            categoryFilter.innerHTML = '<option value="">כל הקטגוריות</option>';
            
            const categories = [...new Set(videoData.map(video => video.category))].sort();
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category.replace(':', '');
                categoryFilter.appendChild(option);
            });
        }

        function updateStats() {
            const stats = document.getElementById('stats');
            const totalVideos = filteredData.length;
            const totalCategories = new Set(filteredData.map(video => video.category)).size;
            const markedVideos = filteredData.filter(video => video.marked).length;
            const videosWithNumbers = filteredData.filter(video => video.number).length;
            const videosWithLinks = filteredData.filter(video => video.link && video.link.trim()).length;
            const videosWithDescriptions = filteredData.filter(video => video.description && video.description.trim()).length;
            const videosWithPrograms = filteredData.filter(video => video.program && video.program.trim() && video.program !== 'unassigned').length;
            const unassignedPrograms = filteredData.filter(video => video.program === 'unassigned' || !video.program || !video.program.trim()).length;
            const approvedVideos = filteredData.filter(video => video.approvalStatus === 'approved').length;
            const pendingVideos = filteredData.filter(video => video.approvalStatus === 'pending' || !video.approvalStatus).length;
            const notApprovedVideos = filteredData.filter(video => video.approvalStatus === 'not-approved').length;
            const archivedCount = videoData.filter(video => video.archived).length;
            const activeCount = videoData.filter(video => !video.archived).length;
            
            const statusText = showArchived ? `📦 מציג ארכיון (${archivedCount})` : `📋 מציג פעיל (${activeCount})`;
            
            // סטטוס Firebase
            const cloudStatus = '🔥 Firebase - זמן אמת';
            
            stats.textContent = `${cloudStatus} | ${statusText} | 📊 ${totalVideos} סרטונים | ${totalCategories} קטגוריות | ${videosWithPrograms} שובצו לפרקים | ${unassignedPrograms} לא שובצו | ✅ ${approvedVideos} מאושרים | ⏳ ${pendingVideos} בטיפול | ❌ ${notApprovedVideos} לא מאושרים | ${markedVideos} מסומנים | ${videosWithNumbers} עם מספרים | ${videosWithLinks} עם קישורים | ${videosWithDescriptions} עם תיאורים | 🗑️ סל מחזור: ${deletedItems.length}`;
        }

        // פונקציית סינון משופרת עם תמיכה ב-Multi-Select
        function filterData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const selectedCategory = document.getElementById('categoryFilter').value;

            filteredData = videoData.filter(video => {
                const matchesSearch = video.title.toLowerCase().includes(searchTerm) || 
                                    (video.number && video.number.toString().includes(searchTerm)) ||
                                    video.category.toLowerCase().includes(searchTerm) ||
                                    (video.description && video.description.toLowerCase().includes(searchTerm)) ||
                                    (video.question && video.question.toLowerCase().includes(searchTerm)) ||
                                    (video.source && video.source.toLowerCase().includes(searchTerm)) ||
                                    (video.date && video.date.includes(searchTerm));
                const matchesCategory = !selectedCategory || video.category === selectedCategory;
                
                // טיפול משופר בפילטר תוכנית עם תמיכה ב-Multi-Select
                let matchesProgram = true;
                if (selectedPrograms.length > 0 && !selectedPrograms.includes('')) {
                    matchesProgram = false;
                    
                    // בדיקה אם הסרטון שייך לאחת מהתוכניות הנבחרות
                    for (const selectedProgram of selectedPrograms) {
                        if (selectedProgram === 'unassigned') {
                            if (video.program === 'unassigned' || !video.program || video.program.trim() === '') {
                                matchesProgram = true;
                                break;
                            }
                        } else {
                            if (video.program === selectedProgram) {
                                matchesProgram = true;
                                break;
                            }
                        }
                    }
                }
                
                // טיפול בפילטר סטטוס אישור עם תמיכה ב-Multi-Select
                let matchesApproval = true;
                if (selectedApprovals.length > 0 && !selectedApprovals.includes('')) {
                    matchesApproval = false;
                    
                    // בדיקה אם הסרטון שייך לאחד מהסטטוסים הנבחרים
                    const videoApprovalStatus = video.approvalStatus || 'pending';
                    matchesApproval = selectedApprovals.includes(videoApprovalStatus);
                }
                
                const matchesArchiveStatus = video.archived === showArchived;
                
                return matchesSearch && matchesCategory && matchesProgram && matchesApproval && matchesArchiveStatus;
            });

            // אם יש סידור פעיל, החל אותו על הנתונים המסוננים
            if (currentSortDirection !== 'none' && currentSortField) {
                filteredData.sort((a, b) => {
                    let valueA, valueB;
                    
                    switch (currentSortField) {
                        case 'number':
                            // סידור מספרי מיוחד
                            valueA = parseInt(a.number) || 0;
                            valueB = parseInt(b.number) || 0;
                            break;
                        case 'category':
                            valueA = a.category.toLowerCase();
                            valueB = b.category.toLowerCase();
                            break;
                        case 'createdAt':
                            valueA = a.createdAt || '0000-00-00';
                            valueB = b.createdAt || '0000-00-00';
                            break;
                        case 'program':
                            // תמיכה ב"לא שובץ" וערכים מספריים
                            if (a.program === 'unassigned' || a.program === '') valueA = -1;
                            else valueA = parseInt(a.program) || 0;
                            
                            if (b.program === 'unassigned' || b.program === '') valueB = -1;
                            else valueB = parseInt(b.program) || 0;
                            break;
                        case 'approvalStatus':
                            // סידור לפי סטטוס אישור
                            const order = { 'approved': 1, 'pending': 2, 'not-approved': 3 };
                            valueA = order[a.approvalStatus] || 2;
                            valueB = order[b.approvalStatus] || 2;
                            break;
                        default:
                            return 0;
                    }
                    
                    let comparison = 0;
                    if (valueA < valueB) {
                        comparison = -1;
                    } else if (valueA > valueB) {
                        comparison = 1;
                    }
                    
                    return currentSortDirection === 'asc' ? comparison : -comparison;
                });
            }

            // ניקוי בחירות כשמסננים את הנתונים
            clearSelection();

            populateTable(filteredData);
            updateStats();
        }

        // ===== פונקציות חדשות לטיפול בפילטר תוכניות ידידותי =====
        
        // פתיחה/סגירה של פילטר התוכניות
        function toggleProgramFilter() {
            const dropdown = document.getElementById('programFilterDropdown');
            const display = document.getElementById('programFilterDisplay');
            const arrow = document.getElementById('programFilterArrow');
            
            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
                display.classList.remove('active');
                arrow.classList.remove('rotated');
            } else {
                dropdown.classList.add('show');
                display.classList.add('active');
                arrow.classList.add('rotated');
            }
        }
        
        // טיפול בבחירת אפשרות בפילטר תוכניות
        function toggleProgramOption(value, checkbox) {
            if (value === '') {
                // אם נבחר "כל התוכניות" - נקה את כל הבחירות האחרות
                if (checkbox.checked) {
                    selectedPrograms = [''];
                    // נקה את כל השאר
                    document.querySelectorAll('#programFilterDropdown input[type="checkbox"]').forEach(cb => {
                        if (cb.id !== 'program-all') {
                            cb.checked = false;
                            cb.parentElement.classList.remove('selected');
                        } else {
                            cb.parentElement.classList.add('selected');
                        }
                    });
                } else {
                    selectedPrograms = [];
                    checkbox.parentElement.classList.remove('selected');
                }
            } else {
                // בחירת תוכנית ספציפית
                if (checkbox.checked) {
                    // אם זה לא "כל התוכניות", הסר אותו מהבחירה
                    selectedPrograms = selectedPrograms.filter(p => p !== '');
                    // הסר את הסימון מ"כל התוכניות"
                    const allCheckbox = document.getElementById('program-all');
                    allCheckbox.checked = false;
                    allCheckbox.parentElement.classList.remove('selected');
                    
                    // הוסף את הבחירה החדשה
                    if (!selectedPrograms.includes(value)) {
                        selectedPrograms.push(value);
                    }
                    checkbox.parentElement.classList.add('selected');
                } else {
                    // הסר את הבחירה
                    selectedPrograms = selectedPrograms.filter(p => p !== value);
                    checkbox.parentElement.classList.remove('selected');
                    
                    // אם לא נשאר כלום נבחר, סמן "כל התוכניות"
                    if (selectedPrograms.length === 0) {
                        selectedPrograms = [''];
                        const allCheckbox = document.getElementById('program-all');
                        allCheckbox.checked = true;
                        allCheckbox.parentElement.classList.add('selected');
                    }
                }
            }
            
            // עדכון הטקסט המוצג
            updateProgramFilterDisplay();
            
            // הפעלת הסינון
            filterData();
        }
        
        // עדכון הטקסט המוצג בפילטר תוכניות
        function updateProgramFilterDisplay() {
            const textElement = document.getElementById('programFilterText');
            
            if (selectedPrograms.length === 0 || selectedPrograms.includes('')) {
                textElement.textContent = 'כל התוכניות';
            } else if (selectedPrograms.length === 1) {
                if (selectedPrograms[0] === 'unassigned') {
                    textElement.textContent = 'לא שובץ';
                } else {
                    textElement.textContent = `פרק ${selectedPrograms[0]}`;
                }
            } else {
                textElement.textContent = `${selectedPrograms.length} תוכניות נבחרו`;
            }
        }
        
        // סגירת דרופדאונים בלחיצה מחוץ להם
        document.addEventListener('click', function(event) {
            // סגירת פילטר תוכניות
            const programContainer = document.querySelector('.program-filter-container');
            if (programContainer && !programContainer.contains(event.target)) {
                const dropdown = document.getElementById('programFilterDropdown');
                const display = document.getElementById('programFilterDisplay');
                const arrow = document.getElementById('programFilterArrow');
                
                if (dropdown.classList.contains('show')) {
                    dropdown.classList.remove('show');
                    display.classList.remove('active');
                    arrow.classList.remove('rotated');
                }
            }
            
            // סגירת פילטר סטטוס אישור
            const approvalContainer = document.querySelector('.approval-filter-container');
            if (approvalContainer && !approvalContainer.contains(event.target)) {
                const dropdown = document.getElementById('approvalFilterDropdown');
                const display = document.getElementById('approvalFilterDisplay');
                const arrow = document.getElementById('approvalFilterArrow');
                
                if (dropdown.classList.contains('show')) {
                    dropdown.classList.remove('show');
                    display.classList.remove('active');
                    arrow.classList.remove('rotated');
                }
            }
        });

        function toggleArchive() {
            showArchived = !showArchived;
            const toggleBtn = document.getElementById('archiveToggle');
            if (showArchived) {
                toggleBtn.textContent = '📋 הצג רגיל';
                toggleBtn.style.background = 'linear-gradient(135deg, #ffc107, #ff8b00)';
            } else {
                toggleBtn.textContent = '📦 הצג ארכיון';
                toggleBtn.style.background = 'linear-gradient(135deg, #17a2b8, #138496)';
            }
            clearSelection(); // ניקוי בחירות בעת החלפת תצוגה
            filterData();
            updateBulkActionsDisplay(); // עדכון כפתורי הפעולות המרובות
        }

        async function addNewRow() {
            const now = new Date().toISOString();
            const newVideo = {
                number: "",
                category: "שונות", // ברירת מחדל לשונות במקום אוכל
                title: "סרטון חדש",
                description: "",
                marked: false,
                link: "",
                source: "",
                date: "",
                question: "",
                program: "unassigned", // ברירת מחדל ל"לא שובץ"
                approvalStatus: "pending", // ברירת מחדל ל"בטיפול"
                archived: false,
                createdAt: now,
                lastModified: now,
                modifiedBy: 'משתמש'
            };
            
            videoData.unshift(newVideo); // הוספה למעלה במקום למטה
            const newIndex = 0; // האינדקס החדש הוא 0
            addToHistory('create', newIndex, 'video', '', 'נוצר סרטון חדש');
            
            await saveData();
            filterData(); // רענון הטבלה
        }

        async function archiveRow(index) {
            if (confirm('האם אתה בטוח שברצונך להעביר את הסרטון הזה לארכיון?')) {
                const videoToArchive = filteredData[index];
                const originalIndex = videoData.findIndex(v => v === videoToArchive);
                if (originalIndex !== -1) {
                    addToHistory('archive', originalIndex, 'status', 'פעיל', 'ארכיון');
                    videoData[originalIndex].archived = true;
                    videoData[originalIndex].lastModified = new Date().toISOString();
                    videoData[originalIndex].modifiedBy = 'משתמש';
                    await saveData();
                }
                filterData(); // רענון הטבלה
            }
        }

        async function restoreFromArchive(index) {
            if (confirm('האם אתה בטוח שברצונך להחזיר את הסרטון הזה מהארכיון?')) {
                const videoToRestore = filteredData[index];
                const originalIndex = videoData.findIndex(v => v === videoToRestore);
                if (originalIndex !== -1) {
                    addToHistory('restore', originalIndex, 'status', 'ארכיון', 'פעיל');
                    videoData[originalIndex].archived = false;
                    videoData[originalIndex].lastModified = new Date().toISOString();
                    videoData[originalIndex].modifiedBy = 'משתמש';
                    await saveData();
                }
                filterData(); // רענון הטבלה
            }
        }

        // פונקציה חדשה להעברה לסל מחזור
        async function moveToRecycleBin(index) {
            if (confirm('האם אתה בטוח שברצונך למחוק את הסרטון הזה?')) {
                const videoToDelete = filteredData[index];
                const originalIndex = videoData.findIndex(v => v === videoToDelete);
                if (originalIndex !== -1) {
                    // הוספה לסל המחזור
                    deletedItems.push({
                        video: {...videoToDelete},
                        deletedAt: new Date().toISOString()
                    });
                    
                    addToHistory('move_to_recycle', originalIndex, 'video', videoToDelete.title, 'הועבר למחזור');
                    videoData.splice(originalIndex, 1);
                    
                    await saveData();
                    await saveDeletedItems();
                    updateRecycleBinCounter();
                }
                filterData(); // רענון הטבלה
                showSaveIndicator('✅ הסרטון הועבר לסל המחזור!');
            }
        }

        // שמירה על הפונקציה הישנה למחיקה קבוצתית
        async function deleteRow(index) {
            // פונקציה זו מועברת למחיקה לצמיתות
            if (confirm('האם אתה בטוח שברצונך למחוק את הסרטון הזה לצמיתות?')) {
                const videoToDelete = filteredData[index];
                const originalIndex = videoData.findIndex(v => v === videoToDelete);
                if (originalIndex !== -1) {
                    addToHistory('delete', originalIndex, 'video', videoToDelete.title, 'נמחק');
                    videoData.splice(originalIndex, 1);
                    await saveData();
                }
                filterData(); // רענון הטבלה
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(videoData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `סרטונים_מעודכן_${new Date().toLocaleDateString('he-IL')}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // וידוא שזו מערך תקין
                    if (Array.isArray(importedData) && importedData.length > 0) {
                        if (confirm(`האם אתה בטוח שברצונך לטעון ${importedData.length} סרטונים? זה יחליף את כל הנתונים הנוכחיים!`)) {
                            videoData = importedData;
                            
                            // עדכון רשימות הקטגוריות מהנתונים המיובאים
                            const importedCategories = [...new Set(videoData.map(v => v.category).filter(c => c))];
                            
                            // הוספת קטגוריות חדשות שלא קיימות
                            importedCategories.forEach(cat => {
                                if (!predefinedCategories.includes(cat)) {
                                    predefinedCategories.push(cat);
                                }
                            });
                            
                            // סידור ושמירה
                            predefinedCategories.sort();
                            saveCategoriesAndCorners();
                            videoData.forEach(video => {
                                if (!video.hasOwnProperty('program')) video.program = "unassigned";
                                if (!video.hasOwnProperty('archived')) video.archived = false;
                                if (!video.hasOwnProperty('createdAt')) video.createdAt = new Date().toISOString();
                                if (!video.hasOwnProperty('lastModified')) video.lastModified = new Date().toISOString();
                                if (!video.hasOwnProperty('modifiedBy')) video.modifiedBy = 'מערכת';
                                if (!video.hasOwnProperty('source')) video.source = "";
                                if (!video.hasOwnProperty('date')) video.date = "";
                                if (!video.hasOwnProperty('approvalStatus')) video.approvalStatus = "pending";
                            });
                            
                            filteredData = [...videoData];
                            
                            // שמירה ועדכון הממשק
                            await saveData();
                            populateCategoryFilter();
                            populateTable(filteredData);
                            updateStats();
                            
                            // הודעת הצלחה
                            showImportSuccess(importedData.length);
                        }
                    } else {
                        alert('שגיאה: הקובץ לא מכיל נתונים תקינים של סרטונים');
                    }
                } catch (error) {
                    alert('שגיאה בקריאת הקובץ: ' + error.message);
                }
            };
            
            reader.readAsText(file);
            // איפוס הקלט כדי לאפשר טעינה של אותו קובץ שוב
            event.target.value = '';
        }

        function showImportSuccess(count) {
            const indicator = document.getElementById('saveIndicator');
            indicator.textContent = `✅ נטענו ${count} סרטונים!`;
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
                indicator.textContent = '✅ נשמר!';
            }, 3000);
        }

        function clearData() {
            if (confirm('האם אתה בטוח שברצונך למחוק את כל הנתונים? פעולה זו לא ניתנת לביטול!')) {
                localStorage.removeItem('videoManagerData');
                location.reload(); // טעינה מחדש של הדף
            }
        }

        // ===== פונקציות בחירה מרובה =====
        function toggleRowSelection(index) {
            if (selectedItems.has(index)) {
                selectedItems.delete(index);
            } else {
                selectedItems.add(index);
            }
            
            // סנכרון בין תצוגת הטבלה לתצוגת הקרטיסים
            const desktopCheckbox = document.querySelectorAll('.row-checkbox')[index];
            const mobileCheckbox = document.querySelectorAll('.mobile-checkbox')[index];
            const isSelected = selectedItems.has(index);
            
            if (desktopCheckbox) desktopCheckbox.checked = isSelected;
            if (mobileCheckbox) mobileCheckbox.checked = isSelected;
            
            updateBulkActionsDisplay();
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const rowCheckboxes = document.querySelectorAll('.row-checkbox');
            const mobileCheckboxes = document.querySelectorAll('.mobile-checkbox');
            
            if (selectAllCheckbox.checked) {
                // בחר הכל
                selectedItems.clear();
                rowCheckboxes.forEach((checkbox, index) => {
                    checkbox.checked = true;
                    selectedItems.add(index);
                });
                mobileCheckboxes.forEach((checkbox, index) => {
                    checkbox.checked = true;
                });
            } else {
                // בטל בחירה מהכל
                selectedItems.clear();
                rowCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                mobileCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
            }
            updateBulkActionsDisplay();
        }

        function clearSelection() {
            selectedItems.clear();
            document.getElementById('selectAll').checked = false;
            document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.querySelectorAll('.mobile-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateBulkActionsDisplay();
        }

        function updateBulkActionsDisplay() {
            const bulkActions = document.getElementById('bulkActions');
            const selectedCount = document.getElementById('selectedCount');
            const archiveBtn = document.getElementById('bulkArchiveBtn');
            const restoreBtn = document.getElementById('bulkRestoreBtn');
            
            selectedCount.textContent = selectedItems.size;
            
            if (selectedItems.size > 0) {
                bulkActions.classList.add('show');
                
                // הצג/הסתר כפתורים בהתאם למצב
                if (showArchived) {
                    // במצב ארכיון - הצג כפתור החזרה, הסתר כפתור ארכיון
                    archiveBtn.style.display = 'none';
                    restoreBtn.style.display = 'inline-block';
                } else {
                    // במצב רגיל - הצג כפתור ארכיון, הסתר כפתור החזרה
                    archiveBtn.style.display = 'inline-block';
                    restoreBtn.style.display = 'none';
                }
            } else {
                bulkActions.classList.remove('show');
            }
        }

        async function bulkArchive() {
            if (selectedItems.size === 0) return;
            
            if (confirm(`האם אתה בטוח שברצונך להעביר ${selectedItems.size} סרטונים לארכיון?`)) {
                const indicesToArchive = Array.from(selectedItems).sort((a, b) => b - a);
                
                for (const index of indicesToArchive) {
                    const videoToArchive = filteredData[index];
                    const originalIndex = videoData.findIndex(v => v === videoToArchive);
                    if (originalIndex !== -1) {
                        addToHistory('archive', originalIndex, 'status', 'פעיל', 'ארכיון');
                        videoData[originalIndex].archived = true;
                        videoData[originalIndex].lastModified = new Date().toISOString();
                    }
                }
                
                await saveData();
                clearSelection();
                filterData();
                showSaveIndicator(`✅ ${indicesToArchive.length} סרטונים הועברו לארכיון!`);
            }
        }

        async function bulkRestore() {
            if (selectedItems.size === 0) return;
            
            if (confirm(`האם אתה בטוח שברצונך להחזיר ${selectedItems.size} סרטונים מהארכיון?`)) {
                const indicesToRestore = Array.from(selectedItems).sort((a, b) => b - a);
                
                for (const index of indicesToRestore) {
                    const videoToRestore = filteredData[index];
                    const originalIndex = videoData.findIndex(v => v === videoToRestore);
                    if (originalIndex !== -1) {
                        addToHistory('restore', originalIndex, 'status', 'ארכיון', 'פעיל');
                        videoData[originalIndex].archived = false;
                        videoData[originalIndex].lastModified = new Date().toISOString();
                    }
                }
                
                await saveData();
                clearSelection();
                filterData();
                showSaveIndicator(`✅ ${indicesToRestore.length} סרטונים הוחזרו מהארכיון!`);
            }
        }

        async function bulkDelete() {
            if (selectedItems.size === 0) return;
            
            if (confirm(`האם אתה בטוח שברצונך להעביר ${selectedItems.size} סרטונים לסל המחזור?`)) {
                const indicesToDelete = Array.from(selectedItems).sort((a, b) => b - a);
                
                for (const index of indicesToDelete) {
                    const videoToDelete = filteredData[index];
                    const originalIndex = videoData.findIndex(v => v === videoToDelete);
                    if (originalIndex !== -1) {
                        // הוספה לסל המחזור
                        deletedItems.push({
                            video: {...videoToDelete},
                            deletedAt: new Date().toISOString()
                        });
                        
                        addToHistory('move_to_recycle', originalIndex, 'video', videoToDelete.title, 'הועבר למחזור');
                        videoData.splice(originalIndex, 1);
                    }
                }
                
                await saveData();
                await saveDeletedItems();
                updateRecycleBinCounter();
                clearSelection();
                filterData();
                showSaveIndicator(`✅ ${indicesToDelete.length} סרטונים הועברו לסל המחזור!`);
            }
        }

        // ===== פונקציות ניהול קטגוריות =====
        
        // טעינת קטגוריות מ-localStorage
        function loadCategoriesAndCorners() {
            try {
                const savedCategories = localStorage.getItem('predefinedCategories');
                if (savedCategories) {
                    predefinedCategories = JSON.parse(savedCategories);
                }
            } catch (e) {
                console.error('שגיאה בטעינת קטגוריות:', e);
            }
        }
        
        // שמירת קטגוריות ל-localStorage
        function saveCategoriesAndCorners() {
            try {
                localStorage.setItem('predefinedCategories', JSON.stringify(predefinedCategories));
            } catch (e) {
                console.error('שגיאה בשמירת קטגוריות:', e);
            }
        }
        
        // פתיחת מודאל ניהול קטגוריות
        function showCategoryManager() {
            const modal = document.getElementById('categoryModal');
            populateCategoriesList();
            modal.style.display = 'flex';
        }
        
        // סגירת מודאל ניהול קטגוריות
        function closeCategoryManager() {
            const modal = document.getElementById('categoryModal');
            modal.style.display = 'none';
            document.getElementById('newCategoryInput').value = '';
        }
        
        // מילוי רשימת הקטגוריות במודאל
        function populateCategoriesList() {
            const list = document.getElementById('categoriesList');
            list.innerHTML = '';
            
            predefinedCategories.forEach((category, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="item-text" contenteditable="true" data-type="category" data-index="${index}" onblur="updateItemName(this)" title="לחץ לעריכה">${category}</span>
                    <button class="item-delete" onclick="deleteCategory(${index})" title="מחק קטגוריה">✖</button>
                `;
                list.appendChild(li);
            });
        }
        
        // פונקציה לעדכון שם קטגוריה
        async function updateItemName(element) {
            const type = element.dataset.type;
            const index = parseInt(element.dataset.index);
            const newName = sanitizeInput(element.textContent.trim()); // הוספת הגבלת קלט
            
            if (!newName) {
                // אם השם ריק, החזר לשם המקורי
                if (type === 'category') {
                    element.textContent = predefinedCategories[index];
                }
                return;
            }
            
            let oldName, targetArray, updateFunction;
            
            if (type === 'category') {
                oldName = predefinedCategories[index];
                targetArray = predefinedCategories;
                updateFunction = populateCategoryFilter;
            } else {
                return;
            }
            
            // בדיקה אם השם כבר קיים (למניעת כפילויות)
            if (targetArray.includes(newName) && newName !== oldName) {
                alert(`השם "${newName}" כבר קיים!`);
                element.textContent = oldName;
                return;
            }
            
            // עדכון השם אם השתנה
            if (newName !== oldName) {
                // עדכון המערך
                targetArray[index] = newName;
                targetArray.sort(); // סידור מחדש
                
                // עדכון כל הסרטונים שמשתמשים בשם הישן
                videoData.forEach(video => {
                    if (type === 'category' && video.category === oldName) {
                        video.category = newName;
                        video.lastModified = new Date().toISOString();
                        video.modifiedBy = 'משתמש';
                    }
                });
                
                // שמירת השינויים
                saveCategoriesAndCorners();
                await saveData();
                
                // עדכון הממשק
                updateFunction();
                populateTable(filteredData);
                updateStats();
                
                // עדכון הרשימה במודאל
                if (type === 'category') {
                    populateCategoriesList();
                }
                
                showSaveIndicator(`✅ עודכן "${oldName}" ל"${newName}"!`);
            }
        }
        
        // הוספת קטגוריה חדשה
        function addNewCategory() {
            const input = document.getElementById('newCategoryInput');
            const newCategory = sanitizeInput(input.value.trim()); // הוספת הגבלת קלט
            
            if (newCategory && !predefinedCategories.includes(newCategory)) {
                predefinedCategories.push(newCategory);
                predefinedCategories.sort(); // סידור אלפביתי
                saveCategoriesAndCorners();
                populateCategoriesList();
                populateCategoryFilter();
                // עדכון הטבלה כדי לכלול את הקטגוריה החדשה
                populateTable(filteredData);
                input.value = '';
                showSaveIndicator('✅ קטגוריה נוספה!');
            } else if (predefinedCategories.includes(newCategory)) {
                alert('קטגוריה זו כבר קיימת!');
            } else {
                alert('אנא הכנס שם קטגוריה!');
            }
        }
        
        // מחיקת קטגוריה
        function deleteCategory(index) {
            const category = predefinedCategories[index];
            if (confirm(`האם אתה בטוח שברצונך למחוק את הקטגוריה "${category}"?`)) {
                predefinedCategories.splice(index, 1);
                saveCategoriesAndCorners();
                populateCategoriesList();
                populateCategoryFilter();
                // עדכון הטבלה
                populateTable(filteredData);
                showSaveIndicator('✅ קטגוריה נמחקה!');
            }
        }
        
        // סגירת מודאל בלחיצה על הרקע
        window.onclick = function(event) {
            const categoryModal = document.getElementById('categoryModal');
            const wordModal = document.getElementById('wordExportModal');
            const recycleModal = document.getElementById('recycleBinModal');
            
            if (event.target === categoryModal) {
                closeCategoryManager();
            } else if (event.target === wordModal) {
                closeWordExportDialog();
            } else if (event.target === recycleModal) {
                closeRecycleBin();
            }
        };

        function exportToExcel() {
            try {
                showSaveIndicator('📊 יוצר קובץ CSV...');
                
                // הערה: CSV הוא פורמט טקסט פשוט - אין בו שליטה על רוחב עמודות
                // כשאקסל פותח את הקובץ, ייתכן שקישורים ארוכים יסתירו עמודות אחרות
                // ניתן להגדיר רוחב עמודות ידנית באקסל אחרי הפתיחה
                
                // הוספת BOM לתמיכה בעברית
                const BOM = '\uFEFF';
                
                // הכנת הכותרות
                const headers = [
                    'מספר',
                    'קטגוריה',
                    'כותרת הסרטון',
                    'תיאור',
                    'קישור לדרייב',
                    'קישור מקור',
                    'תאריך',
                    'שאלה',
                    'האם אושר?',
                    'תוכנית',
                    'סטטוס',
                    'נוצר',
                    'עודכן',
                    'עודכן על ידי'
                ];
                
                // יצירת תוכן CSV
                let csvContent = BOM + headers.join(',') + '\n';
                
                // הוספת הנתונים
                filteredData.forEach(video => {
                    const row = [
                        video.number || '',
                        video.category || '',
                        video.title || '',
                        video.description || '',
                        video.link || '',
                        video.source || '',
                        video.date || '',
                        video.question || '',
                        getApprovalText(video.approvalStatus),
                        video.program === 'unassigned' || !video.program ? 'לא שובץ' : `פרק ${video.program}`,
                        video.archived ? 'ארכיון' : 'פעיל',
                        video.createdAt ? new Date(video.createdAt).toLocaleString('he-IL') : '',
                        video.lastModified ? new Date(video.lastModified).toLocaleString('he-IL') : '',
                        video.modifiedBy || ''
                    ];
                    
                    // טיפול בערכים עם פסיקים, גרשיים ומעברי שורה
                    const processedRow = row.map(cell => {
                        const cellStr = String(cell);
                        // אם יש פסיק, גרש או מעבר שורה - עטוף בגרשיים
                        if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                            // החלף גרש כפול בשני גרשיים
                            return `"${cellStr.replace(/"/g, '""')}"`;
                        }
                        return cellStr;
                    });
                    
                    csvContent += processedRow.join(',') + '\n';
                });
                
                // יצירת הקובץ
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                
                const statusText = showArchived ? 'ארכיון' : 'פעיל';
                const timestamp = new Date().toISOString().slice(0, 10);
                link.download = `סרטונים_${statusText}_${timestamp}.csv`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showSaveIndicator(`✅ יוצא ל-CSV: ${filteredData.length} סרטונים!`);
                
                // הודעה לגבי רוחב עמודות
                setTimeout(() => {
                    alert('💡 טיפ: אחרי פתיחת הקובץ באקסל, לחץ פעמיים על הגבול בין כותרות העמודות כדי להתאים אוטומטית את הרוחב');
                }, 1000);
                
            } catch (error) {
                console.error('שגיאה בייצוא ל-CSV:', error);
                showSaveIndicator('❌ שגיאה בייצוא ל-CSV');
            }
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', filterData);
        document.getElementById('categoryFilter').addEventListener('change', filterData);

        // Enter key support for modals
        document.getElementById('newCategoryInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addNewCategory();
            }
        });

        // Enter key support for item editing
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.target.classList.contains('item-text')) {
                e.preventDefault();
                e.target.blur(); // יגרום לעדכון השם
            }
        });

        // Initialize
        async function initApp() {
            // אתחול ברירות מחדל לפילטרים
            selectedPrograms = [''];
            selectedApprovals = [''];
            selectedWordExportPrograms = [''];
            
            // עדכון התצוגה הראשונית
            updateProgramFilterDisplay();
            updateApprovalFilterDisplay();
            
            // סימון ברירת המחדל בcheckboxes
            document.getElementById('program-all').checked = true;
            document.getElementById('program-all').parentElement.classList.add('selected');
            document.getElementById('approval-all').checked = true;
            document.getElementById('approval-all').parentElement.classList.add('selected');
            
            // טעינת היסטוריה מהמחשב
            loadHistory();
            
            // טעינת קטגוריות מהמחשב
            loadCategoriesAndCorners();
            
            // טעינת נתונים מהענן
            const dataLoaded = await loadData();
            
            // טעינת פריטים שנמחקו
            await loadDeletedItems();
            
            // אם לא נטענו נתונים מהענן, השתמש בנתונים הבסיסיים
            if (!dataLoaded) {
                videoData.forEach(video => {
                    if (!video.hasOwnProperty('program')) video.program = "unassigned";
                    if (!video.hasOwnProperty('archived')) video.archived = false;
                    if (!video.hasOwnProperty('createdAt')) video.createdAt = new Date().toISOString();
                    if (!video.hasOwnProperty('lastModified')) video.lastModified = new Date().toISOString();
                    if (!video.hasOwnProperty('modifiedBy')) video.modifiedBy = 'מערכת';
                    if (!video.hasOwnProperty('source')) video.source = "";
                    if (!video.hasOwnProperty('date')) video.date = "";
                    if (!video.hasOwnProperty('approvalStatus')) video.approvalStatus = "pending";
                });
                filteredData = [...videoData];
            }
            
            // הפעלת מאזין עדכונים בזמן אמת
            setupRealtimeListener();
            
            populateCategoryFilter();
            populateTable(filteredData);
            updateStats();
            updateSortIndicators(); // אתחול אינדיקטורי הסידור
        }

        // הפעלת האפליקציה
        initApp();
    </script>
</body>
</html>