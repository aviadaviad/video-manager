<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>בונה תסריטים - מה קורה פה?!</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        // פונקציה לפתיחת מנהל הסרטונים בחלון חדש
        function openVideoManager() {
            // פותח את מנהל הסרטונים בחלון חדש
            window.open('https://aviadaviad.github.io/video-manager/', '_blank');
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            padding: 15px 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 12px;
            opacity: 0.9;
            margin: 2px 0;
        }
        
        .main-content {
            display: flex;
            min-height: calc(100vh - 200px);
        }
        
        /* סידבר שמאלי - מאגר סרטונים */
        .sidebar {
            width: 350px;
            background: #f8f9fa;
            border-left: 2px solid #e9ecef;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }
        
        .sidebar-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .sidebar-header h3 {
            font-size: 1.1em;
            margin-bottom: 8px;
        }
        
        /* אזור עבודה מרכזי */
        .workspace {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }
        
        .script-header {
            margin-bottom: 20px;
            padding: 12px;
            background: #e3f2fd;
            border-radius: 8px;
            border: 2px solid #bbdefb;
        }
        
        .script-header h3 {
            margin: 0 0 8px 0;
            font-size: 1em;
        }
        
        .script-header-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .script-header input {
            flex: 1;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
        }
        
        /* קטע מתקפל - פתיחה */
        .collapsible-section {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .collapsible-header {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            padding: 12px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .collapsible-header h3 {
            margin: 0;
            font-size: 1.2em;
        }
        
        .collapse-arrow {
            transition: transform 0.3s ease;
            font-size: 20px;
        }
        
        .collapsible-section.collapsed .collapse-arrow {
            transform: rotate(-90deg);
        }
        
        .collapsible-content {
            padding: 20px;
            max-height: 2000px;
            transition: max-height 0.5s ease, padding 0.5s ease;
            overflow: hidden;
        }
        
        .collapsible-section.collapsed .collapsible-content {
            max-height: 0;
            padding: 0 20px;
        }
        
        /* בחירת מתמודדים */
        .contestants-selection {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .contestants-selection h4 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .contestant-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .contestant-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .contestant-checkbox {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .contestant-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-left: 10px;
            cursor: pointer;
        }
        
        .contestant-checkbox label {
            font-weight: bold;
            cursor: pointer;
            flex: 1;
        }
        
        .contestant-text {
            display: none;
            margin-top: 10px;
        }
        
        .contestant-item.selected .contestant-text {
            display: block;
        }
        
        .contestant-text textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            min-height: 60px;
        }
        
        /* קטע בתסריט (קבוע) */
        .script-section {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .script-section.fixed-section {
            border-color: #bbdefb;
            background: #f0f8ff;
        }
        
        .section-header {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            padding: 12px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-header.round-header {
            background: linear-gradient(135deg, #28a745, #20c997);
            cursor: move;
        }
        
        .section-header h4 {
            margin: 0;
            font-size: 1.1em;
        }
        
        .section-content {
            padding: 15px;
            display: none;
        }
        
        .script-section.active .section-content {
            display: block;
        }
        
        /* תיבת טקסט עריכה */
        .editable-text {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            min-height: 60px;
        }
        
        .editable-text:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* אזור הוספת סיבוב */
        .add-round-area {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: #f0f8ff;
            border: 2px dashed #2196F3;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .add-round-area:hover {
            background: #e3f2fd;
            border-color: #1976D2;
        }
        
        /* סיבובים */
        .round {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative; /* חשוב לאזורי drop */
        }
        
        /* אזור Drop גדול מעל הסיבוב בזמן גרירה */
        body.dragging .round {
            margin-top: 80px; /* מרווח לאזור ה-drop */
        }
        
        body.dragging .round::before {
            content: '🎯 שחרר כאן להוספה לסיבוב';
            position: absolute;
            top: -70px;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.2));
            border: 3px dashed #28a745;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: #28a745;
            z-index: 10;
            transition: all 0.3s ease;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.02);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 0.8;
            }
        }
        
        /* אזור drop מודגש כשמתקרבים */
        body.dragging .round.drop-target::before {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.3), rgba(40, 167, 69, 0.4));
            border-color: #218838;
            color: #218838;
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(40, 167, 69, 0.3);
        }
        
        /* אנימציית גרירת סיבוב */
        .round.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        
        .round.drag-over {
            border-top: 4px solid #667eea;
            margin-top: 10px;
        }
        
        /* מניעת blur על סיבובים פעילים */
        .round.active {
            opacity: 1 !important;
            filter: none !important;
        }
        
        /* התחלת מצב נקי לdropzones */
        .question-dropzone:not(.drag-over) {
            opacity: 0;
            pointer-events: none;
            max-height: 0;
            margin: 0;
        }
        
        .round-header {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
        }
        
        .round-header h4 {
            margin: 0;
            font-size: 1.1em;
        }
        
        .round-content {
            padding: 15px;
            display: none;
        }
        
        .round.active .round-content {
            display: block;
        }
        
        /* שאלות בתוך סיבוב */
        .questions-list {
            position: relative;
        }
        
        /* אלמנט שאלה עם אנימציית כניסה */
        @keyframes slideInFade {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .question-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            position: relative;
            cursor: move;
            transition: all 0.3s ease;
            animation: slideInFade 0.4s ease-out;
        }
        
        .question-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .question-item.dragging {
            opacity: 0.3;
            transform: scale(0.9);
        }
        
        /* אינדיקטור למיקום חדש בזמן גרירה */
        .question-item.drag-preview {
            border: 2px dashed #28a745;
            background: rgba(40, 167, 69, 0.1);
            opacity: 0.6;
        }
        
        /* אזור גרירה - מוסתר כברירת מחדל */
        .question-dropzone {
            height: 60px;
            border: 2px dashed #28a745;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #28a745;
            font-weight: bold;
            margin: 10px 0;
            transition: all 0.3s ease;
            opacity: 0;
            pointer-events: none;
            max-height: 0;
            margin: 0;
            overflow: hidden;
        }
        
        /* הצגת dropzones רק בזמן גרירה */
        body.dragging .question-dropzone {
            opacity: 1;
            pointer-events: all;
            max-height: 60px;
            margin: 10px 0;
        }
        
        /* וידוא שאלמנטים לא נתקעים במצב dragging */
        body:not(.dragging) .dragging {
            opacity: 1 !important;
            transform: none !important;
        }
        
        .question-dropzone.drag-over {
            background: linear-gradient(45deg, #e8f5e9 25%, #f1f8e9 25%, #f1f8e9 50%, #e8f5e9 50%, #e8f5e9 75%, #f1f8e9 75%, #f1f8e9);
            background-size: 20px 20px;
            animation: move 0.5s linear infinite;
            border-color: #4caf50;
            transform: scale(1.02);
        }
        
        @keyframes move {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: 20px 20px;
            }
        }
        
        .question-number {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 11px;
            margin-left: 10px;
        }
        
        /* כפתורים */
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #ff9800);
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }
        
        /* כרטיסי סרטונים במאגר */
        .video-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: grab;
            transition: all 0.3s ease;
        }
        
        .video-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        
        .video-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
            transform: scale(0.95);
        }
        
        .video-card.not-approved {
            opacity: 0.5;
            border: 2px dashed #dc3545;
        }
        
        .video-card.pending {
            border: 2px dashed #ffc107;
        }
        
        .video-card.used {
            background: #f0f0f0;
            opacity: 0.6;
            position: relative;
        }
        
        .video-card.used::after {
            content: '✓ בשימוש';
            position: absolute;
            top: 5px;
            left: 5px;
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .video-card h5 {
            font-size: 13px;
            margin-bottom: 4px;
            color: #2c3e50;
        }
        
        .video-card .category {
            display: inline-block;
            background: #e3f2fd;
            color: #1565c0;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin-left: 5px;
        }
        
        .video-card .program {
            display: inline-block;
            background: #f3e5f5;
            color: #7b1fa2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
        }
        
        .video-card .approval-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .video-card .approval-status.approved {
            background: #d4edda;
            color: #155724;
        }
        
        .video-card .approval-status.not-approved {
            background: #f8d7da;
            color: #721c24;
        }
        
        .video-card .approval-status.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        /* פילטרים במאגר */
        .filter-section {
            padding: 10px;
            background: white;
            border-bottom: 1px solid #e9ecef;
        }
        
        .filter-section input, .filter-section select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        /* אזור ייבוא וייצוא */
        .import-export {
            padding: 15px;
            background: #f8f9fa;
            border-top: 2px solid #e9ecef;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        /* מודאל */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        
        /* תצוגת תסריט */
        .script-preview {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        
        /* רשימת תסריטים שמורים */
        .saved-scripts-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .saved-script-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .saved-script-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .saved-script-info h4 {
            margin: 0 0 5px 0;
            font-size: 14px;
        }
        
        .saved-script-info small {
            color: #666;
        }
        
        .saved-script-actions {
            display: flex;
            gap: 5px;
        }
        
        /* טעינה */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        /* הודעות */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 2000;
            display: none;
        }
        
        .notification.show {
            display: block;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }
        
        /* טקסט חופשי */
        .free-text {
            background: white;
            border: 2px solid #9c27b0;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .free-text-header {
            background: linear-gradient(135deg, #9c27b0, #7b1fa2);
            color: white;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
        }
        
        .free-text-header h4 {
            margin: 0;
            font-size: 1.1em;
        }
        
        .free-text-content {
            padding: 15px;
        }
        
        .free-text textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
        }
        
        /* מספר אוטומטי */
        .auto-number {
            background: #6c757d;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
        }
        
        /* מספר סיבוב */
        .round-number {
            background: #28a745;
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
            margin-left: 8px;
        }
        
        /* רספונסיב */
        @media (max-width: 1200px) {
            .sidebar {
                width: 300px;
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-height: 300px;
                border-left: none;
                border-bottom: 2px solid #e9ecef;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="notification" id="notification"></div>
        
        <div class="header">
            <h1>🎬 בונה תסריטים - מה קורה פה?!</h1>
            <p>צור תסריט מושלם עם גרירת סרטונים ישירות מהמאגר</p>
            <p style="font-size: 11px; opacity: 0.8;">💡 טיפ: Ctrl+S לשמירה מהירה</p>
        </div>
        
        <div class="main-content">
            <!-- סידבר - מאגר סרטונים -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h3>📦 מאגר סרטונים</h3>
                    <button class="btn btn-success btn-sm" onclick="refreshVideos()">🔄 רענן</button>
                </div>
                
                <div class="filter-section">
                    <input type="text" id="searchVideos" placeholder="🔍 חפש סרטון..." onkeyup="filterVideos()">
                    <select id="categoryFilter" onchange="filterVideos()">
                        <option value="">כל הקטגוריות</option>
                    </select>
                    <select id="programFilter" onchange="filterVideos()">
                        <option value="">כל התוכניות</option>
                        <option value="unassigned">לא שובץ</option>
                        <option value="1">פרק 1</option>
                        <option value="2">פרק 2</option>
                        <option value="3">פרק 3</option>
                        <option value="4">פרק 4</option>
                        <option value="5">פרק 5</option>
                    </select>
                    <select id="approvalFilter" onchange="filterVideos()">
                        <option value="">כל הסטטוסים</option>
                        <option value="approved">מאושר</option>
                        <option value="not-approved">לא מאושר</option>
                        <option value="pending">בטיפול</option>
                    </select>
                </div>
                
                <div id="videoList" class="video-list">
                    <div class="loading">טוען סרטונים מהמאגר...</div>
                </div>
            </div>
            
            <!-- אזור עבודה -->
            <div class="workspace">
                <div class="script-header">
                    <h3>📋 פרטי התוכנית</h3>
                    <div class="script-header-inputs">
                        <input type="text" id="programNumber" placeholder="תוכנית מס׳">
                        <input type="text" id="programDate" placeholder="תאריך">
                        <input type="text" id="draftNumber" placeholder="דראפט מס׳">
                    </div>
                </div>
                
                <!-- חלק הפתיחה המתקפל -->
                <div class="collapsible-section collapsed" id="openingSection">
                    <div class="collapsible-header" onclick="toggleCollapsible('openingSection')">
                        <h3>🎬 חלק הפתיחה</h3>
                        <span class="collapse-arrow">▼</span>
                    </div>
                    <div class="collapsible-content" id="openingContent">
                        <!-- כאן יווצרו חלקי הפתיחה -->
                    </div>
                </div>
                
                <div class="script-container" id="scriptContainer">
                    <!-- כאן יווצרו הסיבובים -->
                </div>
                
                <!-- אזור הוספת סיבוב -->
                <div class="add-round-area">
                    <button class="btn btn-success" onclick="addNewRound()">➕ הוסף סיבוב חדש</button>
                    <button class="btn btn-primary" onclick="addFreeText()">📝 הוסף טקסט חופשי</button>
                    <p style="margin-top: 10px; color: #666; font-size: 12px;">גרור סרטונים מהמאגר לתוך הסיבובים</p>
                </div>
                
                <!-- דברי סיום יווצרו כאן -->
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-warning" onclick="previewScript()">👁️ תצוגה מקדימה</button>
                    <button class="btn btn-primary" onclick="exportScript()">📝 ייצא טקסט</button>
                    <button class="btn btn-primary" style="background: linear-gradient(135deg, #2b579a, #1d4084);" onclick="exportToWord()">📄 ייצא תסריט לקובץ וורד</button>
                    <button class="btn btn-success" style="background: linear-gradient(135deg, #207245, #0f5132);" onclick="exportVideosTable()">📊 ייצא טבלת סרטונים מעודכנת</button>
                </div>
            </div>
        </div>
        
        <div class="import-export">
            <button class="btn btn-primary" onclick="saveToFirebase()">☁️ שמור בענן</button>
            <button class="btn btn-warning" onclick="quickSaveToFirebase()" id="quickSaveBtn" style="display:none;">💾 שמור שינויים</button>
            <button class="btn btn-success" onclick="showSavedScripts()">📂 טען מהענן</button>
            <button class="btn btn-primary" onclick="saveProject()">💾 הורד גיבוי</button>
            <button class="btn btn-success" onclick="loadProject()">📁 טען מקובץ</button>
            <button class="btn btn-warning" onclick="openVideoManager()" style="background: linear-gradient(135deg, #667eea, #764ba2);">🎬 למנהל הסרטונים</button>
        </div>
    </div>
    
    <!-- מודאל תצוגה מקדימה -->
    <div class="modal" id="previewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>תצוגה מקדימה</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="script-preview" id="scriptPreview"></div>
            </div>
        </div>
    </div>
    
    <!-- מודאל תסריטים שמורים -->
    <div class="modal" id="savedScriptsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>תסריטים שמורים</h3>
                <button class="modal-close" onclick="closeSavedScriptsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="saved-scripts-list" id="savedScriptsList">
                    <div class="loading">טוען תסריטים...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        // הגדרות Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA_xIrjXqNBHtvCdruFeinIN4G134GqPiI",
            authDomain: "makorepo-81e68.firebaseapp.com",
            databaseURL: "https://makorepo-81e68-default-rtdb.firebaseio.com",
            projectId: "makorepo-81e68",
            storageBucket: "makorepo-81e68.firebasestorage.app",
            messagingSenderId: "25343223097",
            appId: "1:25343223097:web:3f4c38f1802ad0a9a5b4e8",
            measurementId: "G-EWC51ELEXS"
        };

        // אתחול Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const videosRef = database.ref('videos');
        const scriptsRef = database.ref('scripts'); // נתיב חדש לתסריטים
        
        // משתנים גלובליים
        let videoDatabase = [];
        let usedVideos = new Set(); // רשימת הסרטונים בשימוש
        let currentProject = {
            programNumber: '',
            programDate: '',
            draftNumber: '',
            sections: []
        };
        let sectionCounter = 1;
        let roundCounter = 0;
        let currentScriptId = null; // מזהה התסריט הנוכחי בענן
        let hasUnsavedChanges = false; // דגל לשינויים שלא נשמרו
        
        // רשימת המתמודדים
        const contestants = [
            { id: 'giora', name: 'גיורא זינגר' },
            { id: 'matan', name: 'מתן פרץ' },
            { id: 'mirit', name: 'מירית מוגזמת ליבצקי' },
            { id: 'uri', name: 'אורי ברויר' },
            { id: 'linor', name: 'לינור אברג\'יל' },
            { id: 'shachar', name: 'שחר קפלן' },
            { id: 'tal', name: 'טל ראשון' },
            { id: 'nofar', name: 'נופר סוויסה' }
        ];
        
        // מבנה התסריט הקבוע המעודכן
        const templateSections = [
            {
                id: 'pre-opening',
                type: 'fixed',
                number: 1,
                title: 'פרה פתיח - לא צריך משוט רחף, אלא סגור שלום',
                content: `ערב טוב, אנחנו כאן בתכנית חדשה, שתעזור לכם לקחת הפוגה קלה מרצף שידורי החדשות. אנחנו מאמינים שהומור יכול להקל ולחזק, ואת זה אנחנו יודעים לעשות יותר טוב מכל עם בעולם. במקרה ויידרש, כמובן שנעדכן אתכם בכל התרחשות. אז הצטרפו אלינו לשעה קלילה, כי אם כבר נכנסנו לממד, בואו נצחק ביחד - כי את זה אף פרסי לא יכול לקחת מאתנו! בואו נתחיל:`
            },
            {
                id: 'opening',
                type: 'fixed',
                number: 2,
                title: 'פתיח ושוט פתיחה',
                content: ''
            },
            {
                id: 'opening-words',
                type: 'fixed',
                number: 3,
                title: 'דברי פתיחה - שלום אסייג:',
                content: `ערב טוב וברוכים הבאים לתוכנית [מספר] של "מה קורה פה?!" - התוכנית ששמה בצד את הדברים החשובים באמת וצוחקת על כל הדברים הקטנים והמשוגעים שקורים סביבנו!`
            },
            {
                id: 'intro-contestants',
                type: 'fixed',
                number: 4,
                title: 'הכרות עם המתמודדים',
                content: `רגע לפני שאסביר לכם את חוקי המשחק שלנו, בואו נכיר את הקומיקאים שיהיו אתנו הערב ויעשו לנו קצת טוב על הלב!`
            },
            {
                id: 'contestants-selection',
                type: 'contestants',
                number: 5,
                title: 'בחירת מתמודדים',
                content: ''
            },
            {
                id: 'game-explanation',
                type: 'fixed',
                number: 6,
                title: 'הסבר על המשחק',
                content: `אז מה ייקרה פה הערב ואיך המשחק שלנו הולך?

אני אראה לחמשת האנשים המצחיקים שיושבים פה, רגעים קצרים מתוך דברים שראינו לאחרונה בטלוויזיה וברשת, ואשאל אותם שאלה על המשך הקטע - הם יצטרכו לנחש מה קורה פה!

מי שיקבל הכי הרבה נקודות עד סוף המשחק יוכרז כמנצח התוכנית ויזכה בשלל יצירות של הבן שלי מהגן.

הראשון או הראשונה שיילחצו על הבאזר ויענו תשובה נכונה - ייזכו ב- 10 נקודות. חשוב להגיד - לי יש את הזכות לתת נקודות בונוס על תשובות שאהבתי במיוחד.

אז תזכרו, בתוכנית שלנו, כמו בכביש, חשוב להיות צודק, אבל יותר חשוב לא לתת לאף אחד לעקוף אתכם!

אני מרגיש שאתם לא רגועים, אז לפני שנצטרך לחלק לכם רטלין - אני מציע שנתחיל.`
            },
            {
                id: 'closing-words',
                type: 'fixed',
                number: 999, // מספר גבוה כדי שתמיד יהיה אחרון
                title: 'דברי סיום',
                content: `זהו להיום. מקווה שעזרנו לכם ליהנות קצת מהשיגעון.
מאחל לכולנו לילה בטוח ואמן שיהיה גם שקט ולכל מי שלא אתנו הערב, שיחזרו כבר הביתה לפה ומהר.
נפגש פה שוב בשבוע הבא וננסה יחד לפצח את שאלת השאלות -- מה קורה פה!!!!
לילה טוב.`
            }
        ];
        
        // פונקציה להמרת סטטוס אישור לטקסט
        function getApprovalText(status) {
            switch(status) {
                case 'approved':
                    return 'מאושר';
                case 'not-approved':
                    return 'לא מאושר';
                case 'pending':
                    return 'בטיפול';
                default:
                    return 'בטיפול';
            }
        }
        
        // סימון שינויים שלא נשמרו
        function markAsUnsaved() {
            hasUnsavedChanges = true;
            const quickSaveBtn = document.getElementById('quickSaveBtn');
            if (currentScriptId && quickSaveBtn) {
                quickSaveBtn.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
                quickSaveBtn.innerHTML = '💾 שמור שינויים*';
            }
        }
        
        // סימון ששמרנו
        function markAsSaved() {
            hasUnsavedChanges = false;
            const quickSaveBtn = document.getElementById('quickSaveBtn');
            if (quickSaveBtn) {
                quickSaveBtn.style.background = '';
                quickSaveBtn.innerHTML = '💾 שמור שינויים';
            }
        }
        
        // הוספת מאזינים לשינויים
        function addChangeListeners() {
            // מאזינים לשדות הכותרת
            document.getElementById('programNumber').addEventListener('input', markAsUnsaved);
            document.getElementById('programDate').addEventListener('input', markAsUnsaved);
            document.getElementById('draftNumber').addEventListener('input', markAsUnsaved);
            
            // מאזין גלובלי לכל שאר השינויים
            document.addEventListener('input', function(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    markAsUnsaved();
                }
            });
        }
        
        // פונקציה לפתיחת מנהל הסרטונים בחלון חדש
        function openVideoManager() {
            // פותח את מנהל הסרטונים בחלון חדש
            window.open('https://aviadaviad.github.io/video-manager/', '_blank');
        }
        
        // פונקציה חדשה לייצוא טבלת סרטונים
        function exportVideosTable() {
            try {
                showNotification('📊 יוצר טבלת סרטונים...');
                
                const programNum = document.getElementById('programNumber').value || '[מספר]';
                const programDate = document.getElementById('programDate').value || '[תאריך]';
                const draftNum = document.getElementById('draftNumber').value || '[מספר]';
                
                // איסוף כל הסרטונים לפי סיבובים
                const roundsData = [];
                
                document.querySelectorAll('.round').forEach((round, index) => {
                    const roundNameInput = round.querySelector('.round-header input');
                    const roundName = roundNameInput ? roundNameInput.value : `סיבוב ${index + 1}`;
                    
                    const videos = [];
                    round.querySelectorAll('.question-item:not(.question-dropzone)').forEach(question => {
                        if (question.dataset.videoData) {
                            const videoData = JSON.parse(question.dataset.videoData);
                            const questionInput = question.querySelector('input[placeholder="הכנס שאלה..."]');
                            
                            videos.push({
                                number: videoData.number || '',
                                title: videoData.title || '',
                                question: questionInput ? questionInput.value : (videoData.question || ''),
                                approvalStatus: videoData.approvalStatus || 'pending'
                            });
                        }
                    });
                    
                    if (videos.length > 0) {
                        roundsData.push({
                            name: roundName,
                            videos: videos
                        });
                    }
                });
                
                if (roundsData.length === 0) {
                    alert('אין סרטונים בתסריט');
                    return;
                }
                
                // יצירת תוכן HTML לוורד
                let wordContent = `
                <!DOCTYPE html>
                <html xmlns:o="urn:schemas-microsoft-com:office:office" 
                      xmlns:w="urn:schemas-microsoft-com:office:word" 
                      xmlns="http://www.w3.org/TR/REC-html40">
                <head>
                    <meta charset="UTF-8">
                    <meta name="ProgId" content="Word.Document">
                    <meta name="Generator" content="Microsoft Word">
                    <meta name="Originator" content="Microsoft Word">
                    <!--[if gte mso 9]>
                    <xml>
                    <w:WordDocument>
                    <w:View>Print</w:View>
                    <w:Zoom>100</w:Zoom>
                    <w:DoNotOptimizeForBrowser/>
                    </w:WordDocument>
                    </xml>
                    <![endif]-->
                    <style>
                        @page {
                            size: A4 portrait;
                            margin: 0.5in;
                        }
                        body { 
                            font-family: 'Calibri', 'Arial', sans-serif; 
                            font-size: 9pt; 
                            direction: rtl; 
                            text-align: right;
                            margin: 0.5in;
                            line-height: 1.2;
                        }
                        h1 { 
                            font-size: 14pt; 
                            font-weight: bold; 
                            text-align: center; 
                            margin-bottom: 10pt;
                            color: #2c3e50;
                        }
                        h2 { 
                            font-size: 10pt; 
                            font-weight: bold; 
                            margin-bottom: 8pt;
                            color: #34495e;
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin-bottom: 10pt;
                            font-size: 8pt;
                            table-layout: fixed;
                        }
                        th { 
                            background-color: #3498db; 
                            color: white; 
                            padding: 3pt 2pt; 
                            border: 0.5pt solid #2980b9; 
                            font-weight: bold;
                            text-align: center;
                            font-size: 8pt;
                            line-height: 1.1;
                        }
                        td { 
                            padding: 2pt 3pt; 
                            border: 0.5pt solid #bdc3c7; 
                            vertical-align: top;
                            line-height: 1.1;
                            word-wrap: break-word;
                        }
                        tr:nth-child(even) { 
                            background-color: #f8f9fa; 
                        }
                        .number { 
                            text-align: center; 
                            font-weight: bold;
                            width: 8%;
                        }
                        .title { 
                            font-weight: bold;
                            width: 37%;
                        }
                        .question { 
                            width: 40%;
                        }
                        .approval { 
                            text-align: center; 
                            font-weight: bold;
                            width: 15%;
                        }
                        .round-header {
                            background-color: #28a745;
                            color: white;
                            font-weight: bold;
                            padding: 4pt;
                            text-align: center;
                            font-size: 10pt;
                        }
                        .summary {
                            margin-top: 10pt;
                            padding: 6pt;
                            background-color: #ecf0f1;
                            border: 0.5pt solid #bdc3c7;
                            font-size: 8pt;
                            line-height: 1.3;
                        }
                    </style>
                </head>
                <body>`;
                
                // כותרת המסמך
                wordContent += `<h1>🎬 רשימת סרטונים - תכנית ${programNum}</h1>`;
                wordContent += `<h2>תאריך: ${programDate} | דראפט: ${draftNum}</h2>`;
                
                // תאריך ושעת יצירה
                const now = new Date();
                wordContent += `<h2>נוצר בתאריך: ${now.toLocaleDateString('he-IL')} בשעה ${now.toLocaleTimeString('he-IL')}</h2>`;
                
                let totalVideos = 0;
                
                // יצירת טבלה לכל סיבוב
                roundsData.forEach((round, roundIndex) => {
                    wordContent += `<div class="round-header">סיבוב ${roundIndex + 1} - ${round.name}</div>`;
                    
                    wordContent += `
                    <table>
                        <thead>
                            <tr>
                                <th class="number">מס'</th>
                                <th class="title">הסרטון</th>
                                <th class="question">שאלה</th>
                                <th class="approval">סטטוס</th>
                            </tr>
                        </thead>
                        <tbody>`;
                    
                    round.videos.forEach((video, index) => {
                        wordContent += `
                        <tr>
                            <td class="number">${video.number || (index + 1)}</td>
                            <td class="title">${video.title}</td>
                            <td class="question">${video.question}</td>
                            <td class="approval">${getApprovalText(video.approvalStatus)}</td>
                        </tr>`;
                    });
                    
                    wordContent += `</tbody></table>`;
                    
                    totalVideos += round.videos.length;
                });
                
                // סיכום
                wordContent += `
                <div class="summary">
                    <strong>סיכום:</strong><br>
                    סה"כ סיבובים: ${roundsData.length}<br>
                    סה"כ סרטונים: ${totalVideos}<br>`;
                
                // פירוט לפי סיבובים
                roundsData.forEach((round, index) => {
                    wordContent += `סיבוב ${index + 1} - ${round.name}: ${round.videos.length} סרטונים<br>`;
                });
                
                wordContent += `<br>תאריך ושעת ייצוא: ${new Date().toLocaleString('he-IL')}<br>
                    מערכת: בונה תסריטים
                </div>`;
                
                wordContent += `
                </body>
                </html>`;
                
                // יצירת הקובץ והורדה
                const blob = new Blob([wordContent], {
                    type: 'application/msword;charset=utf-8'
                });
                
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `טבלת_סרטונים_תכנית_${programNum}_דראפט_${draftNum}.doc`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification(`✅ טבלת הסרטונים יוצאה בהצלחה!`);
                
            } catch (error) {
                console.error('שגיאה בייצוא טבלת סרטונים:', error);
                showNotification('❌ שגיאה בייצוא הטבלה', 'error');
            }
        }
        
        // פונקציות Firebase לתסריטים
        async function saveToFirebase() {
            // אם יש תסריט נוכחי, שאל אם לעדכן או ליצור חדש
            if (currentScriptId) {
                const choice = confirm('האם לעדכן את התסריט הנוכחי או ליצור תסריט חדש?\n\nOK = עדכן את הנוכחי\nCancel = צור תסריט חדש');
                if (choice) {
                    await quickSaveToFirebase();
                    return;
                }
            }
            
            const scriptName = prompt('תן שם לתסריט (למשל: תכנית 5 דראפט 2)');
            if (!scriptName) return;
            
            try {
                const scriptData = buildProjectData();
                scriptData.name = scriptName;
                scriptData.createdAt = new Date().toISOString();
                scriptData.updatedAt = new Date().toISOString();
                
                // שמירה בפיירבייס
                const newScriptRef = scriptsRef.push();
                await newScriptRef.set(scriptData);
                
                // שמירת ה-ID של התסריט החדש
                currentScriptId = newScriptRef.key;
                document.getElementById('quickSaveBtn').style.display = 'inline-block';
                
                markAsSaved();
                showNotification('✅ התסריט נשמר בהצלחה בענן!');
            } catch (error) {
                console.error('שגיאה בשמירה:', error);
                showNotification('❌ שגיאה בשמירת התסריט', 'error');
            }
        }
        
        // פונקציה חדשה לשמירה מהירה
        async function quickSaveToFirebase() {
            if (!currentScriptId) {
                await saveToFirebase();
                return;
            }
            
            try {
                const scriptData = buildProjectData();
                scriptData.updatedAt = new Date().toISOString();
                
                // שמירת השם והתאריך המקוריים
                const existingSnapshot = await scriptsRef.child(currentScriptId).once('value');
                const existingData = existingSnapshot.val();
                scriptData.name = existingData.name;
                scriptData.createdAt = existingData.createdAt;
                
                await scriptsRef.child(currentScriptId).set(scriptData);
                
                markAsSaved();
                showNotification(`✅ נשמר: ${scriptData.name}`);
            } catch (error) {
                console.error('שגיאה בעדכון:', error);
                showNotification('❌ שגיאה בשמירת השינויים', 'error');
            }
        }
        
        async function showSavedScripts() {
            // בדיקה אם יש שינויים שלא נשמרו
            if (hasUnsavedChanges) {
                const confirmLoad = confirm('יש לך שינויים שלא נשמרו. האם להמשיך?');
                if (!confirmLoad) return;
            }
            
            document.getElementById('savedScriptsModal').style.display = 'flex';
            
            try {
                const snapshot = await scriptsRef.once('value');
                const scripts = snapshot.val();
                
                const scriptsList = document.getElementById('savedScriptsList');
                scriptsList.innerHTML = '';
                
                if (!scripts) {
                    scriptsList.innerHTML = '<div class="loading">אין תסריטים שמורים</div>';
                    return;
                }
                
                // המרה למערך וסידור לפי תאריך
                const scriptsArray = Object.entries(scripts).map(([id, script]) => ({
                    id,
                    ...script
                }));
                
                scriptsArray.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                
                scriptsArray.forEach(script => {
                    const scriptItem = document.createElement('div');
                    scriptItem.className = 'saved-script-item';
                    
                    const createdDate = new Date(script.createdAt).toLocaleString('he-IL');
                    const updatedDate = new Date(script.updatedAt).toLocaleString('he-IL');
                    
                    scriptItem.innerHTML = `
                        <div class="saved-script-info">
                            <h4>${script.name}</h4>
                            <small>נוצר: ${createdDate}</small>
                            <br>
                            <small>עודכן: ${updatedDate}</small>
                        </div>
                        <div class="saved-script-actions">
                            <button class="btn btn-primary btn-sm" onclick="loadFromFirebase('${script.id}')">טען</button>
                            <button class="btn btn-warning btn-sm" onclick="updateInFirebase('${script.id}')">עדכן</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteFromFirebase('${script.id}')">מחק</button>
                        </div>
                    `;
                    
                    scriptsList.appendChild(scriptItem);
                });
            } catch (error) {
                console.error('שגיאה בטעינת תסריטים:', error);
                showNotification('❌ שגיאה בטעינת התסריטים', 'error');
            }
        }
        
async function loadFromFirebase(scriptId) {
    try {
        console.log('🔄 מתחיל טעינת תסריט:', scriptId);
        
        const snapshot = await scriptsRef.child(scriptId).once('value');
        const scriptData = snapshot.val();
        
        if (!scriptData) {
            console.error('❌ לא נמצאו נתונים עבור ID:', scriptId);
            showNotification('❌ התסריט לא נמצא', 'error');
            return;
        }
        
        console.log('✅ נתונים נטענו מ-Firebase:', scriptData);
        
        // בדיקה בסיסית של המבנה
        if (!scriptData.sections || !Array.isArray(scriptData.sections)) {
            throw new Error('המבנה sections חסר או לא תקין');
        }
        
        console.log(`📋 נמצאו ${scriptData.sections.length} sections לטעינה`);
        
        // טעינת הנתונים עם טיפול שגיאות משופר
        await loadProjectDataSafe(scriptData);
        
        // שמירת ה-ID של התסריט הנוכחי
        currentScriptId = scriptId;
        document.getElementById('quickSaveBtn').style.display = 'inline-block';
        
        markAsSaved();
        closeSavedScriptsModal();
        showNotification(`✅ נטען: ${scriptData.name}`);
        
    } catch (error) {
        console.error('❌ שגיאה מפורטת בטעינת תסריט:', error);
        console.error('❌ Stack trace:', error.stack);
        showNotification(`❌ שגיאה בטעינה: ${error.message}`, 'error');
    }
}
        
        async function updateInFirebase(scriptId) {
            const confirmUpdate = confirm('האם לעדכן את התסריט השמור עם הנתונים הנוכחיים?');
            if (!confirmUpdate) return;
            
            try {
                const scriptData = buildProjectData();
                scriptData.updatedAt = new Date().toISOString();
                
                // שמירת השם הקיים
                const existingSnapshot = await scriptsRef.child(scriptId).once('value');
                const existingData = existingSnapshot.val();
                scriptData.name = existingData.name;
                scriptData.createdAt = existingData.createdAt;
                
                await scriptsRef.child(scriptId).set(scriptData);
                
                showNotification('✅ התסריט עודכן בהצלחה!');
                closeSavedScriptsModal();
            } catch (error) {
                console.error('שגיאה בעדכון:', error);
                showNotification('❌ שגיאה בעדכון התסריט', 'error');
            }
        }
        
        async function deleteFromFirebase(scriptId) {
            const confirmDelete = confirm('האם אתה בטוח שברצונך למחוק את התסריט?');
            if (!confirmDelete) return;
            
            try {
                await scriptsRef.child(scriptId).remove();
                showNotification('✅ התסריט נמחק בהצלחה!');
                showSavedScripts(); // רענון הרשימה
            } catch (error) {
                console.error('שגיאה במחיקה:', error);
                showNotification('❌ שגיאה במחיקת התסריט', 'error');
            }
        }
        
        function closeSavedScriptsModal() {
            document.getElementById('savedScriptsModal').style.display = 'none';
        }
        
        // פונקציה לבניית נתוני הפרויקט
        function buildProjectData() {
            const project = {
                programNumber: document.getElementById('programNumber').value,
                programDate: document.getElementById('programDate').value,
                draftNumber: document.getElementById('draftNumber').value,
                sections: []
            };
            
            // שמירת סעיפי הפתיחה
            document.querySelectorAll('#openingContent .script-section').forEach(section => {
                const sectionId = section.dataset.sectionId;
                
                if (sectionId === 'contestants-selection') {
                    // שמירת בחירת מתמודדים
                    const contestantsData = {};
                    contestants.forEach(contestant => {
                        const checkbox = document.getElementById(`check-${contestant.id}`);
                        const textarea = document.querySelector(`[data-contestant="${contestant.id}"]`);
                        contestantsData[contestant.id] = {
                            selected: checkbox ? checkbox.checked : false,
                            text: textarea ? textarea.value : ''
                        };
                    });
                    project.sections.push({
                        type: 'contestants',
                        data: contestantsData
                    });
                } else {
                    project.sections.push({
                        type: 'fixed',
                        id: sectionId,
                        content: section.querySelector('.editable-text')?.value || ''
                    });
                }
            });
            
            // שמירת סיבובים וטקסטים חופשיים
            document.querySelectorAll('#scriptContainer > *').forEach(element => {
                if (element.classList.contains('round')) {
                    const roundData = {
                        type: 'round',
                        name: element.querySelector('.round-header input').value,
                        intro: element.querySelector('.editable-text').value,
                        questions: []
                    };
                    
                    element.querySelectorAll('.question-item:not(.question-dropzone)').forEach(question => {
                        if (question.dataset.videoData) {
                            const inputs = question.querySelectorAll('input');
                            roundData.questions.push({
                                videoData: JSON.parse(question.dataset.videoData),
                                question: inputs[0]?.value || '',
                                answer: inputs[1]?.value || '',
                                after: inputs[2]?.value || ''
                            });
                        }
                    });
                    
                    project.sections.push(roundData);
                } else if (element.classList.contains('free-text')) {
                    const freeTextData = {
                        type: 'free-text',
                        title: element.querySelector('.free-text-header input').value,
                        content: element.querySelector('textarea').value
                    };
                    project.sections.push(freeTextData);
                }
            });
            
            // שמירת דברי סיום
            const closingSection = document.querySelector('[data-section-id="closing-words"]');
            if (closingSection) {
                project.sections.push({
                    type: 'fixed',
                    id: 'closing-words',
                    content: closingSection.querySelector('.editable-text').value
                });
            }
            
            return project;
        }
        
        // פונקציה לטעינת נתוני פרויקט
        function loadProjectData(project) {
            // טעינת פרטי התוכנית
            document.getElementById('programNumber').value = project.programNumber || '';
            document.getElementById('programDate').value = project.programDate || '';
            document.getElementById('draftNumber').value = project.draftNumber || '';
            
            // ניקוי וטעינה מחדש
            initializeScript();
            document.getElementById('scriptContainer').innerHTML = '';
            
            const closingData = project.sections.find(s => s.id === 'closing-words');
            
            project.sections.forEach(section => {
                if (section.type === 'fixed' && section.id !== 'closing-words') {
                    // עדכון סעיף קבוע
                    const fixedSection = document.querySelector(`[data-section-id="${section.id}"]`);
                    if (fixedSection) {
                        const textarea = fixedSection.querySelector('.editable-text');
                        if (textarea) {
                            textarea.value = section.content || '';
                        }
                    }
                } else if (section.type === 'contestants') {
                    // טעינת בחירת מתמודדים
                    Object.keys(section.data).forEach(contestantId => {
                        const checkbox = document.getElementById(`check-${contestantId}`);
                        const textarea = document.querySelector(`[data-contestant="${contestantId}"]`);
                        if (checkbox) {
                            checkbox.checked = section.data[contestantId].selected;
                            toggleContestant(contestantId);
                        }
                        if (textarea) {
                            textarea.value = section.data[contestantId].text || '';
                        }
                    });
                } else if (section.type === 'round') {
                    // יצירת סיבוב
                    addNewRound();
                    const rounds = document.querySelectorAll('.round');
                    const lastRound = rounds[rounds.length - 1];
                    
                    // עדכון שם וטקסט פתיחה
                    lastRound.querySelector('.round-header input').value = section.name || '';
                    lastRound.querySelector('.editable-text').value = section.intro || '';
                    
                    // הוספת שאלות
                    const questionsList = lastRound.querySelector('.questions-list');
                    questionsList.innerHTML = ''; // ניקוי
                    
                    section.questions.forEach(q => {
                        const newQuestion = createQuestionElement(q.videoData);
                        questionsList.appendChild(newQuestion);
                        
                        // עדכון השדות
                        const inputs = newQuestion.querySelectorAll('input');
                        if (inputs[0]) inputs[0].value = q.question || '';
                        if (inputs[1]) inputs[1].value = q.answer || '';
                        if (inputs[2]) inputs[2].value = q.after || '';
                    });
                    
                    // עדכון dropzones
                    updateDropzones(questionsList);
                } else if (section.type === 'free-text') {
                    // יצירת טקסט חופשי
                    const container = document.getElementById('scriptContainer');
                    const freeTextDiv = document.createElement('div');
                    freeTextDiv.className = 'free-text';
                    freeTextDiv.dataset.sectionType = 'free-text';
                    
                    freeTextDiv.innerHTML = `
                        <div class="free-text-header" draggable="true" ondragstart="dragFreeText(event)" ondragover="dragOverFreeText(event)" ondragleave="dragLeaveFreeText(event)" ondrop="dropFreeText(event)">
                            <h4>📝 טקסט חופשי - <input type="text" placeholder="הכנס כותרת" onclick="event.stopPropagation()" style="background: none; border: none; color: white; font-weight: bold;" value="${section.title || ''}"></h4>
                            <button class="btn btn-danger btn-sm" onclick="removeFreeText(this, event)">🗑️</button>
                        </div>
                        <div class="free-text-content">
                            <textarea placeholder="הכנס טקסט חופשי כאן...">${section.content || ''}</textarea>
                        </div>
                    `;
                    
                    container.appendChild(freeTextDiv);
                }
            });
            
            // עדכון דברי סיום
            if (closingData) {
                const closingDiv = document.querySelector('[data-section-id="closing-words"]');
                if (closingDiv) {
                    closingDiv.querySelector('.editable-text').value = closingData.content;
                }
            }
            
            // הפעלת סעיפים קבועים (חוץ מדברי סיום)
            document.querySelectorAll('.script-section.fixed-section').forEach(section => {
                if (section.dataset.sectionId !== 'closing-words') {
                    section.classList.add('active');
                }
            });
            // עדכון רשימת הסרטונים בשימוש
            updateUsedVideos();
        }
        
// פונקציה לטעינת נתוני פרויקט עם טיפול שגיאות משופר
        async function loadProjectDataSafe(project) {
            try {
                console.log('🔄 מתחיל טעינת נתוני פרויקט:', project);
                
                // שלב 1: טעינת פרטי התוכנית
                console.log('📝 טוען פרטי תוכנית...');
                try {
                    document.getElementById('programNumber').value = project.programNumber || '';
                    document.getElementById('programDate').value = project.programDate || '';
                    document.getElementById('draftNumber').value = project.draftNumber || '';
                    console.log('✅ פרטי התוכנית נטענו');
                } catch (error) {
                    console.error('❌ שגיאה בטעינת פרטי התוכנית:', error);
                }
                
                // שלב 2: איפוס ואתחול
                console.log('🔄 מאפס ממשק...');
                try {
                    initializeScript();
                    document.getElementById('scriptContainer').innerHTML = '';
                    console.log('✅ ממשק אופס');
                } catch (error) {
                    console.error('❌ שגיאה באיפוס ממשק:', error);
                    throw error;
                }
                
                // שלב 3: חיפוש דברי סיום
                console.log('🔍 מחפש דברי סיום...');
                const closingData = project.sections.find(s => s.id === 'closing-words');
                console.log('📄 דברי סיום:', closingData ? 'נמצאו' : 'לא נמצאו');
                
                // שלב 4: עיבוד sections
                console.log(`🔄 מעבד ${project.sections.length} sections...`);
                
                project.sections.forEach((section, index) => {
                    try {
                        console.log(`📄 מעבד section ${index + 1}/${project.sections.length}: type=${section.type}, id=${section.id || 'N/A'}`);
                        
                        if (section.type === 'fixed' && section.id !== 'closing-words') {
                            // עדכון סעיף קבוע
                            console.log(`🔧 מעדכן סעיף קבוע: ${section.id}`);
                            const fixedSection = document.querySelector(`[data-section-id="${section.id}"]`);
                            if (fixedSection) {
                                const textarea = fixedSection.querySelector('.editable-text');
                                if (textarea) {
                                    textarea.value = section.content || '';
                                    console.log(`✅ סעיף קבוע ${section.id} עודכן`);
                                } else {
                                    console.warn(`⚠️ לא נמצא textarea עבור ${section.id}`);
                                }
                            } else {
                                console.warn(`⚠️ לא נמצא element עבור ${section.id}`);
                            }
                            
                        } else if (section.type === 'contestants') {
                            // טעינת בחירת מתמודדים
                            console.log('👥 טוען נתוני מתמודדים...');
                            if (section.data && typeof section.data === 'object') {
                                Object.keys(section.data).forEach(contestantId => {
                                    try {
                                        const checkbox = document.getElementById(`check-${contestantId}`);
                                        const textarea = document.querySelector(`[data-contestant="${contestantId}"]`);
                                        
                                        if (checkbox) {
                                            checkbox.checked = section.data[contestantId].selected;
                                            toggleContestant(contestantId);
                                            console.log(`✅ מתמודד ${contestantId}: ${checkbox.checked ? 'נבחר' : 'לא נבחר'}`);
                                        }
                                        if (textarea) {
                                            textarea.value = section.data[contestantId].text || '';
                                        }
                                    } catch (error) {
                                        console.error(`❌ שגיאה בטעינת מתמודד ${contestantId}:`, error);
                                    }
                                });
                                console.log('✅ נתוני מתמודדים נטענו');
                            } else {
                                console.warn('⚠️ נתוני מתמודדים לא תקינים:', section.data);
                            }
                            
                        } else if (section.type === 'round') {
                            // יצירת סיבוב
                            console.log(`🎯 יוצר סיבוב: ${section.name || 'ללא שם'}`);
                            try {
                                addNewRound();
                                const rounds = document.querySelectorAll('.round');
                                const lastRound = rounds[rounds.length - 1];
                                
                                // עדכון שם וטקסט פתיחה
                                const nameInput = lastRound.querySelector('.round-header input');
                                const introTextarea = lastRound.querySelector('.editable-text');
                                
                                if (nameInput) nameInput.value = section.name || '';
                                if (introTextarea) introTextarea.value = section.intro || '';
                                
                                // הוספת שאלות
                                const questionsList = lastRound.querySelector('.questions-list');
                                if (questionsList) {
                                    questionsList.innerHTML = ''; // ניקוי
                                    
                                    if (section.questions && Array.isArray(section.questions)) {
                                        console.log(`📝 מוסיף ${section.questions.length} שאלות לסיבוב`);
                                        
                                        section.questions.forEach((q, qIndex) => {
                                            try {
                                                if (q.videoData) {
                                                    const newQuestion = createQuestionElement(q.videoData);
                                                    questionsList.appendChild(newQuestion);
                                                    
                                                    // עדכון השדות
                                                    const inputs = newQuestion.querySelectorAll('input');
                                                    if (inputs[0]) inputs[0].value = q.question || '';
                                                    if (inputs[1]) inputs[1].value = q.answer || '';
                                                    if (inputs[2]) inputs[2].value = q.after || '';
                                                    
                                                    console.log(`✅ שאלה ${qIndex + 1} נוספה`);
                                                } else {
                                                    console.warn(`⚠️ שאלה ${qIndex + 1} חסרה videoData`);
                                                }
                                            } catch (error) {
                                                console.error(`❌ שגיאה בהוספת שאלה ${qIndex + 1}:`, error);
                                            }
                                        });
                                        
                                        // עדכון dropzones
                                        updateDropzones(questionsList);
                                        console.log('✅ סיבוב נוצר בהצלחה');
                                    } else {
                                        console.warn('⚠️ אין שאלות בסיבוב או שהן לא במבנה תקין');
                                    }
                                } else {
                                    console.error('❌ לא נמצא questionsList בסיבוב');
                                }
                            } catch (error) {
                                console.error('❌ שגיאה ביצירת סיבוב:', error);
                            }
                            
                        } else if (section.type === 'free-text') {
                            // יצירת טקסט חופשי
                            console.log(`📝 יוצר טקסט חופשי: ${section.title || 'ללא כותרת'}`);
                            try {
                                const container = document.getElementById('scriptContainer');
                                const freeTextDiv = document.createElement('div');
                                freeTextDiv.className = 'free-text';
                                freeTextDiv.dataset.sectionType = 'free-text';
                                
                                freeTextDiv.innerHTML = `
                                    <div class="free-text-header" draggable="true" ondragstart="dragFreeText(event)" ondragover="dragOverFreeText(event)" ondragleave="dragLeaveFreeText(event)" ondrop="dropFreeText(event)">
                                        <h4>📝 טקסט חופשי - <input type="text" placeholder="הכנס כותרת" onclick="event.stopPropagation()" style="background: none; border: none; color: white; font-weight: bold;" value="${section.title || ''}"></h4>
                                        <button class="btn btn-danger btn-sm" onclick="removeFreeText(this, event)">🗑️</button>
                                    </div>
                                    <div class="free-text-content">
                                        <textarea placeholder="הכנס טקסט חופשי כאן...">${section.content || ''}</textarea>
                                    </div>
                                `;
                                
                                container.appendChild(freeTextDiv);
                                console.log('✅ טקסט חופשי נוצר');
                            } catch (error) {
                                console.error('❌ שגיאה ביצירת טקסט חופשי:', error);
                            }
                        } else {
                            console.warn(`⚠️ סוג section לא מוכר: ${section.type}`);
                        }
                        
                    } catch (error) {
                        console.error(`❌ שגיאה בעיבוד section ${index + 1}:`, error);
                        // ממשיך לsection הבא במקום לעצור
                    }
                });
                
                // שלב 5: עדכון דברי סיום
                if (closingData) {
                    console.log('📄 מעדכן דברי סיום...');
                    try {
                        const closingDiv = document.querySelector('[data-section-id="closing-words"]');
                        if (closingDiv) {
                            const textarea = closingDiv.querySelector('.editable-text');
                            if (textarea) {
                                textarea.value = closingData.content || '';
                                console.log('✅ דברי סיום עודכנו');
                            }
                        } else {
                            console.warn('⚠️ לא נמצא element לדברי סיום');
                        }
                    } catch (error) {
                        console.error('❌ שגיאה בעדכון דברי סיום:', error);
                    }
                }
                
                // שלב 6: הפעלת סעיפים קבועים
                console.log('🔄 מפעיל סעיפים קבועים...');
                try {
                    document.querySelectorAll('.script-section.fixed-section').forEach(section => {
                        if (section.dataset.sectionId !== 'closing-words') {
                            section.classList.add('active');
                        }
                    });
                    console.log('✅ סעיפים קבועים הופעלו');
                } catch (error) {
                    console.error('❌ שגיאה בהפעלת סעיפים קבועים:', error);
                }
                
                // שלב 7: עדכון רשימת הסרטונים בשימוש
                console.log('🎬 מעדכן רשימת סרטונים בשימוש...');
                try {
                    updateUsedVideos();
                    console.log('✅ רשימת סרטונים עודכנה');
                } catch (error) {
                    console.error('❌ שגיאה בעדכון רשימת סרטונים:', error);
                }
                
                console.log('🎉 טעינת הפרויקט הושלמה בהצלחה!');
                
            } catch (error) {
                console.error('❌ שגיאה כללית בטעינת הפרויקט:', error);
                console.error('❌ Stack trace:', error.stack);
                throw error;
            }
        }

        // פונקציות Drag & Drop משופרות עם אזורי Drop גדולים
        function allowDrop(ev) {
            ev.preventDefault();
            if (ev.currentTarget.classList.contains('question-dropzone')) {
                ev.currentTarget.classList.add('drag-over');
            }
        }
        
        function dragLeave(ev) {
            if (ev.currentTarget.classList.contains('question-dropzone')) {
                ev.currentTarget.classList.remove('drag-over');
            }
        }
        
        function drag(ev) {
            const videoData = {
                firebaseId: ev.target.dataset.firebaseId.toString(),
                number: ev.target.dataset.number,
                category: ev.target.dataset.category,
                title: ev.target.dataset.title,
                description: ev.target.dataset.description,
                question: ev.target.dataset.question,
                approvalStatus: ev.target.dataset.approvalStatus
            };
            ev.dataTransfer.setData("videoData", JSON.stringify(videoData));
            ev.dataTransfer.effectAllowed = 'copy';
            ev.target.classList.add('dragging');
            
            // הוספת מחלקה לגוף המסמך
            document.body.classList.add('dragging');
            
            // הוספת אירועי drop לכל הסיבובים
            document.querySelectorAll('.round').forEach(round => {
                round.addEventListener('dragover', handleRoundDragOver);
                round.addEventListener('dragleave', handleRoundDragLeave);
                round.addEventListener('drop', handleRoundDrop);
            });
        }
        
        // פונקציות טיפול באזור drop של סיבובים
        function handleRoundDragOver(ev) {
            ev.preventDefault();
            ev.stopPropagation();
            this.classList.add('drop-target');
        }
        
        function handleRoundDragLeave(ev) {
            if (!this.contains(ev.relatedTarget)) {
                this.classList.remove('drop-target');
            }
        }
        
function handleRoundDrop(ev) {
    ev.preventDefault();
    ev.stopPropagation();
    this.classList.remove('drop-target');
    
    // בדיקה אם ה-drop קרה על dropzone - אם כן, נעזוב כי זה כבר טופל
    if (ev.target.classList.contains('question-dropzone')) {
        cleanupDragStates();
        return;
    }
    
    const videoData = ev.dataTransfer.getData('videoData');
    if (videoData) {
        const data = JSON.parse(videoData);
        
        // בדיקה אם הסרטון כבר קיים
        if (isVideoAlreadyUsed(data.firebaseId.toString())) {
            showNotification('⚠️ סרטון זה כבר נמצא בתסריט!', 'warning');
            cleanupDragStates();
            return;
        }
        
        // הוספת הסרטון לסוף הסיבוב
        const questionsList = this.querySelector('.questions-list');
        const newQuestion = createQuestionElement(data);
        
        // הוספה לפני ה-dropzone האחרון
        const lastDropzone = questionsList.lastElementChild;
        if (lastDropzone && lastDropzone.classList.contains('question-dropzone')) {
            questionsList.insertBefore(newQuestion, lastDropzone);
        } else {
            questionsList.appendChild(newQuestion);
        }
        
        // עדכון dropzones
        updateDropzones(questionsList);
        
        // עדכון רשימת הסרטונים בשימוש
        updateUsedVideos();
        
        // עדכון מספור
        updateAllNumbering();
        
        // סימון שינויים
        markAsUnsaved();
        
        showNotification('✅ הסרטון נוסף לסיבוב!');
    }
    
    cleanupDragStates();
}
        
        function dragEnd(ev) {
            ev.target.classList.remove('dragging');
            
            // הסרת מחלקה מגוף המסמך
            document.body.classList.remove('dragging');
            
            // הסרת אירועי drop מהסיבובים
            document.querySelectorAll('.round').forEach(round => {
                round.removeEventListener('dragover', handleRoundDragOver);
                round.removeEventListener('dragleave', handleRoundDragLeave);
                round.removeEventListener('drop', handleRoundDrop);
                round.classList.remove('drop-target');
            });
            
            // הסתרת dropzones
            document.querySelectorAll('.question-dropzone').forEach(zone => {
                zone.classList.remove('drag-over');
            });
            
            // ניקוי כללי של כל המצבים
            cleanupDragStates();
        }
        
        // פונקציה לניקוי כל מצבי הגרירה
        function cleanupDragStates() {
            // הסרת כל מחלקות dragging
            document.querySelectorAll('.dragging').forEach(el => {
                el.classList.remove('dragging');
            });
            
            // הסרת drag-over מכל האלמנטים
            document.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
            
            // הסרת drag-preview
            document.querySelectorAll('.drag-preview').forEach(el => {
                el.classList.remove('drag-preview');
            });
            
            // הסרת drop-target מסיבובים
            document.querySelectorAll('.drop-target').forEach(el => {
                el.classList.remove('drop-target');
            });
            
            // וידוא שה-body נקי
            document.body.classList.remove('dragging');
            
            // ניקוי סופי אחרי 100ms למקרה שמשהו נתקע
            setTimeout(() => {
                document.body.classList.remove('dragging');
                document.querySelectorAll('.dragging, .drag-over, .drag-preview, .drop-target').forEach(el => {
                    el.classList.remove('dragging', 'drag-over', 'drag-preview', 'drop-target');
                });
            }, 100);
        }
        
        // גרירת שאלות קיימות
        function dragQuestion(ev) {
            ev.dataTransfer.effectAllowed = 'move';
            ev.dataTransfer.setData('questionMove', 'true');
            ev.target.classList.add('dragging');
            
            // הוספת מחלקה לגוף המסמך
            document.body.classList.add('dragging');
            
            // עדכון dropzones
            const questionsList = ev.target.parentElement;
            updateDropzones(questionsList);
        }
        
        function dropQuestion(ev) {
            ev.preventDefault();
            const dropzone = ev.currentTarget;
            dropzone.classList.remove('drag-over');
            
            const isQuestionMove = ev.dataTransfer.getData('questionMove');
            const videoData = ev.dataTransfer.getData('videoData');
            
            if (isQuestionMove) {
                // העברת שאלה קיימת
                const draggingItem = document.querySelector('.question-item.dragging');
                if (draggingItem && dropzone.classList.contains('question-dropzone')) {
                    dropzone.parentNode.insertBefore(draggingItem, dropzone);
                    draggingItem.classList.remove('dragging');
                }
            } else if (videoData) {
                // הוספת סרטון חדש
                const data = JSON.parse(videoData);
                
                // בדיקה אם הסרטון כבר קיים
                if (isVideoAlreadyUsed(data.firebaseId.toString())) {
                    showNotification('⚠️ סרטון זה כבר נמצא בתסריט!', 'warning');
                    cleanupDragStates(); // ניקוי מצבי גרירה
                    return;
                }
                
                const newQuestion = createQuestionElement(data);
                dropzone.parentNode.insertBefore(newQuestion, dropzone);
                
                // הוספה לרשימת הסרטונים בשימוש
                updateUsedVideos();
            }
            
            // עדכון dropzones
            const questionsList = dropzone.parentNode;
            updateDropzones(questionsList);
            
            // עדכון מספור
            updateAllNumbering();
            
            // סימון שינויים
            markAsUnsaved();
            
            // ניקוי כללי של מצבי גרירה
            cleanupDragStates();
        }
        
        // יצירת אלמנט שאלה עם אנימציה
        function createQuestionElement(data) {
            const questionItem = document.createElement('div');
            questionItem.className = 'question-item';
            questionItem.draggable = true;
            questionItem.ondragstart = dragQuestion;
            questionItem.ondragend = () => {
                questionItem.classList.remove('dragging');
                document.body.classList.remove('dragging');
                cleanupDragStates(); // ניקוי כללי
            };
            
            // הוספת אירועים לתצוגה מקדימה בזמן ריחוף
            questionItem.ondragover = (e) => {
                e.preventDefault();
                const draggingItem = document.querySelector('.question-item.dragging');
                if (draggingItem && draggingItem !== questionItem) {
                    questionItem.classList.add('drag-preview');
                }
            };
            
            questionItem.ondragleave = () => {
                questionItem.classList.remove('drag-preview');
            };
            
            questionItem.ondrop = (e) => {
                e.preventDefault();
                questionItem.classList.remove('drag-preview');
            };
            
            const approvalStatus = data.approvalStatus || 'pending';
            const approvalText = {
                'approved': 'מאושר',
                'not-approved': 'לא מאושר', 
                'pending': 'בטיפול'
            }[approvalStatus];
            
            const approvalClass = {
                'approved': 'style="background: #d4edda; color: #155724;"',
                'not-approved': 'style="background: #f8d7da; color: #721c24;"',
                'pending': 'style="background: #fff3cd; color: #856404;"'
            }[approvalStatus];
            
            questionItem.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <strong>${data.title}</strong>
                        <span class="question-number">${data.number || 'ללא מספר'}</span>
                        <span ${approvalClass} style="padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; margin-left: 5px;">${approvalText}</span>
                        <br>
                        <small>קטגוריה: ${data.category}</small>
                        ${data.description ? `<br><small>תיאור: ${data.description}</small>` : ''}
                        <div style="margin-top: 8px;">
                            <label style="font-weight: bold;">שאלה:</label>
                            <input type="text" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;" 
                                   value="${data.question || ''}" placeholder="הכנס שאלה...">
                        </div>
                        <div style="margin-top: 8px;">
                            <label style="font-weight: bold;">תשובה:</label>
                            <input type="text" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;" 
                                   placeholder="הכנס תיאור תשובה...">
                        </div>
                        <div style="margin-top: 8px;">
                            <label style="font-weight: bold;">אפטר פאנץ':</label>
                            <input type="text" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;" 
                                   placeholder="הכנס אפטר פאנץ'...">
                        </div>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="removeQuestion(this)">🗑️</button>
                </div>
            `;
            
            questionItem.dataset.videoData = JSON.stringify(data);
            
            return questionItem;
        }
        
        // עדכון dropzones
        function updateDropzones(questionsList) {
            // הסר את כל ה-dropzones הקיימים
            questionsList.querySelectorAll('.question-dropzone').forEach(zone => zone.remove());
            
            // הוסף dropzone לפני כל שאלה
            const questions = questionsList.querySelectorAll('.question-item');
            questions.forEach(question => {
                const dropzone = createDropzone();
                questionsList.insertBefore(dropzone, question);
            });
            
            // הוסף dropzone בסוף
            const finalDropzone = createDropzone();
            questionsList.appendChild(finalDropzone);
        }
        
        function createDropzone() {
            const dropzone = document.createElement('div');
            dropzone.className = 'question-dropzone';
            dropzone.innerHTML = 'גרור סרטון לכאן';
            dropzone.ondrop = dropQuestion;
            dropzone.ondragover = allowDrop;
            dropzone.ondragleave = dragLeave;
            return dropzone;
        }
        
        // גרירת סיבובים משופרת
        function dragRound(ev) {
            ev.dataTransfer.effectAllowed = 'move';
            ev.dataTransfer.setData('roundMove', 'true');
            ev.target.closest('.round').classList.add('dragging');
        }
        
        function dragOverRound(ev) {
            ev.preventDefault();
            const draggingElement = document.querySelector('.dragging');
            const currentElement = ev.target.closest('.round, .free-text');
            if (draggingElement && currentElement && currentElement !== draggingElement) {
                currentElement.classList.add('drag-over');
            }
        }
        
        function dragLeaveRound(ev) {
            const currentElement = ev.target.closest('.round, .free-text');
            if (currentElement) {
                currentElement.classList.remove('drag-over');
            }
        }
        
        function dropRound(ev) {
            ev.preventDefault();
            const currentElement = ev.target.closest('.round, .free-text');
            if (currentElement) {
                currentElement.classList.remove('drag-over');
            }
            
            const isRoundMove = ev.dataTransfer.getData('roundMove');
            const isFreeTextMove = ev.dataTransfer.getData('freeTextMove');
            
            if (isRoundMove || isFreeTextMove) {
                const draggingElement = document.querySelector('.dragging');
                if (draggingElement && currentElement && currentElement !== draggingElement) {
                    const container = document.getElementById('scriptContainer');
                    const allElements = [...container.children];
                    const dragIndex = allElements.indexOf(draggingElement);
                    const dropIndex = allElements.indexOf(currentElement);
                    
                    if (dragIndex < dropIndex) {
                        container.insertBefore(draggingElement, currentElement.nextSibling);
                    } else {
                        container.insertBefore(draggingElement, currentElement);
                    }
                }
                if (draggingElement) {
                    draggingElement.classList.remove('dragging');
                }
                
                // עדכון מספור
                updateAllNumbering();
                
                // סימון שינויים
                markAsUnsaved();
            }
        }
        
        // פונקציה לפתיחה/סגירה של סעיף מתקפל
        function toggleCollapsible(sectionId) {
            const section = document.getElementById(sectionId);
            section.classList.toggle('collapsed');
        }
        
        // יצירת סעיף בחירת מתמודדים
        function createContestantsSelection() {
            let html = '<div class="contestants-selection">';
            html += '<h4>בחר את המתמודדים שישתתפו בתוכנית:</h4>';
            
            contestants.forEach(contestant => {
                html += `
                    <div class="contestant-item" id="contestant-${contestant.id}">
                        <div class="contestant-checkbox">
                            <input type="checkbox" id="check-${contestant.id}" onchange="toggleContestant('${contestant.id}')">
                            <label for="check-${contestant.id}">${contestant.name}</label>
                        </div>
                        <div class="contestant-text">
                            <textarea placeholder="מה ${contestant.name} מספר/ת בפתיחה..." data-contestant="${contestant.id}"></textarea>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }
        
        // החלפת מצב מתמודד
        function toggleContestant(contestantId) {
            const item = document.getElementById(`contestant-${contestantId}`);
            const checkbox = document.getElementById(`check-${contestantId}`);
            
            if (checkbox.checked) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        }
        
        // יצירת מבנה התסריט
        function initializeScript() {
            const openingContent = document.getElementById('openingContent');
            openingContent.innerHTML = '';
            
            // איפוס ID התסריט הנוכחי
            currentScriptId = null;
            document.getElementById('quickSaveBtn').style.display = 'none';
            
            // יצירת כל הסעיפים הקבועים בחלק הפתיחה
            templateSections.forEach((section, index) => {
                if (section.id === 'closing-words') return; // דברי הסיום יטופלו בנפרד
                
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'script-section fixed-section';
                sectionDiv.dataset.sectionId = section.id;
                sectionDiv.dataset.sectionNumber = section.number;
                
                if (section.type === 'contestants') {
                    // סעיף מיוחד לבחירת מתמודדים
                    sectionDiv.innerHTML = `
                        <div class="section-header" onclick="toggleSection(this)">
                            <h4><span class="auto-number">${section.number}</span>. ${section.title}</h4>
                            <span>▼</span>
                        </div>
                        <div class="section-content">
                            ${createContestantsSelection()}
                        </div>
                    `;
                } else {
                    sectionDiv.innerHTML = `
                        <div class="section-header" onclick="toggleSection(this)">
                            <h4><span class="auto-number">${section.number}</span>. ${section.title}</h4>
                            <span>▼</span>
                        </div>
                        <div class="section-content">
                            <textarea class="editable-text" placeholder="הכנס טקסט...">${section.content}</textarea>
                        </div>
                    `;
                }
                
                openingContent.appendChild(sectionDiv);
            });
            
            // הוספת דברי סיום אחרי אזור הוספת הסיבוב
            const addRoundArea = document.querySelector('.add-round-area');
            const closingDiv = document.createElement('div');
            closingDiv.className = 'script-section fixed-section';
            closingDiv.dataset.sectionId = 'closing-words';
            closingDiv.innerHTML = `
                <div class="section-header" onclick="toggleSection(this)">
                    <h4>דברי סיום</h4>
                    <span>▼</span>
                </div>
                <div class="section-content">
                    <textarea class="editable-text" placeholder="הכנס דברי סיום...">${templateSections.find(s => s.id === 'closing-words').content}</textarea>
                </div>
            `;
            addRoundArea.parentNode.insertBefore(closingDiv, addRoundArea.nextSibling);
            
            // עדכון מונה הסעיפים
            sectionCounter = templateSections.length;
        }
        
        // החלפת מצב סעיף (פתוח/סגור)
        function toggleSection(header) {
            const section = header.parentElement;
            section.classList.toggle('active');
            const arrow = header.querySelector('span:last-child');
            arrow.textContent = section.classList.contains('active') ? '▲' : '▼';
        }
        
        // החלפת מצב סיבוב
        function toggleRound(header) {
            if (event.target === header || event.target.tagName === 'H4') {
                const round = header.parentElement;
                round.classList.toggle('active');
                
                // ניקוי מצבי גרירה כשפותחים/סוגרים סיבוב
                cleanupDragStates();
            }
        }
        
        // הוספת טקסט חופשי
        function addFreeText() {
            const container = document.getElementById('scriptContainer');
            
            const freeTextDiv = document.createElement('div');
            freeTextDiv.className = 'free-text';
            freeTextDiv.dataset.sectionType = 'free-text';
            freeTextDiv.dataset.sectionNumber = sectionCounter;
            
            freeTextDiv.innerHTML = `
                <div class="free-text-header" draggable="true" ondragstart="dragFreeText(event)" ondragover="dragOverFreeText(event)" ondragleave="dragLeaveFreeText(event)" ondrop="dropFreeText(event)">
                    <h4>📝 טקסט חופשי - <input type="text" placeholder="הכנס כותרת" onclick="event.stopPropagation()" style="background: none; border: none; color: white; font-weight: bold;"></h4>
                    <button class="btn btn-danger btn-sm" onclick="removeFreeText(this, event)">🗑️</button>
                </div>
                <div class="free-text-content">
                    <textarea placeholder="הכנס טקסט חופשי כאן..."></textarea>
                </div>
            `;
            
            container.appendChild(freeTextDiv);
            
            // עדכון מספור
            updateAllNumbering();
            
            // סימון שינויים
            markAsUnsaved();
            
            showNotification('✅ טקסט חופשי נוסף!');
        }
        
        // פונקציות גרירה לטקסט חופשי
        function dragFreeText(ev) {
            ev.dataTransfer.effectAllowed = 'move';
            ev.dataTransfer.setData('freeTextMove', 'true');
            ev.target.closest('.free-text').classList.add('dragging');
        }
        
        function dragOverFreeText(ev) {
            ev.preventDefault();
            const draggingElement = document.querySelector('.dragging');
            const currentElement = ev.target.closest('.free-text, .round');
            if (draggingElement && currentElement && currentElement !== draggingElement) {
                currentElement.classList.add('drag-over');
            }
        }
        
        function dragLeaveFreeText(ev) {
            const currentElement = ev.target.closest('.free-text, .round');
            if (currentElement) {
                currentElement.classList.remove('drag-over');
            }
        }
        
        function dropFreeText(ev) {
            ev.preventDefault();
            const currentElement = ev.target.closest('.free-text, .round');
            if (currentElement) {
                currentElement.classList.remove('drag-over');
            }
            
            const isFreeTextMove = ev.dataTransfer.getData('freeTextMove');
            const isRoundMove = ev.dataTransfer.getData('roundMove');
            
            if (isFreeTextMove || isRoundMove) {
                const draggingElement = document.querySelector('.dragging');
                if (draggingElement && currentElement && currentElement !== draggingElement) {
                    const container = document.getElementById('scriptContainer');
                    const allElements = [...container.children];
                    const dragIndex = allElements.indexOf(draggingElement);
                    const dropIndex = allElements.indexOf(currentElement);
                    
                    if (dragIndex < dropIndex) {
                        container.insertBefore(draggingElement, currentElement.nextSibling);
                    } else {
                        container.insertBefore(draggingElement, currentElement);
                    }
                }
                if (draggingElement) {
                    draggingElement.classList.remove('dragging');
                }
                
                // עדכון מספור
                updateAllNumbering();
                
                // סימון שינויים
                markAsUnsaved();
            }
        }
        
        function removeFreeText(btn, event) {
            event.stopPropagation();
            if (confirm('האם למחוק את הטקסט החופשי?')) {
                btn.closest('.free-text').remove();
                updateAllNumbering();
                markAsUnsaved();
                showNotification('✅ טקסט חופשי נמחק!');
            }
        }
        
        // הוספת סיבוב חדש
        function addNewRound() {
            roundCounter++;
            const container = document.getElementById('scriptContainer');
            
            const newRound = document.createElement('div');
            newRound.className = 'round';
            newRound.dataset.roundId = roundCounter;
            newRound.dataset.sectionNumber = sectionCounter;
            
            newRound.innerHTML = `
                <div class="round-header" onclick="toggleRound(this)" draggable="true" ondragstart="dragRound(event)" ondragover="dragOverRound(event)" ondragleave="dragLeaveRound(event)" ondrop="dropRound(event)">
                    <h4><span class="round-number">סיבוב ${roundCounter}</span> - <input type="text" placeholder="הכנס שם סיבוב" onclick="event.stopPropagation()" style="background: none; border: none; color: white; font-weight: bold;"></h4>
                    <button class="btn btn-danger btn-sm" onclick="removeRound(this, event)">🗑️</button>
                </div>
                <div class="round-content">
                    <textarea class="editable-text" style="margin-bottom: 10px;">בסיבוב הבא [הכנס תיאור הסיבוב]
יד על הבאזר. מתחילים.</textarea>
                    <div class="questions-list">
                        <div class="question-dropzone" ondrop="dropQuestion(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
                            גרור סרטון לכאן
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(newRound);
            
            // עדכון מספור
            updateAllNumbering();
            
            // ניקוי מצבי גרירה
            cleanupDragStates();
            
            // סימון שינויים
            markAsUnsaved();
            
            showNotification('✅ סיבוב חדש נוסף!');
        }
        
        function removeRound(btn, event) {
            event.stopPropagation();
            if (confirm('האם למחוק את הסיבוב?')) {
                btn.closest('.round').remove();
                updateRoundNumbers();
                updateAllNumbering();
                
                // עדכון רשימת הסרטונים בשימוש
                updateUsedVideos();
                
                // סימון שינויים
                markAsUnsaved();
                
                showNotification('✅ סיבוב נמחק!');
            }
        }
        
        function removeQuestion(btn) {
            if (confirm('האם למחוק את השאלה?')) {
                const questionItem = btn.closest('.question-item');
                const questionsList = questionItem.parentElement;
                questionItem.remove();
                
                updateDropzones(questionsList);
                updateAllNumbering();
                
                // עדכון רשימת הסרטונים בשימוש
                updateUsedVideos();
                
                // סימון שינויים
                markAsUnsaved();
            }
        }
        
        // בדיקה אם סרטון כבר בשימוש
        function isVideoAlreadyUsed(firebaseId) {
            const allQuestions = document.querySelectorAll('.question-item');
            for (let question of allQuestions) {
                if (question.dataset.videoData) {
                    const data = JSON.parse(question.dataset.videoData);
                    if (data.firebaseId === firebaseId.toString()) {
                        return true;
                    }
                }
            }
            return false;
        }
        
        // עדכון רשימת הסרטונים בשימוש
        function updateUsedVideos() {
            usedVideos.clear();
            const allQuestions = document.querySelectorAll('.question-item');
            allQuestions.forEach(question => {
                if (question.dataset.videoData) {
                    const data = JSON.parse(question.dataset.videoData);
                    usedVideos.add(data.firebaseId.toString());
                }
            });
            
            // עדכון התצוגה של הסרטונים במאגר
            updateVideoCardsStatus();
        }
        
        // עדכון סטטוס כרטיסי הסרטונים
        function updateVideoCardsStatus() {
            document.querySelectorAll('.video-card').forEach(card => {
                const firebaseId = card.dataset.firebaseId;
                if (usedVideos.has(firebaseId)) {
                    card.classList.add('used');
                } else {
                    card.classList.remove('used');
                }
            });
        }
        
        // עדכון מספור סיבובים
        function updateRoundNumbers() {
            const rounds = document.querySelectorAll('.round');
            rounds.forEach((round, index) => {
                const roundNumber = round.querySelector('.round-number');
                if (roundNumber) {
                    roundNumber.textContent = `סיבוב ${index + 1}`;
                }
            });
            roundCounter = rounds.length;
        }
        
        // עדכון מספור אוטומטי
        function updateAllNumbering() {
            let currentNumber = 1;
            
            // עבור על כל הסעיפים הקבועים
            document.querySelectorAll('#openingContent .script-section.fixed-section').forEach(section => {
                const numberSpan = section.querySelector('.auto-number');
                if (numberSpan) {
                    numberSpan.textContent = currentNumber;
                    section.dataset.sectionNumber = currentNumber;
                    currentNumber++;
                }
            });
            
            // עבור על כל הסיבובים והטקסטים החופשיים
            document.querySelectorAll('#scriptContainer > *').forEach(element => {
                element.dataset.sectionNumber = currentNumber;
                currentNumber++;
            });
            
            sectionCounter = currentNumber;
            
            // עדכון מספרי הסיבובים
            updateRoundNumbers();
        }
        
        // טעינת סרטונים מ-Firebase
        async function loadVideosFromFirebase() {
            try {
                showNotification('📥 טוען סרטונים מהמאגר...');
                
                const snapshot = await videosRef.once('value');
                const data = snapshot.val();
                
                if (data && data.data && Array.isArray(data.data)) {
                    videoDatabase = data.data.filter(video => video && !video.archived);
                    
                    console.log(`נטענו ${videoDatabase.length} סרטונים מ-Firebase`);
                    
                    // עדכון פילטרים
                    updateFilters();
                    
                    // הצגת הסרטונים
                    displayVideos();
                    
                    showNotification(`✅ נטענו ${videoDatabase.length} סרטונים!`);
                } else {
                    showNotification('⚠️ לא נמצאו סרטונים במאגר');
                }
            } catch (error) {
                console.error('שגיאה בטעינת סרטונים:', error);
                showNotification('❌ שגיאה בטעינת סרטונים', 'error');
            }
        }
        
        // רענון סרטונים
        async function refreshVideos() {
            await loadVideosFromFirebase();
        }
        
        // עדכון פילטרים
        function updateFilters() {
            // עדכון פילטר קטגוריות
            const categoryFilter = document.getElementById('categoryFilter');
            const categories = [...new Set(videoDatabase.map(v => v.category))].sort();
            
            categoryFilter.innerHTML = '<option value="">כל הקטגוריות</option>';
            categories.forEach(cat => {
                categoryFilter.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
        }
        
        // הצגת סרטונים
        function displayVideos() {
            const videoList = document.getElementById('videoList');
            const searchTerm = document.getElementById('searchVideos').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const programFilter = document.getElementById('programFilter').value;
            const approvalFilter = document.getElementById('approvalFilter').value;
            
            const filteredVideos = videoDatabase.filter((video, index) => {
                const matchesSearch = !searchTerm || 
                    video.title.toLowerCase().includes(searchTerm) ||
                    (video.description && video.description.toLowerCase().includes(searchTerm)) ||
                    (video.question && video.question.toLowerCase().includes(searchTerm));
                
                const matchesCategory = !categoryFilter || video.category === categoryFilter;
                
                const matchesProgram = !programFilter || 
                    (programFilter === 'unassigned' && (!video.program || video.program === 'unassigned')) ||
                    video.program === programFilter;
                
                const matchesApproval = !approvalFilter || video.approvalStatus === approvalFilter;
                
                return matchesSearch && matchesCategory && matchesProgram && matchesApproval;
            });
            
            videoList.innerHTML = '';
            
            if (filteredVideos.length === 0) {
                videoList.innerHTML = '<div class="loading">לא נמצאו סרטונים</div>';
                return;
            }
            
            filteredVideos.forEach((video, index) => {
                const realIndex = videoDatabase.indexOf(video);
                const card = document.createElement('div');
                const approvalStatus = video.approvalStatus || 'pending';
                const isUsed = usedVideos.has(realIndex.toString());
                card.className = `video-card ${approvalStatus === 'not-approved' ? 'not-approved' : approvalStatus === 'pending' ? 'pending' : ''} ${isUsed ? 'used' : ''}`;
                card.draggable = true;
                card.ondragstart = drag;
                card.ondragend = dragEnd;
                
                // שמירת נתונים על הכרטיס
                card.dataset.firebaseId = realIndex.toString();
                card.dataset.number = video.number || '';
                card.dataset.category = video.category || '';
                card.dataset.title = video.title || '';
                card.dataset.description = video.description || '';
                card.dataset.question = video.question || '';
                card.dataset.approvalStatus = approvalStatus;
                
                const approvalText = {
                    'approved': 'מאושר',
                    'not-approved': 'לא מאושר',
                    'pending': 'בטיפול'
                }[approvalStatus];
                
                card.innerHTML = `
                    <h5>${video.title}</h5>
                    <div>
                        <span class="category">${video.category}</span>
                        <span class="program">${video.program && video.program !== 'unassigned' ? `פרק ${video.program}` : 'לא שובץ'}</span>
                        <span class="approval-status ${approvalStatus}">${approvalText}</span>
                    </div>
                    ${video.description ? `<small style="color: #666; display: block; margin-top: 4px;">${video.description}</small>` : ''}
                `;
                
                videoList.appendChild(card);
            });
        }
        
        // סינון סרטונים
        function filterVideos() {
            displayVideos();
        }
        
        // יצירת תסריט
        function buildScript() {
            let script = `תכנית ${document.getElementById('programNumber').value || '[מספר]'} -- ${document.getElementById('programDate').value || '[תאריך]'}\n`;
            script += `דראפט ${document.getElementById('draftNumber').value || '[מספר]'} -- בעבודה -- למעקב דנה/הפקה\n\n`;
            
            // איסוף המתמודדים הנבחרים
            const selectedContestants = [];
            contestants.forEach(contestant => {
                const checkbox = document.getElementById(`check-${contestant.id}`);
                if (checkbox && checkbox.checked) {
                    selectedContestants.push(contestant.name);
                }
            });
            
            script += `**קאסט: ${selectedContestants.join(', ')}**\n\n`;
            script += `---\n\n`;
            
            let questionNumber = 1;
            
            // עבור על סעיפי הפתיחה
            document.querySelectorAll('#openingContent .script-section').forEach(section => {
                const title = section.querySelector('.section-header h4').textContent;
                const sectionId = section.dataset.sectionId;
                
                if (sectionId === 'contestants-selection') {
                    // טיפול מיוחד במתמודדים
                    script += `## ${title}\n\n`;
                    
                    contestants.forEach(contestant => {
                        const checkbox = document.getElementById(`check-${contestant.id}`);
                        if (checkbox && checkbox.checked) {
                            const textarea = document.querySelector(`[data-contestant="${contestant.id}"]`);
                            const text = textarea ? textarea.value : '';
                            
                            script += `שלום ל${contestant.name}!\n`;
                            script += `מה נשמע? [${text || 'הכנס כאן מה ' + contestant.name + ' מספר/ת'}] (כפיים)\n\n`;
                        }
                    });
                    
                    // הוספת CG לוגו אחרי המתמודדים
                    script += `## CG לוגו\n\n`;
                } else {
                    const content = section.querySelector('.editable-text')?.value || '';
                    
                    script += `## ${title}\n`;
                    if (content.trim()) {
                        script += `${content}\n\n`;
                    } else {
                        script += `\n`;
                    }
                }
            });
            
            // עבור על הסיבובים והטקסטים החופשיים
            const scriptElements = document.querySelectorAll('#scriptContainer > *');
            scriptElements.forEach((element, elementIndex) => {
                if (element.classList.contains('round')) {
                    const roundNameInput = element.querySelector('.round-header input');
                    const roundName = roundNameInput ? roundNameInput.value : '';
                    const roundIntro = element.querySelector('.editable-text').value;
                    const roundNum = parseInt(element.dataset.sectionNumber);
                    
                    // בתסריט יופיע "פתיחת סיבוב" ללא מספר
                    script += `## ${roundNum}. פתיחת סיבוב - ${roundName || '[הכנס שם סיבוב]'}\n`;
                    if (roundIntro.trim()) {
                        script += `${roundIntro}\n\n`;
                    }
                    
                    // שאלות בסיבוב
                    const questions = element.querySelectorAll('.question-item:not(.question-dropzone)');
                    questions.forEach((question, qIndex) => {
                        const videoData = question.dataset.videoData ? JSON.parse(question.dataset.videoData) : null;
                        if (!videoData) return;
                        
                        const titleElement = question.querySelector('strong');
                        const questionInput = question.querySelector('input[placeholder="הכנס שאלה..."]');
                        const answerInput = question.querySelector('input[placeholder="הכנס תיאור תשובה..."]');
                        const afterInput = question.querySelector('input[placeholder="הכנס אפטר פאנץ\'..."]');
                        
                        const title = titleElement ? titleElement.textContent : '[הכנס תיאור]';
                        const questionText = questionInput ? questionInput.value : '';
                        const answerText = answerInput ? answerInput.value : '';
                        const afterText = afterInput ? afterInput.value : '';
                        
                        const baseNumber = roundNum + 1 + (qIndex * 5);
                        
                        script += `### ${baseNumber}. VTR שאלה -- ${title}\n\n`;
                        
                        script += `### ${baseNumber + 1}. CG פריז\n`;
                        script += `**${questionText || '[הכנס את נוסח השאלה]'}**\n\n`;
                        script += `(עונים)\n\n`;
                        script += `והתשובה היא:\n\n`;
                        
                        script += `### ${baseNumber + 2}. VTR תשובה -- ${answerText || '**[הכנס תיאור התשובה]**'}\n\n`;
                        
                        script += `### ${baseNumber + 3}. CG פריז\n`;
                        script += `**${afterText || '[הכנס אפטר פאנץ\']'}**\n\n`;
                        
                        script += `### ${baseNumber + 4}. CG לוגו\n`;
                        script += `את/ה צדקת -- 10 נקודות!\n\n`;
                        
                        if (qIndex < questions.length - 1) {
                            script += `ממשיכים:\n\n`;
                        }
                    });
                    
                    // סוף סיבוב
                    const endNumber = roundNum + 1 + (questions.length * 5);
                    script += `### ${endNumber}. שוט סוף סיבוב\n`;
                    script += `נגמר הסיבוב! מה אני אגיד לכם, אתם לא בכיוון.\n`;
                    script += `אבל זה מצב הנקודות בסוף הסיבוב הזה --\n\n`;
                    script += `פריים של כולם מחייכים כדי שאוכל להעלות פלאח בפוסט\n\n`;
                    script += `---\n\n`;
                } else if (element.classList.contains('free-text')) {
                    const title = element.querySelector('.free-text-header input').value || 'טקסט חופשי';
                    const content = element.querySelector('textarea').value;
                    const sectionNum = parseInt(element.dataset.sectionNumber);
                    
                    script += `## ${sectionNum}. ${title}\n`;
                    if (content.trim()) {
                        script += `${content}\n\n`;
                    }
                    script += `---\n\n`;
                }
            });
            
            // סיכום נקודות
            script += `## סיכום נקודות סופי\n\n`;
            script += `סיכום נקודות: - לצלם שוטים פתוחים שעליהם שלום יוכל לומר מי זכה\n\n`;
            script += `לא להאמין, אבל זאת הייתה השאלה האחרונה! מה שאומר שזה הזמן לסכם את האירוע, בואו נראה את הטבלה על המסך:\n\n`;
            script += `(בהמשך - להקליט בנפרד את שלום אומר את הזוכה/מסיד בורסיות)\n\n`;
            
            // דברי סיום
            const closingSection = document.querySelector('[data-section-id="closing-words"]');
            const closingText = closingSection ? closingSection.querySelector('.editable-text').value : '';
            
            script += `## דברי סיום\n\n`;
            script += closingText || 'זהו להיום. לילה טוב.';
            
            return script;
        }
        
        // תצוגה מקדימה
        function previewScript() {
            const script = buildScript();
            document.getElementById('scriptPreview').textContent = script;
            document.getElementById('previewModal').style.display = 'flex';
        }
        
        // ייצוא תסריט
        function exportScript() {
            const script = buildScript();
            const blob = new Blob([script], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `תכנית_${document.getElementById('programNumber').value || 'X'}_דראפט_${document.getElementById('draftNumber').value || 'X'}.txt`;
            link.click();
            URL.revokeObjectURL(url);
            showNotification('✅ התסריט יוצא בהצלחה!');
        }
        
        // ייצוא לוורד
        function exportToWord() {
            const programNum = document.getElementById('programNumber').value || '[מספר]';
            const programDate = document.getElementById('programDate').value || '[תאריך]';
            const draftNum = document.getElementById('draftNumber').value || '[מספר]';
            
            let wordContent = `
            <!DOCTYPE html>
            <html xmlns:o="urn:schemas-microsoft-com:office:office" 
                  xmlns:w="urn:schemas-microsoft-com:office:word" 
                  xmlns="http://www.w3.org/TR/REC-html40">
            <head>
                <meta charset="UTF-8">
                <!--[if gte mso 9]>
                <xml>
                <w:WordDocument>
                <w:View>Print</w:View>
                <w:Zoom>100</w:Zoom>
                <w:DoNotOptimizeForBrowser/>
                </w:WordDocument>
                </xml>
                <![endif]-->
                <style>
                    @page {
                        margin: 2cm;
                        size: A4;
                    }
                    body {
                        font-family: 'Arial', sans-serif;
                        direction: rtl;
                        text-align: right;
                        line-height: 1.6;
                        color: #333;
                    }
                    h1 {
                        font-size: 20pt;
                        color: #2c3e50;
                        text-align: center;
                        margin-bottom: 10pt;
                        border-bottom: 3pt solid #667eea;
                        padding-bottom: 10pt;
                    }
                    h2 {
                        font-size: 16pt;
                        color: #34495e;
                        margin-top: 20pt;
                        margin-bottom: 10pt;
                        background: #e3f2fd;
                        padding: 8pt;
                        border-right: 4pt solid #667eea;
                    }
                    h3 {
                        font-size: 12pt;
                        color: #2c3e50;
                        margin-top: 15pt;
                        margin-bottom: 8pt;
                    }
                    p {
                        margin-bottom: 8pt;
                    }
                    .header-info {
                        text-align: center;
                        font-size: 12pt;
                        color: #666;
                        margin-bottom: 20pt;
                    }
                    .cast {
                        background: #f8f9fa;
                        padding: 10pt;
                        border-radius: 5pt;
                        margin-bottom: 20pt;
                        text-align: center;
                        font-weight: bold;
                    }
                    hr {
                        border: none;
                        border-top: 2pt solid #ecf0f1;
                        margin: 20pt 0;
                    }
                </style>
            </head>
            <body>`;
            
            // בניית התוכן
            const scriptText = buildScript();
            const lines = scriptText.split('\n');
            
            lines.forEach(line => {
                if (line.startsWith('## ')) {
                    wordContent += `<h2>${line.substring(3)}</h2>`;
                } else if (line.startsWith('### ')) {
                    wordContent += `<h3>${line.substring(4)}</h3>`;
                } else if (line.startsWith('**') && line.endsWith('**')) {
                    wordContent += `<p><strong>${line.substring(2, line.length - 2)}</strong></p>`;
                } else if (line === '---') {
                    wordContent += '<hr>';
                } else if (line.trim()) {
                    wordContent += `<p>${line}</p>`;
                }
            });
            
            wordContent += `
            </body>
            </html>`;
            
            // יצירת קובץ וורד
            const blob = new Blob([wordContent], {
                type: 'application/msword;charset=utf-8'
            });
            
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `תכנית_${programNum}_דראפט_${draftNum}.doc`;
            link.click();
            URL.revokeObjectURL(url);
            
            showNotification('✅ התסריט יוצא לוורד בהצלחה!');
        }
        
        // שמירת פרויקט
        function saveProject() {
            const project = buildProjectData();
            
            const blob = new Blob([JSON.stringify(project, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `פרויקט_תכנית_${project.programNumber || 'X'}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showNotification('✅ הפרויקט נשמר!');
        }
        
        // טעינת פרויקט
        function loadProject() {
            // בדיקה אם יש שינויים שלא נשמרו
            if (hasUnsavedChanges) {
                const confirmLoad = confirm('יש לך שינויים שלא נשמרו. האם להמשיך?');
                if (!confirmLoad) return;
            }
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const project = JSON.parse(e.target.result);
                        loadProjectData(project);
                        
                        // איפוס ID התסריט הנוכחי כי זה קובץ מקומי
                        currentScriptId = null;
                        document.getElementById('quickSaveBtn').style.display = 'none';
                        
                        // סימון שהכל נשמר
                        markAsSaved();
                        
                        showNotification('✅ הפרויקט נטען בהצלחה!');
                    } catch (error) {
                        showNotification('❌ שגיאה בטעינת הפרויקט', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // הצגת הודעות
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.background = type === 'error' ? '#dc3545' : type === 'warning' ? '#ff9800' : '#28a745';
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // פונקציה לפתיחת מנהל הסרטונים בחלון חדש
        function openVideoManager() {
            // פותח את מנהל הסרטונים בחלון חדש
            window.open('https://aviadaviad.github.io/video-manager/', '_blank');
        }
        
        // סגירת מודאל
        function closeModal() {
            document.getElementById('previewModal').style.display = 'none';
        }
        
        // האזנה לשינויים בזמן אמת
        function setupRealtimeListener() {
            videosRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && data.data && Array.isArray(data.data)) {
                    const newVideoData = data.data.filter(video => video && !video.archived);
                    
                    // בדיקה אם הנתונים השתנו
                    if (JSON.stringify(newVideoData) !== JSON.stringify(videoDatabase)) {
                        console.log('זוהה עדכון במאגר הסרטונים!');
                        
                        videoDatabase = newVideoData;
                        
                        // עדכון הממשק
                        updateFilters();
                        displayVideos();
                        
                        // עדכון סטטוס הסרטונים
                        updateVideoCardsStatus();
                        
                        showNotification('🔄 המאגר עודכן!');
                    }
                }
            });
        }
        
        // אתחול האפליקציה
        async function initApp() {
            // יצירת מבנה התסריט
            initializeScript();
            
            // טעינת סרטונים מ-Firebase
            await loadVideosFromFirebase();
            
            // עדכון רשימת הסרטונים בשימוש
            updateUsedVideos();
            
            // הפעלת מאזין לעדכונים
            setupRealtimeListener();
            
            // הפעלת כל הסעיפים הקבועים בברירת מחדל (חוץ מדברי סיום)
            document.querySelectorAll('.script-section.fixed-section').forEach(section => {
                if (section.dataset.sectionId !== 'closing-words') {
                    section.classList.add('active');
                }
            });
            
            // הוספת מאזינים גלובליים לניקוי מצבי גרירה
            document.addEventListener('dragend', cleanupDragStates);
            document.addEventListener('drop', cleanupDragStates);
            document.addEventListener('mouseup', cleanupDragStates);
            
            // הוספת קיצור מקלדת לשמירה מהירה (Ctrl+S)
            document.addEventListener('keydown', async function(e) {
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    await quickSaveToFirebase();
                }
            });
            
            // הוספת מאזינים לשינויים
            addChangeListeners();
            
            // אזהרה לפני יציאה אם יש שינויים שלא נשמרו
            window.addEventListener('beforeunload', function(e) {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = '';
                    return '';
                }
            });
        }
        
        // הפעלת האפליקציה
        initApp();
    </script>
</body>
</html>
